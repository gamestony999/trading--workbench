<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易工作台 v8.0</title>
    
    <!-- 核心庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- 核心樣式與 v8.0 主題系統 -->
    <style>
        :root {
            /* v8.0 Dark Mode (Default) */
            --bg-primary: #111827;      /* gray-900 */
            --bg-secondary: #1f2937;    /* gray-800 */
            --bg-tertiary: #374151;     /* gray-700 */
            --bg-quaternary: #4b5563;   /* gray-600 */
            --bg-hover: #4b5563;        /* gray-600 */
            --bg-active: #3b82f6;       /* blue-500 */
            
            --border-primary: #374151;  /* gray-700 */
            --border-secondary: #4b5563;/* gray-600 */
            
            --text-primary: #f9fafb;    /* gray-50 */
            --text-secondary: #9ca3af;  /* gray-400 */
            --text-tertiary: #6b7280;   /* gray-500 */
            --text-blue: #60a5fa;       /* blue-400 */
            --text-green: #4ade80;      /* green-400 */
            --text-red: #f87171;        /* red-400 */
            --text-yellow: #facc15;     /* yellow-400 */

            --input-bg: #374151;        /* gray-700 */
            --input-border: #4b5563;    /* gray-600 */
            --input-focus: #3b82f6;     /* blue-500 */

            --scrollbar-thumb: #4b5563;
            --scrollbar-track: #1f2937;
        }

        html.light {
            /* v8.0 Light Mode */
            --bg-primary: #ffffff;      /* white */
            --bg-secondary: #f3f4f6;    /* gray-100 */
            --bg-tertiary: #e5e7eb;     /* gray-200 */
            --bg-quaternary: #d1d5db;   /* gray-300 */
            --bg-hover: #e5e7eb;        /* gray-200 */
            --bg-active: #3b82f6;       /* blue-500 */
            
            --border-primary: #e5e7eb;  /* gray-200 */
            --border-secondary: #d1d5db;/* gray-300 */

            --text-primary: #111827;    /* gray-900 */
            --text-secondary: #4b5563;  /* gray-600 */
            --text-tertiary: #6b7280;   /* gray-500 */
            --text-blue: #2563eb;       /* blue-600 */
            --text-green: #16a34a;      /* green-600 */
            --text-red: #dc2626;        /* red-600 */
            --text-yellow: #d97706;     /* yellow-600 */

            --input-bg: #f3f4f6;        /* gray-100 */
            --input-border: #d1d5db;    /* gray-300 */
            --input-focus: #3b82f6;     /* blue-500 */

            --scrollbar-thumb: #d1d5db;
            --scrollbar-track: #f3f4f6;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* 基礎組件樣式 (使用變數) */
        .input-group { 
            display: flex; 
            align-items: center; 
            background-color: var(--input-bg); 
            border-radius: 0.5rem; 
            border: 1px solid var(--input-border); 
        }
        .input-group span { 
            padding-left: 0.75rem; 
            color: var(--text-secondary); 
        }
        .input-group input, .input-group select, .input-group textarea,
        .form-input, .form-select, .form-textarea {
            background-color: transparent; 
            border: none; 
            outline: none; 
            width: 100%; 
            padding: 0.75rem; 
            color: var(--text-primary);
            border-radius: 0.5rem;
        }
        .form-input, .form-select, .form-textarea {
             background-color: var(--input-bg);
             border: 1px solid var(--input-border);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus, .input-group:focus-within {
            border-color: var(--input-focus);
            box-shadow: 0 0 0 1px var(--input-focus);
        }
        
        .tab-btn { 
            transition: all 0.2s ease-in-out; 
            padding: 0.75rem 1rem; 
            border-bottom: 2px solid transparent; 
            white-space: nowrap; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
        }
        .tab-btn:hover { 
            color: var(--text-primary); 
            border-color: var(--border-secondary); 
        }
        .tab-btn.active { 
            background-color: var(--bg-active); 
            color: white; 
            font-weight: 600; 
            border-color: var(--bg-active); 
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }

        [x-cloak] { display: none !important; }
        
        .modal-backdrop { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background-color: rgba(0, 0, 0, 0.75); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 50; 
        }
        .modal-content { 
            background-color: var(--bg-secondary); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            max-width: 90vw; 
            max-height: 90vh; 
            overflow: auto; 
            border: 1px solid var(--border-primary);
        }
        
        .search-input { 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w.3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 12px center; 
            padding-left: 40px; 
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
        }
        
        /* v8.0 Calendar Styles (使用變數) */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { 
            min-height: 120px; 
            background-color: var(--bg-primary);
            transition: background-color 0.2s ease;
        }
        .calendar-day:hover {
            background-color: var(--bg-secondary);
        }
        .calendar-day.other-month { 
            background-color: var(--bg-secondary);
            opacity: 0.6;
        }
        .day-pl.profit { 
            background-color: rgba(16, 185, 129, 0.1); 
            border-left: 3px solid #10B981; 
            color: var(--text-green);
        }
        .day-pl.loss { 
            background-color: rgba(239, 68, 68, 0.1); 
            border-left: 3px solid #EF4444; 
            color: var(--text-red);
        }
        .calendar-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
        }
        .calendar-cell {
            border-r: 1px solid var(--border-primary);
            border-b: 1px solid var(--border-primary);
        }
        .calendar-grid {
             border-t: 1px solid var(--border-primary);
             border-l: 1px solid var(--border-primary);
        }
        
        /* v8.0 Card Style */
        .card {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-primary);
        }
        
        /* v8.0 Metric Card Style */
        .metric-card {
            background-color: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-primary);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        
        /* v8.0 Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-quaternary);
        }

        /* v8.0 Chart.js Tooltip */
        .chartjs-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8" x-data="tradingApp()" x-init="init()">

    <!-- v8.0 全局 Toast 通知 -->
    <div x-show="toast.visible" x-cloak
         x-transition:enter="transform ease-out duration-300 transition"
         x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
         x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-5 right-5 z-[100] w-full max-w-xs p-4 rounded-lg shadow-lg"
         :class="{
             'bg-green-100 border-green-300 text-green-800': toast.type === 'success',
             'bg-red-100 border-red-300 text-red-800': toast.type === 'error',
             'bg-blue-100 border-blue-300 text-blue-800': toast.type === 'info'
         }"
         role="alert">
        <div class="flex items-center">
            <!-- Icon -->
            <svg x-show="toast.type === 'success'" class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <svg x-show="toast.type === 'error'" class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
            <svg x-show="toast.type === 'info'" class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <!-- Message -->
            <span class="text-sm font-medium" x-text="toast.message"></span>
        </div>
    </div>

    <!-- v8.0 啟動畫面 -->
    <div x-show="!isInitialized" class="min-h-screen flex items-center justify-center text-center">
        <div>
            <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-gray-400" x-text="startupMessage">正在連接雲端...</p>
        </div>
    </div>

    <!-- v8.0 登入畫面 -->
    <div x-show="isInitialized && !isLoggedIn" x-cloak class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full card p-8">
            <h2 class="text-2xl font-bold text-center text-blue-500 mb-6" x-text="authView === 'login' ? '登入工作台 v8.0' : '註冊新帳號'"></h2>
            <form @submit.prevent="authView === 'login' ? login() : register()">
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-500">電子郵件</label>
                        <input id="email" type="email" x-model="authForm.email" required class="w-full form-input mt-1">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-500">密碼</label>
                        <input id="password" type="password" x-model="authForm.password" required class="w-full form-input mt-1">
                    </div>
                </div>
                <p x-show="authError" class="text-red-500 text-sm mt-4" x-text="authError"></p>
                <div class="mt-6">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 px-4 rounded-lg transition-colors" x-text="authView === 'login' ? '登入' : '註冊'"></button>
                </div>
            </form>
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500" style="background-color: var(--bg-secondary);">或</span>
                </div>
            </div>
            <div>
                <button @click.prevent="loginWithGoogle()" class="w-full inline-flex justify-center py-2.5 px-4 border rounded-md shadow-sm text-sm font-medium transition-colors bg-[var(--bg-tertiary)] border-[var(--border-primary)] text-[var(--text-primary)] hover:bg-[var(--bg-quaternary)]">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg>
                    <span>使用 Google 登入</span>
                </button>
            </div>
            <div class="mt-4 text-center">
                <button @click="authView = (authView === 'login' ? 'register' : 'login')" class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-white" x-text="authView === 'login' ? '還沒有帳號？註冊一個' : '已經有帳號？前往登入'"></button>
            </div>
        </div>
    </div>

    <!-- v8.0 主應用程式界面 -->
    <div x-show="isInitialized && isLoggedIn" x-cloak class="max-w-full mx-auto">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                 <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-blue-500">交易工作台 v8.0 ✨</h1>
                    <p class_="text-[var(--text-secondary)] mt-2">由 AI 驅動的整合式交易分析系統</p>
                 </div>
                 
                 <!-- v8.0 搜尋與主題切換 -->
                 <div class="flex items-center gap-3 w-full md:w-auto">
                    <!-- 搜尋框 -->
                    <div class="relative w-full md:w-72">
                        <input type="text" x-model="searchTerm" @input.debounce.300ms="search" placeholder="搜尋日誌或 Playbook..." class="search-input w-full rounded-full py-2 px-4 focus:ring-blue-500 focus:border-blue-500">
                        <div x-show="searchTerm && searchResults.length > 0" x-cloak
                             class="absolute z-30 w-full mt-1 card p-0 overflow-hidden shadow-lg max-h-80 overflow-y-auto">
                            <ul>
                                <template x-for="item in searchResults" :key="item.id">
                                    <li @click="goToSearchResult(item)" class="px-4 py-3 hover:bg-[var(--bg-hover)] cursor-pointer">
                                        <p class="font-semibold" x-text="item.ticker || item.name"></p>
                                        <p class="text-sm text-[var(--text-secondary)]" x-text="`${item.type} - ${item.date || item.pattern}`"></p>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- v8.0 主題切換按鈕 -->
                    <button @click="toggleTheme()" 
                            class="flex-shrink-0 p-2 rounded-full text-[var(--text-secondary)] hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-primary)] transition-colors">
                        <svg x-show="!isDarkMode()" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <svg x-show="isDarkMode()" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                 </div>
            </div>
            
            <!-- v8.0 TradingView Ticker Tape (動態載入) -->
            <div id="ticker-tape-container" class="tradingview-widget-container mt-6 h-[42px]">
                <!-- Ticker tape widget will be loaded here by JS -->
            </div>
        </header>

        <!-- v8.0 導航標籤 -->
        <div class="mb-6">
            <div class="border-b border-[var(--border-primary)]">
                 <nav class="-mb-px flex space-x-0 sm:space-x-2 overflow-x-auto" aria-label="Tabs">
                    <button @click="setActiveTab('dashboard')" :class="{ 'active': activeTab === 'dashboard' }" class="tab-btn">儀表板</button>
                    <button @click="setActiveTab('playbook')" :class="{ 'active': activeTab === 'playbook' }" class="tab-btn">Playbook</button>
                    <button @click="setActiveTab('journal')" :class="{ 'active': activeTab === 'journal' }" class="tab-btn">交易日誌</button>
                    <button @click="setActiveTab('performance')" :class="{ 'active': activeTab === 'performance' }" class="tab-btn">績效回顧</button>
                    <button @click="setActiveTab('modelBook')" :class="{ 'active': activeTab === 'modelBook' }" class="tab-btn">Model Book</button>
                    <button @click="setActiveTab('tradingView')" :class="{ 'active': activeTab === 'tradingView' }" class="tab-btn">市場圖表</button>
                    <button @click="setActiveTab('reflection')" :class="{ 'active': activeTab === 'reflection' }" class="tab-btn">自我反思</button>
                    <button @click="setActiveTab('marketJournal')" :class="{ 'active': activeTab === 'marketJournal' }" class="tab-btn">市場日誌</button>
                    <button @click="setActiveTab('buyPlan')" :class="{ 'active': activeTab === 'buyPlan' }" class="tab-btn">買入計劃</button>
                    <button @click="setActiveTab('calculator')" :class="{ 'active': activeTab === 'calculator' }" class="tab-btn">注碼計算機</button>
                    <button @click="setActiveTab('settings')" :class="{ 'active': activeTab === 'settings' }" class="tab-btn">設定</button>
                </nav>
            </div>
        </div>
        
        <!-- v8.0 用戶信息 -->
        <div class="flex justify-between items-center text-center mb-4 text-xs text-[var(--text-tertiary)]">
            <div class="flex items-center gap-2">
                <p>User ID: <span x-text="userId || 'N/A'" class="select-all"></span></p>
                <p class="hidden sm:block">| App ID: <span x-text="appId" class="select-all"></span></p>
            </div>
            <button @click="logout()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-lg text-xs transition-colors">登出</button>
        </div>
        
        <!-- 內容區域將在 Part 2 開始 -->
<!-- v8.0 儀表板 (Dashboard) -->
        <div x-show="activeTab === 'dashboard'" x-cloak>
            <div class="space-y-8">
                
                <!-- 2.1 核心績效指標 -->
                <div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <!-- 本金輸入框 (BUG 修復) -->
                        <div class="metric-card col-span-2 md:col-span-1 lg:col-span-2">
                            <h3 class="text-sm font-medium text-[var(--text-secondary)] mb-2">股票戶口本金 (USD)</h3>
                            <div class="input-group">
                                <span class="text-lg font-bold text-[var(--text-blue)]">$</span>
                                <!-- v8.0 BUG 修復：從 @input 改為 @blur -->
                                <input type="number" x-model.number="settings.usdPrincipal" @blur="saveSettings(true)" class="text-2xl text-center font-bold text-[var(--text-blue)] p-2">
                            </div>
                        </div>
                        <!-- 總盈虧 -->
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-[var(--text-secondary)]">總盈虧</h3>
                            <p class="mt-2 text-2xl font-bold" :class="metrics.totalPl >= 0 ? 'text-[var(--text-green)]' : 'text-[var(--text-red)]'" x-text="formatCurrency(metrics.totalPl, 'USD')"></p>
                        </div>
                        <!-- 勝率 -->
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-[var(--text-secondary)]">勝率</h3>
                            <p class="mt-2 text-2xl font-bold" x-text="`${metrics.winRate.toFixed(1)}%`"></p>
                        </div>
                        <!-- 利潤因子 -->
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-[var(--text-secondary)]">利潤因子</h3>
                            <p class="mt-2 text-2xl font-bold" :class="metrics.profitFactor >= 1 ? 'text-[var(--text-green)]' : 'text-[var(--text-red)]'" x-text="metrics.profitFactor.toFixed(2)"></p>
                        </div>
                        <!-- 平均盈虧比 -->
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-[var(--text-secondary)]">平均盈虧比</h3>
                            <p class="mt-2 text-2xl font-bold" :class="metrics.avgWinLossRatio >= 1 ? 'text-[var(--text-green)]' : 'text-[var(--text-red)]'" x-text="`${metrics.avgWinLossRatio.toFixed(2)} : 1`"></p>
                        </div>
                    </div>
                </div>

                <!-- 2.1 & 2.2 資金曲線 與 六角形評分圖 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- 左側：資金曲線圖 -->
                    <div class="card lg:col-span-2 h-[450px]">
                        <h2 class="text-xl font-semibold mb-4 text-[var(--text-blue)]">資金曲線圖</h2>
                        <div class="h-[350px]">
                            <canvas id="dashboardPlChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 右側：交易者六角形評分圖 -->
                    <div class="card h-[450px] flex flex-col">
                        <h2 class="text-xl font-semibold mb-4 text-[var(--text-blue)]">交易者六角形評分</h2>
                        <!-- 雷達圖 -->
                        <div class="relative h-[250px] w-full mx-auto mb-4">
                            <canvas id="hexagonScoreChart"></canvas>
                        </div>
                        <!-- 綜合分數 -->
                        <div class="text-center mt-auto">
                            <p class="text-sm text-[var(--text-secondary)]">綜合分數</p>
                            <p class="text-4xl font-bold text-[var(--text-primary)]" x-text="metrics.totalScore.toFixed(0)"></p>
                            <div class="w-full bg-[var(--bg-tertiary)] rounded-full h-2.5 mt-2">
                                <div class="bg-blue-600 h-2.5 rounded-full" :style="`width: ${metrics.totalScore}%`"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.3 交易日曆 (功能升級) -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-[var(--text-blue)]">交易日曆</h2>
                    <div class="card p-0">
                        <!-- 日曆導航 (v8.0 升級) -->
                        <div class="flex flex-wrap justify-between items-center p-4 calendar-header gap-2">
                            <div class="flex items-center gap-2">
                                <button @click="changeMonth(-1)" class="p-2 rounded-full hover:bg-[var(--bg-hover)] transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <button @click="changeMonth(1)" class="p-2 rounded-full hover:bg-[var(--bg-hover)] transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- 年份下拉 -->
                                <select x-model.number="calendar.year" @change="generateCalendar()" class="form-select !p-2 !pr-8 text-lg font-semibold">
                                    <template x-for="y in calendar.yearOptions" :key="y">
                                        <option :value="y" x-text="y"></option>
                                    </template>
                                </select>
                                <!-- 月份下拉 -->
                                <select x-model.number="calendar.month" @change="generateCalendar()" class="form-select !p-2 !pr-8 text-lg font-semibold">
                                    <template x-for="m in 12" :key="m - 1">
                                        <option :value="m - 1" x-text="`${m} 月`"></option>
                                    </template>
                                </select>
                            </div>
                            <button @click="goToToday()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                                回到本月
                            </button>
                        </div>
                        
                        <!-- 日曆網格 -->
                        <div class="calendar-grid">
                            <!-- 星期標題 -->
                            <template x-for="day in ['日', '一', '二', '三', '四', '五', '六']">
                                <div class="text-center font-semibold text-xs text-[var(--text-secondary)] py-3 calendar-cell" x-text="day"></div>
                            </template>
                            <!-- 日期格子 -->
                            <template x-for="day in calendar.days" :key="day.date">
                                <div class="calendar-day p-2 calendar-cell relative" :class="{'other-month': !day.isCurrentMonth}">
                                    <span class="text-sm" :class="{'text-[var(--text-tertiary)]': !day.isCurrentMonth, 'font-bold text-blue-500': day.isToday}" x-text="day.dayOfMonth"></span>
                                    <div x-show="day.pl !== 0" class="day-pl mt-2 p-2 rounded-md text-xs space-y-1 cursor-pointer">
                                        <p class="font-bold" :class="day.pl > 0 ? 'text-[var(--text-green)]' : 'text-[var(--text-red)]'" x-text="`P/L: ${formatCurrency(day.pl)}`"></p>
                                        <p class="text-[var(--text-secondary)]" x-text="`Trades: ${day.tradeCount}`"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- 2.4 市場羅盤 (保留) -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-[var(--text-blue)]">市場羅盤</h2>
                    <div class="card">
                        <!-- ... (這部分 HTML 結構保留 v4 的，只需確保 CSS 變數能正確應用) ... -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- 美股 -->
                            <div>
                                <h3 class="font-semibold mb-3 text-lg">美股 (S&P 500)</h3>
                                <div class="flex justify-around bg-[var(--bg-tertiary)] rounded-lg p-2">
                                    <button @click="setMarketCompass('US', 'Bull')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="marketCompass.US === 'Bull' ? 'bg-green-600 text-white' : 'hover:bg-[var(--bg-quaternary)]'">牛市</button>
                                    <button @click="setMarketCompass('US', 'Neutral')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="marketCompass.US === 'Neutral' ? 'bg-yellow-600 text-white' : 'hover:bg-[var(--bg-quaternary)]'">震盪</button>
                                    <button @click="setMarketCompass('US', 'Bear')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="marketCompass.US === 'Bear' ? 'bg-red-600 text-white' : 'hover:bg-[var(--bg-quaternary)]'">熊市</button>
                                </div>
                            </div>
                            <!-- 港股 -->
                            <div>
                                <h3 class="font-semibold mb-3 text-lg">港股 (Hang Seng)</h3>
                                <div class="flex justify-around bg-[var(--bg-tertiary)] rounded-lg p-2">
                                    <button @click="setMarketCompass('HK', 'Bull')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="marketCompass.HK === 'Bull' ? 'bg-green-600 text-white' : 'hover:bg-[var(--bg-quaternary)]'">牛市</button>
                                    <button @click="setMarketCompass('HK', 'Neutral')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="marketCompass.HK === 'Neutral' ? 'bg-yellow-600 text-white' : 'hover:bg-[var(--bg-quaternary)]'">震盪</button>
                                    <button @click="setMarketCompass('HK', 'Bear')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="marketCompass.HK === 'Bear' ? 'bg-red-600 text-white' : 'hover:bg-[var(--bg-quaternary)]'">熊市</button>
                                </div>
                            </div>
                        </div>
                        <!-- 市場判斷日誌 -->
                        <div class="mt-6">
                            <h3 class="font-semibold mb-3 text-md">市場判斷日誌</h3>
                            <form @submit.prevent="saveMarketCompassLog" class="flex gap-4">
                                <input type="text" x-model="marketCompassLogForm.notes" placeholder="新增判斷理由 (例如：S&P 500 站上 50MA)..." class="form-input w-full">
                                <button type="submit" :disabled="!marketCompassLogForm.notes" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 transition-colors">儲存</button>
                            </form>
                            <div class="mt-4 space-y-3 max-h-60 overflow-y-auto pr-2">
                                <template x-for="log in marketCompassLog" :key="log.id">
                                    <div class="text-sm p-3 rounded-lg bg-[var(--bg-tertiary)] flex justify-between items-start">
                                        <div>
                                            <p class="text-[var(--text-primary)]" x-text="log.notes"></p>
                                            <p class="text-xs text-[var(--text-secondary)] mt-1" x-text="new Date(log.timestamp?.toDate()).toLocaleString()"></p>
                                        </div>
                                        <button @click="deleteMarketCompassLog(log.id)" class="text-red-500 hover:text-red-400 text-xs ml-2 flex-shrink-0">刪除</button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI 數據總結 (保留) -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-[var(--text-blue)]">AI 數據總結與對話</h2>
                    <div class="card">
                        <button @click="getAiDashboardSummary()" :disabled="isLoading" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 transition-colors">
                            <span x-show="!isLoading">產生總結</span>
                            <span x-show="isLoading">AI 總結中...</span>
                        </button>
                        <div x-show="isLoading && aiQuery === ''" class="text-center py-4"><p class="text-sm text-[var(--text-secondary)]">AI 總結中...</p></div>
                        <div x-show="aiDashboardSummary" x-html="aiDashboardSummary" class="mt-4 p-4 bg-[var(--bg-tertiary)] rounded-lg prose prose-sm max-w-none text-[var(--text-primary)] prose-strong:text-[var(--text-primary)] prose-blockquote:text-[var(--text-secondary)]"></div>
                        
                        <div class="mt-6">
                            <form @submit.prevent="askAi" class="flex gap-4">
                                <input type="text" x-model="aiQuery" placeholder="向 AI 提問關於你的交易數據..." class="w-full form-input">
                                <button type="submit" :disabled="isLoading || !aiQuery" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-5 rounded-lg disabled:opacity-50 transition-colors">發送</button>
                            </form>
                        </div>
                    </div>
                 </div>
            </div>
        </div>

        <!-- v8.0 Playbook (新頁面) -->
        <div x-show="activeTab === 'playbook'" x-cloak>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左側：Playbook 表單 -->
                <div class="lg:col-span-1 card h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2" x-text="editingPlaybookId ? '編輯策略' : '新增 Playbook 策略'"></h2>
                    <form @submit.prevent="savePlaybook" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">策略名稱 (Strategy Name)</label>
                            <input type="text" x-model="playbookForm.name" required class="w-full form-input mt-1" placeholder="例如：VCP 突破">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)]">圖表週期 (Timeframe)</label>
                                <input type="text" x-model="playbookForm.timeframe" class="w-full form-input mt-1" placeholder="日線, 65m">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)]">市場環境 (Market)</label>
                                <input type="text" x-model="playbookForm.marketCondition" class="w-full form-input mt-1" placeholder="牛市, 震盪">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">進場標準 (Entry Criteria)</label>
                            <textarea x-model="playbookForm.entryCriteria" rows="4" class="w-full form-textarea mt-1" placeholder="1. ...&#10;2. ..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">停損策略 (Stop-Loss)</label>
                            <textarea x-model="playbookForm.stopLossStrategy" rows="2" class="w-full form-textarea mt-1" placeholder="例如：跌破關鍵支撐"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">停利策略 (Profit-Taking)</label>
                            <textarea x-model="playbookForm.profitTakingStrategy" rows="2" class="w-full form-textarea mt-1" placeholder="例如：R 倍數, 延伸力竭"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">筆記/心得 (Notes)</label>
                            <textarea x-model="playbookForm.notes" rows="3" class="w-full form-textarea mt-1"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">範例圖表</label>
                            <input type="file" @change="handlePlaybookImageUpload($event)" accept="image/*" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer mt-1">
                            <div x-show="isUploadingImage" class="mt-2 flex items-center gap-2 text-sm text-blue-500">
                                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span>上傳中...</span>
                            </div>
                            <template x-if="playbookForm.chartImage">
                                <div class="relative mt-2">
                                    <img :src="playbookForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto">
                                    <button type="button" @click="playbookForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button>
                                </div>
                            </template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" :disabled="isUploadingImage" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50" x-text="editingPlaybookId ? '更新策略' : '儲存策略'"></button>
                             <button type="button" @click="resetPlaybookForm" x-show="editingPlaybookId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                        </div>
                    </form>
                </div>
                
                <!-- 右側：Playbook 列表 -->
                <div class="lg:col-span-2 card">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">我的 Playbook</h2>
                    <div class="space-y-4 max-h-[80vh] overflow-y-auto pr-2">
                        <template x-for="playbook in playbooks" :key="playbook.id">
                            <div class="p-4 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border-secondary)]">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-lg text-blue-400" x-text="playbook.name"></h3>
                                    <div>
                                        <button @click="editPlaybook(playbook)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                        <button @click="deletePlaybook(playbook.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-yellow-900 text-yellow-300" x-text="playbook.timeframe || 'N/A'"></span>
                                    <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-green-900 text-green-300" x-text="playbook.marketCondition || 'N/A'"></span>
                                </div>
                                <p class="text-sm mt-3"><strong class="text-[var(--text-secondary)]">進場標準:</strong> <span class="whitespace-pre-wrap" x-text="playbook.entryCriteria"></span></p>
                                <img x-show="playbook.chartImage" :src="playbook.chartImage" @click="openChartModal(playbook.chartImage)" class="mt-2 rounded-md max-h-64 w-auto cursor-pointer" alt="Playbook Chart">
                            </div>
                        </template>
                        <div x-show="playbooks.length === 0" class="text-center py-16 text-[var(--text-tertiary)]">
                            <p>尚未建立任何 Playbook 策略。</p>
                            <p class="text-sm mt-1">請在左側表單新增您的第一個交易策略。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- v8.0 市場圖表 (TradingView) -->
        <div x-show="activeTab === 'tradingView'" x-cloak class="space-y-8">
            <!-- 主要圖表 -->
            <div id="tv-advanced-chart-container" class="h-[70vh] card p-2">
                <!-- Advanced Chart Widget will be loaded here by JS -->
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 市場熱圖 -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-[var(--text-blue)]">市場熱圖 (Market Heatmap)</h2>
                    <div id="tv-heatmap-container" class="h-[700px]">
                        <!-- Heatmap Widget will be loaded here by JS -->
                    </div>
                </div>
                <!-- 頭條新聞 -->
                <div>
                     <h2 class="text-2xl font-semibold mb-4 text-[var(--text-blue)]">頭條新聞 (Top Stories)</h2>
                    <div id="tv-timeline-container" class="h-[700px]">
                        <!-- Timeline Widget will be loaded here by JS -->
                    </div>
                </div>
            </div>
        </div>

<!-- ... (Part 2 結束) ... -->

        <!-- v8.0 自我反思 (Reflection) -->
        <div x-show="activeTab === 'reflection'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2" x-text="editingReflectionId ? '編輯反思' : '新增自我反思'"></h2>
                    <form @submit.prevent="saveReflection" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">日期</label>
                            <input type="date" x-model="reflectionForm.date" required class="w-full form-input mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">需要改善的問題</label>
                            <input type="text" x-model="reflectionForm.problem" required class="w-full form-input mt-1" placeholder="例如: 過早止盈、FOMO追高...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">詳細發現與思考</label>
                            <textarea x-model="reflectionForm.thoughts" rows="5" class="w-full form-textarea mt-1" placeholder="記錄下當時的想法、情緒和事後分析..."></textarea>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors" x-text="editingReflectionId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetReflectionForm" x-show="editingReflectionId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 card">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">歷史反思列表</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <template x-for="entry in reflections" :key="entry.id">
                            <div class="bg-[var(--bg-tertiary)] p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-lg text-yellow-400" x-text="entry.problem"></p>
                                    <div>
                                        <button @click="editReflection(entry)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                        <button @click="deleteReflection(entry.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                    </div>
                                </div>
                                <p class="text-xs text-[var(--text-secondary)] mt-1" x-text="entry.date"></p>
                                <p class="text-sm mt-2 whitespace-pre-wrap" x-text="entry.thoughts"></p>
                            </div>
                        </template>
                        <div x-show="reflections.length === 0" class="text-center py-16 text-[var(--text-tertiary)]">暫無反思記錄</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- v8.0 市場日誌 (Market Journal) -->
        <div x-show="activeTab === 'marketJournal'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2" x-text="editingMarketJournalId ? '編輯日誌' : '新增市場日誌'"></h2>
                    <form @submit.prevent="saveMarketJournal" class="space-y-4">
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">日期</label><input type="date" x-model="marketJournalForm.date" required class="w-full form-input mt-1"></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">大盤走勢摘要</label><textarea x-model="marketJournalForm.marketSummary" rows="3" class="w-full form-textarea mt-1" placeholder="例如: S&P 500 盤整，NASDAQ 強勢..."></textarea></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">領漲板塊</label><input type="text" x-model="marketJournalForm.leadingSectors" placeholder="半導體, 軟件..." class="w-full form-input mt-1"></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">觀察股清單</label><textarea x-model="marketJournalForm.watchlist" rows="2" class="w-full form-textarea mt-1" placeholder="NVDA, PLTR..."></textarea></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">心理狀態 / Mindset</label><textarea x-model="marketJournalForm.mindset" rows="2" class="w-full form-textarea mt-1" placeholder="冷靜, 焦慮, 有信心..."></textarea></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">市場氛圍指數 (1-5)</label><input type="range" min="1" max="5" x-model.number="marketJournalForm.sentiment" class="w-full h-2 bg-[var(--bg-tertiary)] rounded-lg appearance-none cursor-pointer mt-1"><div class="text-center text-sm" x-text="marketJournalForm.sentiment"></div></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">總結 (進攻/防守)</label><textarea x-model="marketJournalForm.summary" rows="3" class="w-full form-textarea mt-1" placeholder="目前適合積極進攻/保持防守, 因為..."></textarea></div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors" x-text="editingMarketJournalId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetMarketJournalForm" x-show="editingMarketJournalId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 card">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">過往日誌</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <template x-for="entry in marketJournals" :key="entry.id">
                            <div class="bg-[var(--bg-tertiary)] p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-lg" x-text="entry.date"></p>
                                    <div>
                                        <button @click="editMarketJournal(entry)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                        <button @click="deleteMarketJournal(entry.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                    </div>
                                </div>
                                <p class="text-sm mt-2"><strong class="text-[var(--text-secondary)]">大盤:</strong> <span x-text="entry.marketSummary"></span></p>
                                <p class="text-sm"><strong class="text-[var(--text-secondary)]">領漲:</strong> <span x-text="entry.leadingSectors"></span></p>
                                <p class="text-sm"><strong class="text-[var(--text-secondary)]">總結:</strong> <span x-text="entry.summary"></span></p>
                            </div>
                        </template>
                        <div x-show="marketJournals.length === 0" class="text-center py-16 text-[var(--text-tertiary)]">暫無市場日誌</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- v8.0 買入計劃 (Buy Plan) -->
        <div x-show="activeTab === 'buyPlan'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2" x-text="editingBuyPlanId ? '編輯計劃' : '新增買入計劃'"></h2>
                    <form @submit.prevent="saveBuyPlan" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">名稱</label><input type="text" x-model="buyPlanForm.name" required class="w-full form-input mt-1"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">代號</label><input type="text" x-model="buyPlanForm.ticker" required class="w-full form-input mt-1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">行業</label><input type="text" x-model="buyPlanForm.sector" class="w-full form-input mt-1"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">型態</label><input type="text" x-model="buyPlanForm.pattern" class="w-full form-input mt-1"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">關鍵買點 (Pivot)</label><input type="number" step="any" x-model.number="buyPlanForm.pivot" class="w-full form-input mt-1"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">停損價</label><input type="number" step="any" x-model.number="buyPlanForm.stopLoss" class="w-full form-input mt-1"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">目標價</label><input type="number" step="any" x-model.number="buyPlanForm.target" class="w-full form-input mt-1"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">理由 / Rationale</label><textarea x-model="buyPlanForm.rationale" rows="3" class="w-full form-textarea mt-1"></textarea></div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">股價圖片</label>
                            <input type="file" @change="handleImageUpload($event, buyPlanForm, 'buyPlans')" accept="image/*" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer mt-1">
                            <div x-show="isUploadingImage" class="mt-2 flex items-center gap-2 text-sm text-blue-500">... (上傳中動畫) ...</div>
                            <template x-if="buyPlanForm.chartImage"><div class="relative mt-2"><img :src="buyPlanForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto"><button type="button" @click="buyPlanForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" :disabled="isUploadingImage" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50" x-text="editingBuyPlanId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetBuyPlanForm" x-show="editingBuyPlanId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 card">
                     <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">待執行計劃</h2>
                     <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <template x-for="plan in buyPlans" :key="plan.id">
                            <div class="bg-[var(--bg-tertiary)] p-4 rounded-lg flex items-start gap-4">
                               <img :src="plan.chartImage || 'https://placehold.co/120x90/374151/9ca3af?text=No+Chart'" @click="openChartModal(plan.chartImage)" class="w-32 h-24 object-cover rounded-md cursor-pointer flex-shrink-0">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg" x-text="`${plan.name} (${plan.ticker})`"></p>
                                            <p class="text-sm text-[var(--text-secondary)]" x-text="plan.pattern"></p>
                                        </div>
                                        <div>
                                            <button @click="editBuyPlan(plan)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                            <button @click="deleteBuyPlan(plan.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                        </div>
                                    </div>
                                    <p class="text-sm mt-2"><strong class="text-[var(--text-secondary)]">買點:</strong> <span x-text="plan.pivot"></span> | <strong class="text-[var(--text-secondary)]">止損:</strong> <span x-text="plan.stopLoss"></span></p>
                                    <p class="text-sm mt-1"><strong class="text-[var(--text-secondary)]">理由:</strong> <span x-text="plan.rationale"></span></p>
                                </div>
                            </div>
                        </template>
                         <div x-show="buyPlans.length === 0" class="text-center py-16 text-[var(--text-tertiary)]">暫無買入計劃</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- v8.0 注碼計算機 (Calculator) -->
        <div x-show="activeTab === 'calculator'" x-cloak>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">1. 資金輸入</h2>
                    <div class="space-y-4">
                        <div><label for="usdPrincipalCalc" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">股票戶口本金 (USD)</label><div class="input-group"><span>$</span><input type="number" id="usdPrincipalCalc" x-model.number="settings.usdPrincipal" @blur="saveSettings(true)" class="text-lg"></div></div>
                        <div><p class="text-sm font-medium text-[var(--text-secondary)]">等值港元 (HKD)</p><div class="mt-1 p-3 bg-[var(--bg-tertiary)] rounded-lg text-lg font-mono" x-text="`HKD ${formatCurrency(settings.usdPrincipal * (exchangeRates.HKD || 7.8), 'HKD')}`"></div><p class="text-xs text-[var(--text-tertiary)] mt-1 text-right" x-text="`按 1 USD = ${(exchangeRates.HKD || 7.8).toFixed(3)} HKD 換算`"></p></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">2. 交易設定</h2>
                    <div class="space-y-4">
                        <div><label for="stopLossPercent" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">止損幅度 (%)</label><div class="input-group"><input type="number" id="stopLossPercent" x-model.number="stopLossPercent" step="0.1" class="text-lg"><span>%</span></div></div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">風險倉位 (R%)</label>
                            <div class="grid grid-cols-3 gap-2"><template x-for="risk in [0.25, 0.55, 0.75, 0.93, 1, 1.5]" :key="risk"><button @click="currentRiskPercent = risk; customRiskPercent = null" :class="{'active': currentRiskPercent === risk, 'bg-[var(--bg-tertiary)] hover:bg-[var(--bg-quaternary)]': currentRiskPercent !== risk}" class="tab-btn !rounded-md !border-0" x-text="`${risk}%`"></button></template></div>
                            <div class="mt-2 input-group"><span>自訂</span><input type="number" id="customRiskPercent" placeholder="例如: 2" x-model.number="customRiskPercent" @input="currentRiskPercent = customRiskPercent" step="0.1" class="text-sm"><span>%</span></div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="mt-6 card">
                <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">3. 計算結果</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                    <div><p class="text-sm text-blue-400">單次交易風險金額 (1R)</p><p class="text-2xl font-bold mt-1" x-text="`USD ${formatCurrency(rValueUsd, 'USD')}`"></p><p class="text-md text-[var(--text-secondary)]" x-text="`HKD ${formatCurrency(rValueUsd * (exchangeRates.HKD || 7.8), 'HKD')}`"></p></div>
                    <div><p class="text-sm text-green-400">建議買入資金 (下注金額)</p><p class="text-2xl font-bold mt-1" x-text="`USD ${formatCurrency(positionSizeUsd, 'USD')}`"></p><p class="text-md text-[var(--text-secondary)]" x-text="`HKD ${formatCurrency(positionSizeUsd * (exchangeRates.HKD || 7.8), 'HKD')}`"></p></div>
                </div>
            </div>
            <div class="mt-6 card">
                <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2 flex justify-between items-center flex-wrap"><span>盈利目標</span><span class="text-sm font-medium text-[var(--text-secondary)]">風險倉位: <span x-text="`${currentRiskPercent || 0}%`" class="text-blue-400"></span> / 止損幅度: <span x-text="`${stopLossPercent || 0}%`" class="text-yellow-400"></span></span></h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left"><thead class="text-xs text-[var(--text-secondary)] uppercase bg-[var(--bg-tertiary)]"><tr><th scope="col" class="px-4 py-3 rounded-l-lg">盈虧比 (R)</th><th scope="col" class="px-4 py-3">目標價格升幅 (%)</th><th scope="col" class="px-4 py-3">潛在利潤 (USD)</th><th scope="col" class="px-4 py-3 rounded-r-lg">潛在利潤 (HKD)</th></tr></thead>
                        <tbody><template x-for="ratio in [1, 2, 2.5, 3, 4, 5, 7, 10]" :key="ratio"><tr class="border-b border-[var(--border-primary)] hover:bg-[var(--bg-primary)]"><td class="px-4 py-3 font-medium" x-text="`${ratio}R`"></td><td class="px-4 py-3 text-yellow-400 font-mono" x-text="`+${(stopLossPercent * ratio).toFixed(2)}%`"></td><td class="px-4 py-3 text-green-400 font-mono" x-text="`+${formatCurrency(rValueUsd * ratio, 'USD')}`"></td><td class="px-4 py-3 text-green-400 font-mono" x-text="`+${formatCurrency((rValueUsd * ratio) * (exchangeRates.HKD || 7.8), 'HKD')}`"></td></tr></template></tbody>
                    </table>
                </div>
            </div>
             <div class="mt-6 card">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b border-[var(--border-primary)] pb-2 gap-4"><h2 class="text-xl font-semibold whitespace-nowrap">✨ AI 交易策略分析</h2><button @click="getAiAnalysis()" :disabled="isLoading" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">獲取分析</button></div>
                <div x-html="aiAnalysisResult" class="prose prose-sm max-w-none text-[var(--text-primary)] prose-strong:text-[var(--text-primary)]"></div>
                <div x-show="isLoading" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0.0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2 text-sm text-[var(--text-secondary)]">分析中，請稍候...</p></div>
            </div>
        </div>

        <!-- v8.0 交易日誌 (Journal) -->
        <div x-show="activeTab === 'journal'" x-cloak>
            <!-- 3.4 快速注碼計算器 v2.0 -->
            <div class="card mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-blue-400">快速注碼計算器 v2.0</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-[var(--text-secondary)]">顯示貨幣</span>
                        <select x-model="settings.displayCurrency" @change="saveSettings(); updateQuickSizer();" class="form-select !w-auto !py-1 !px-2 !text-xs">
                            <option value="HKD">HKD</option>
                            <option value="TWD">TWD</option>
                            <option value="JPY">JPY</option>
                            <option value="CNY">CNY</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    <!-- 1. 戶口本金 -->
                    <div class="md:col-span-1">
                        <label class="text-xs text-[var(--text-secondary)]">戶口本金 (USD)</label>
                        <p class="text-lg font-bold" x-text="formatCurrency(settings.usdPrincipal, 'USD')"></p>
                    </div>
                    <!-- 2. 止損幅度 -->
                    <div>
                        <label for="quickStopLossPercent" class="text-xs text-[var(--text-secondary)]">止損幅度 (%)</label>
                        <input type="number" id="quickStopLossPercent" x-model.number="quickSizer.stopLossPercent" @input="updateQuickSizer()" class="w-full form-input mt-1 !p-2">
                    </div>
                    <!-- 3. 風險倉位 -->
                    <div>
                        <label for="quickRiskPercent" class="text-xs text-[var(--text-secondary)]">風險倉位 (R%)</label>
                        <input type="number" id="quickRiskPercent" x-model.number="quickSizer.riskPercent" @input="updateQuickSizer()" class="w-full form-input mt-1 !p-2">
                    </div>
                    <!-- 4. 計算結果 (1R) -->
                    <div class="md:col-span-1">
                        <label class="text-xs text-[var(--text-secondary)]">單次交易風險 (1R)</label>
                        <p class="text-md font-bold text-yellow-400" x-text="`USD ${quickSizer.riskAmount.toFixed(2)}`"></p>
                        <p class="text-xs text-[var(--text-secondary)]" x-text="`${settings.displayCurrency} ${quickSizer.riskAmountConverted.toFixed(2)}`"></p>
                    </div>
                    <!-- 5. 計算結果 (建議買入) -->
                    <div class="md:col-span-1">
                        <label class="text-xs text-[var(--text-secondary)]">建議買入資金</label>
                        <p class="text-md font-bold text-green-400" x-text="`USD ${quickSizer.positionSize.toFixed(2)}`"></p>
                        <p class="text-xs text-[var(--text-secondary)]" x-text="`${settings.displayCurrency} ${quickSizer.positionSizeConverted.toFixed(2)}`"></p>
                    </div>
                    <!-- 6. 套用按鈕 -->
                    <button @click="applyQuickSizer()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-3 rounded-lg transition-colors">
                        套用至表單
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2" x-text="editingTradeId ? '編輯主交易' : '新增主交易 (開倉)'"></h2>
                    <form @submit.prevent="saveTrade" class="space-y-4">
                        <div> <label class="block text-sm font-medium text-[var(--text-secondary)]">開倉日期</label> <input type="date" x-model="journalForm.entryDate" required class="w-full form-input mt-1"> </div>
                        <div> <label class="block text-sm font-medium text-[var(--text-secondary)]">代號</label> <input type="text" x-model="journalForm.ticker" placeholder="AAPL" required class="w-full form-input mt-1"> </div>
                        <div> <label class="block text-sm font-medium text-[var(--text-secondary)]">方向</label> <select x-model="journalForm.direction" class="w-full form-select mt-1"> <option>Long</option> <option>Short</option> </select> </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">風險倉位 (R%)</label><input type="number" step="0.01" x-model.number="journalForm.riskPercent" placeholder="1.0" class="w-full form-input mt-1"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">初始風險 (1R)</label><input type="number" step="any" x-model.number="journalForm.riskAmount" placeholder="350" required class="w-full form-input mt-1"></div>
                        </div>
                        
                        <!-- 3.3 Playbook 聯動 -->
                        <div> 
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">交易策略 / Playbook</label> 
                            <select x-model="journalForm.setup" class="w-full form-select mt-1">
                                <option value="">-- 選擇一個 Playbook --</option>
                                <template x-for="playbook in playbooks" :key="playbook.id">
                                    <option :value="playbook.name" x-text="playbook.name"></option>
                                </template>
                                <option value="Other">其他 (請在理由中註明)</option>
                            </select>
                        </div>
                        
                        <div> <label class="block text-sm font-medium text-[var(--text-secondary)]">進場理由</label> <textarea x-model="journalForm.rationale" rows="3" class="w-full form-textarea mt-1" placeholder="記錄進場的技術或基本面原因..."></textarea> </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">股價圖片</label>
                            <input type="file" @change="handleImageUpload($event, journalForm, 'trades')" accept="image/*" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer mt-1">
                            <div x-show="isUploadingImage" class="mt-2 flex items-center gap-2 text-sm text-blue-500">... (上傳中動畫) ...</div>
                            <template x-if="journalForm.chartImage"><div class="relative mt-2"><img :src="journalForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto"><button type="button" @click="journalForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" :disabled="isUploadingImage" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50" x-text="editingTradeId ? '更新主交易' : '儲存新主交易'"></button>
                             <button type="button" @click="resetForm" x-show="editingTradeId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                        </div>
                    </form>
                </div>

                <div class="lg:col-span-2 card overflow-x-auto">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2">主交易列表</h2>
                         <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="text-xs text-[var(--text-secondary)] uppercase bg-[var(--bg-tertiary)]"><tr><th class="px-4 py-3">開倉日</th><th class="px-4 py-3">代號</th><th class="px-4 py-3">策略(Playbook)</th><th class="px-4 py-3">狀態</th><th class="px-4 py-3">現有R倍數</th><th class="px-4 py-3">操作</th></tr></thead>
                            <tbody>
                                <template x-for="trade in trades" :key="trade.id">
                                    <tr @click="selectTrade(trade)" class="border-b border-[var(--border-primary)] hover:bg-[var(--bg-primary)] cursor-pointer" :class="{'bg-blue-900/50': selectedTradeId === trade.id}">
                                        <td class="px-4 py-3" x-text="trade.entryDate"></td>
                                        <td class="px-4 py-3" x-text="trade.ticker"></td>
                                        <td class="px-4 py-3 text-xs"><span class="px-2 py-0.5 rounded-full bg-yellow-900 text-yellow-300" x-text="trade.setup || 'N/A'"></span></td>
                                        <td class="px-4 py-3"><span x-text="getTradeDetails(trade).status" :class="getTradeDetails(trade).status === 'Open' ? 'text-yellow-400' : 'text-gray-400'"></span></td>
                                        <td class="px-4 py-3 font-mono" x-text="`${getTradeDetails(trade).rMultiple.toFixed(2)} R`" :class="getTradeDetails(trade).rMultiple >= 0 ? 'text-green-400' : 'text-red-400'"></td>
                                        <td class="px-4 py-3 flex gap-2"><button @click.stop="editTrade(trade)" class="text-blue-400 hover:text-blue-300">編輯</button><button @click.stop="deleteTrade(trade.id)" class="text-red-400 hover:text-red-300">刪除</button></td>
                                    </tr>
                                </template>
                                 <tr x-show="trades.length === 0"><td colspan="6" class="text-center py-8 text-[var(--text-tertiary)]">暫無交易記錄</td></tr>
                            </tbody>
                         </table>
                    </div>
                    
                    <div x-show="selectedTradeId" x-cloak>
                        <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2 flex justify-between">
                            <span>子交易記錄 (<span x-text="selectedTrade ? selectedTrade.ticker : ''"></span>)</span>
                            <button @click="showTxnForm = !showTxnForm" class="text-sm bg-green-600 hover:bg-green-500 px-3 py-1 rounded-lg transition-colors" x-text="showTxnForm ? '關閉表單' : '新增記錄'"></button>
                        </h2>

                        <div x-show="showTxnForm" class="bg-[var(--bg-tertiary)] p-4 rounded-lg mb-4">
                            <h3 class="font-semibold mb-2" x-text="editingTxnId ? '編輯子交易' : '新增子交易'"></h3>
                            <form @submit.prevent="saveSubTransaction" class="space-y-3">
                                <div class="grid grid-cols-3 gap-3">
                                    <div><label class="text-xs text-[var(--text-secondary)]">動作</label><select x-model="txnForm.type" class="w-full form-select !p-2 mt-1 text-sm"><option>Buy</option><option>Sell</option></select></div>
                                    <div><label class="text-xs text-[var(--text-secondary)]">日期</label><input type="date" x-model="txnForm.date" required class="w-full form-input !p-2 mt-1 text-sm"></div>
                                    <div><label class="text-xs text-[var(--text-secondary)]">股數</label><input type="number" step="any" x-model.number="txnForm.quantity" required placeholder="100" class="w-full form-input !p-2 mt-1 text-sm"></div>
                                </div>
                                <div><label class="text-xs text-[var(--text-secondary)]">價格</label><input type="number" step="any" x-model.number="txnForm.price" required placeholder="150.25" class="w-full form-input !p-2 mt-1 text-sm"></div>
                                <div><label class="text-xs text-[var(--text-secondary)]">備註</label><input type="text" x-model="txnForm.notes" placeholder="跌穿5天線, 賣出1/3" class="w-full form-input !p-2 mt-1 text-sm"></div>
                                <div class="flex justify-end gap-3 pt-2">
                                    <button type="button" @click="resetTxnForm" class="text-xs bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded-lg transition-colors">取消</button>
                                    <button type="submit" class="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg transition-colors" x-text="editingTxnId ? '更新記錄' : '儲存記錄'"></button>
                                </div>
                            </form>
                        </div>

                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="text-xs text-[var(--text-secondary)] uppercase bg-[var(--bg-tertiary)]"><tr><th class="px-4 py-2">日期</th><th class="px-4 py-2">動作</th><th class="px-4 py-2">股數</th><th class="px-4 py-2">價格</th><th class="px-4 py-2">備註</th><th class="px-4 py-2">操作</th></tr></thead>
                            <tbody>
                                <template x-for="txn in (selectedTrade ? selectedTrade.transactions.sort((a, b) => new Date(a.date) - new Date(b.date)) : [])" :key="txn.id">
                                    <tr class="border-b border-[var(--border-primary)]">
                                        <td class="px-4 py-2" x-text="txn.date"></td>
                                        <td class="px-4 py-2" x-text="txn.type" :class="txn.type === 'Buy' ? 'text-green-400' : 'text-red-400'"></td>
                                        <td class="px-4 py-2" x-text="txn.quantity"></td>
                                        <td class="px-4 py-2" x-text="txn.price"></td>
                                        <td class="px-4 py-2 text-[var(--text-secondary)]" x-text="txn.notes"></td>
                                        <td class="px-4 py-2 flex gap-2">
                                            <button @click="editSubTransaction(txn)" class="text-blue-400 hover:text-blue-300 text-xs">編輯</button>
                                            <button @click="deleteSubTransaction(txn.id)" class="text-red-400 hover:text-red-300 text-xs">刪除</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- v8.0 模型庫 (Model Book) -->
        <div x-show="activeTab === 'modelBook'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-[var(--border-primary)] pb-2" x-text="editingModelBookId ? '編輯模型' : '新增模型'"></h2>
                    <form @submit.prevent="saveModelBook" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">名稱</label><input type="text" x-model="modelBookForm.name" required class="w-full form-input mt-1"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">代號</label><input type="text" x-model="modelBookForm.ticker" required class="w-full form-input mt-1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div><label class="block text-sm font-medium text-[var(--text-secondary)]">市場</label><input type="text" x-model="modelBookForm.market" placeholder="US, HK" class="w-full form-input mt-1"></div>
                             <div><label class="block text-sm font-medium text-[var(--text-secondary)]">年份</label><input type="number" x-model.number="modelBookForm.year" placeholder="2023" class="w-full form-input mt-1"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">行業</label><input type="text" x-model="modelBookForm.sector" class="w-full form-input mt-1"></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">型態</label><input type="text" x-model="modelBookForm.pattern" placeholder="Cup with Handle, VCP..." class="w-full form-input mt-1"></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">突破後表現</label><input type="text" x-model="modelBookForm.performance" placeholder="+150% in 3 months" class="w-full form-input mt-1"></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">關鍵買入點</label><textarea x-model="modelBookForm.pivot" rows="2" class="w-full form-textarea mt-1"></textarea></div>
                        <div><label class="block text-sm font-medium text-[var(--text-secondary)]">心得</label><textarea x-model="modelBookForm.takeaways" rows="3" class="w-full form-textarea mt-1"></textarea></div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)]">圖表快照</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="file" @change="handleImageUpload($event, modelBookForm, 'modelBooks')" accept="image/*" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer">
                                <svg x-show="isUploadingImage" class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </div>
                            <template x-if="modelBookForm.chartImage">
                                <div class="relative mt-2"><img :src="modelBookForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto"><button type="button" @click="modelBookForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div>
                            </template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" :disabled="isUploadingImage" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50" x-text="editingModelBookId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetModelBookForm" x-show="editingModelBookId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 card">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-semibold">模型庫</h2>
                        <button @click="getAiModelBookAnalysis()" :disabled="isLoading || modelBooks.length < 2" class="w-full mt-2 sm:mt-0 sm:w-auto bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">✨ AI 總結共通特徵</button>
                    </div>
                    <div x-show="isLoading && aiAnalysisContext === 'modelBook'" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-teal-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                    <div x-html="aiModelBookAnalysis" x-show="aiModelBookAnalysis" class="prose prose-sm max-w-none text-[var(--text-primary)] prose-strong:text-[var(--text-primary)] mb-4 p-4 bg-[var(--bg-tertiary)] rounded-lg"></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto pr-2">
                        <template x-for="model in modelBooks" :key="model.id">
                            <div class="bg-[var(--bg-tertiary)] rounded-xl overflow-hidden border border-[var(--border-primary)]">
                                <img :src="model.chartImage || 'https://placehold.co/600x400/374151/9ca3af?text=No+Image'" class="w-full h-64 object-cover cursor-pointer" @click="openChartModal(model.chartImage || '')">
                                <div class="p-4">
                                    <h3 class="font-bold text-lg" x-text="`${model.name} (${model.ticker})`"></h3>
                                    <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-green-900 text-green-300" x-text="model.pattern"></span>
                                    <p class="text-sm text-[var(--text-secondary)] mt-2"><strong class="text-[var(--text-tertiary)]">表現:</strong> <span x-text="model.performance"></span></p>
                                    <p class="text-sm text-[var(--text-secondary)] mt-2 h-12 overflow-y-auto"><strong class="text-[var(--text-tertiary)]">心得:</strong> <span x-text="model.takeaways"></span></p>
                                    <div class="mt-4 flex justify-end gap-2"><button @click="editModelBook(model)" class="text-blue-400 hover:text-blue-300">編輯</button><button @click="deleteModelBook(model.id)" class="text-red-400 hover:text-red-300">刪除</button></div>
                                </div>
                            </div>
                        </template>
                         <div x-show="modelBooks.length === 0" class="md:col-span-2 text-center py-16 text-[var(--text-tertiary)]"><p>您的模型庫是空的，請在左方新增您的第一個成功案例模型。</p></div>
                     </div>
                </div>
            </div>
        </div>
<!-- ... (Part 3 結束) ... -->

        <!-- v8.0 績效回顧 (Performance) -->
        <div x-show="activeTab === 'performance'" x-cloak>
            <div class.space-y-8">
                <!-- 核心指標 -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="metric-card">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">總盈虧</h3>
                        <p class="mt-2 text-2xl font-bold" :class="metrics.totalPl >= 0 ? 'text-[var(--text-green)]' : 'text-[var(--text-red)]'" x-text="formatCurrency(metrics.totalPl, 'USD')"></p>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">勝率</h3>
                        <p class="mt-2 text-2xl font-bold" x-text="`${metrics.winRate.toFixed(1)}%`"></p>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">利潤因子</h3>
                        <p class="mt-2 text-2xl font-bold" :class="metrics.profitFactor >= 1 ? 'text-[var(--text-green)]' : 'text-[var(--text-red)]'" x-text="metrics.profitFactor.toFixed(2)"></p>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">平均 R 倍數</h3>
                        <p class="mt-2 text-2xl font-bold" :class="metrics.avgR >= 0 ? 'text-[var(--text-green)]' : 'text-[var(--text-red)]'" x-text="`${metrics.avgR.toFixed(2)} R`"></p>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">總交易數</h3>
                        <p class="mt-2 text-2xl font-bold" x-text="metrics.totalTrades"></p>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">平均持倉</h3>
                        <p class="mt-2 text-2xl font-bold" x-text="metrics.avgHoldingTime"></p>
                    </div>
                </div>
                
                <!-- 圖表與分析 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                    <div class="lg:col-span-2 card h-[400px]">
                        <h2 class="text-xl font-semibold mb-4">資金曲線圖</h2>
                        <div class="h-[300px]">
                            <canvas id="plChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">最大回撤 (Max Drawdown)</h2>
                        <button @click="getAiDrawdownAnalysis()" :disabled="isLoading || trades.length < 2" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition mb-4 disabled:opacity-50 disabled:cursor-not-allowed">由 AI 分析</button>
                        <div x-show="isLoading && aiAnalysisContext === 'drawdown'" class="text-center py-4"><svg class="animate-spin h-6 w-6 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                        <div x-html="maxDrawdownAnalysis" class="prose prose-sm max-w-none text-[var(--text-primary)] prose-strong:text-[var(--text-primary)]"></div>
                    </div>
                </div>

                <!-- 4.1 按 Playbook 策略進行績效分析 -->
                <div class="mt-6 card">
                    <h2 class="text-xl font-semibold mb-4">按 Playbook 策略進行績效分析</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="text-xs text-[var(--text-secondary)] uppercase bg-[var(--bg-tertiary)]">
                                <tr>
                                    <th class="px-4 py-3">Playbook 策略</th>
                                    <th class="px-4 py-3">總淨盈虧</th>
                                    <th class="px-4 py-3">勝率</th>
                                    <th class="px-4 py-3">平均 R 倍數</th>
                                    <th class="px-4 py-3">利潤因子</th>
                                    <th class="px-4 py-3">總交易筆數</th>
                                    <th class="px-4 py-3">平均持倉時間</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="perf in playbookPerformance" :key="perf.setup">
                                    <tr class="border-b border-[var(--border-primary)] hover:bg-[var(--bg-primary)]">
                                        <td class="px-4 py-3 font-medium" x-text="perf.setup"></td>
                                        <td class="px-4 py-3" :class="perf.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(perf.totalPl)"></td>
                                        <td class="px-4 py-3" x-text="`${perf.winRate.toFixed(1)}%`"></td>
                                        <td class="px-4 py-3 font-mono" :class="perf.avgR >= 0 ? 'text-green-400' : 'text-red-400'" x-text="`${perf.avgR.toFixed(2)} R`"></td>
                                        <td class="px-4 py-3" :class="perf.profitFactor >= 1 ? 'text-green-400' : 'text-red-400'" x-text="perf.profitFactor.toFixed(2)"></td>
                                        <td class="px-4 py-3" x-text="perf.totalTrades"></td>
                                        <td class="px-4 py-3" x-text="perf.avgHoldingTime"></td>
                                    </tr>
                                </template>
                                <tr x-show="playbookPerformance.length === 0">
                                    <td colspan="7" class="text-center py-8 text-[var(--text-tertiary)]">
                                        尚無已平倉的 Playbook 交易數據
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- AI 情緒分析 -->
                <div class="mt-6 card">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"><h2 class="text-xl font-semibold">✨ AI 情緒模式分析</h2><button @click="getAiEmotionAnalysis()" :disabled="isLoading || trades.length < 1" class="w-full mt-2 sm:mt-0 sm:w-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">分析情緒與績效關聯</button></div>
                    <div x-show="isLoading && aiAnalysisContext === 'emotion'" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-purple-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                    <div x-html="aiEmotionAnalysisResult" class="prose prose-sm max-w-none text-[var(--text-primary)] prose-strong:text-[var(--text-primary)]"></div>
                </div>
                
                <!-- 月度回顧 -->
                <div class="mt-6 card">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"><h2 class="text-xl font-semibold">月度 / 季度回顧</h2><button @click="getAiPerformanceReview()" :disabled="isLoading || trades.length < 1" class="w-full mt-2 sm:mt-0 sm:w-auto bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">✨ 產生 AI 回顧報告</button></div>
                    <div x-show="isLoading && aiAnalysisContext === 'review'" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-green-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                    <div class="space-y-4">
                         <div><label class="block text-sm font-medium text-[var(--text-secondary)]">每月表現</label><textarea x-model="reviewNotes.monthly" rows="5" class="w-full form-textarea mt-1"></textarea></div>
                         <div><label class="block text-sm font-medium text-[var(--text-secondary)]">需要改善的地方</label><textarea x-model="reviewNotes.improve" rows="5" class="w-full form-textarea mt-1"></textarea></div>
                         <div><label class="block text-sm font-medium text-[var(--text-secondary)]">下月目標</label><textarea x-model="reviewNotes.goals" rows="5" class="w-full form-textarea mt-1"></textarea></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- v8.0 設定 (Settings) -->
        <div x-show="activeTab === 'settings'" x-cloak>
            <div class="max-w-2xl mx-auto card">
                <h2 class="text-2xl font-semibold mb-6 text-blue-500 border-b border-[var(--border-primary)] pb-3">設定</h2>
                
                <div class="space-y-8">
                    <!-- 1.1 主題設定 -->
                    <div>
                        <h3 class="text-lg font-medium text-[var(--text-primary)]">外觀</h3>
                        <div class="mt-4 space-y-2">
                            <label for="theme" class="block text-sm font-medium text-[var(--text-secondary)]">主題 (Theme)</label>
                            <select id="theme" x-model="settings.theme" @change="applyThemeSetting()" class="w-full form-select">
                                <option value="system">跟隨系統</option>
                                <option value="light">日間模式</option>
                                <option value="dark">夜間模式</option>
                            </select>
                        </div>
                    </div>

                    <!-- AI 分析設定 -->
                    <div>
                        <h3 class="text-lg font-medium text-[var(--text-primary)]">AI 分析設定</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label for="aiProvider" class="block text-sm font-medium text-[var(--text-secondary)]">AI 服務供應商</label>
                                <select id="aiProvider" x-model="settings.aiProvider" @change="saveSettings()" class="mt-1 block w-full form-select">
                                    <option value="gemini">預設 (內建 AI)</option>
                                    <option value="custom">自訂 API Key (OpenAI 相容)</option>
                                </select>
                                <p class="mt-2 text-xs text-[var(--text-tertiary)]">選擇 "預設" 將使用內建的 Gemini 連接。選擇 "自訂" 以使用您自己的 API Key。</p>
                            </div>

                            <div x-show="settings.aiProvider === 'custom'" x-cloak class="space-y-4 p-4 bg-[var(--bg-tertiary)] rounded-lg border border-[var(--border-primary)]">
                                <div>
                                    <label for="customApiUrl" class="block text-sm font-medium text-[var(--text-secondary)]">API 端點 (Endpoint URL)</label>
                                    <input type="text" id="customApiUrl" x-model="settings.customApiUrl" placeholder="https://api.openai.com/v1/chat/completions" class="w-full form-input mt-1 !bg-[var(--bg-primary)]">
                                </div>
                                <div>
                                    <label for="customApiKey" class="block text-sm font-medium text-[var(--text-secondary)]">您的 API Key</label>
                                    <input type="password" id="customApiKey" x-model="settings.customApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full form-input mt-1 !bg-[var(--bg-primary)]">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end border-t border-[var(--border-primary)] pt-6">
                        <button @click="saveSettings(true)" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">儲存設定</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- v8.0 頁腳 -->
        <footer class="text-center mt-12 text-[var(--text-tertiary)] text-xs space-y-1">
            <p>此工具僅供參考，不構成任何投資建議。AI 分析由大型語言模型生成，可能存在錯誤，請謹慎管理您的風險。</p>
            <p>版本: <span x-text="appVersion"></span> | 最後更新: <span x-text="lastUpdated"></span></p>
        </footer>

        <!-- v8.0 圖片模態框 -->
        <div x-show="isModalOpen" x-cloak class="modal-backdrop" @click="closeChartModal">
            <div class="modal-content p-2" @click.stop>
                <img :src="modalImageUrl" class="max-w-full max-h-full rounded-md">
            </div>
        </div>
    </div>
        
    <!-- v8.0 Firebase 與 Alpine.js 腳本 (將在 Part 5 中) -->
    <script type="module">
        // ... (JavaScript 內容將在 Part 5 提供) ...
    </script>
</body>
</html>

<!-- ... (Part 4 結束) ... -->

    <!-- vNORMAL v8.0 Firebase 與 Alpine.js 腳本 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, serverTimestamp, query, orderBy, Timestamp, updateDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/module.esm.js';

        function tradingApp() {
            return {
                // System State
                isInitialized: false,
                isLoggedIn: false,
                activeTab: 'dashboard',
                isLoading: false,
                isUploadingImage: false,
                isModalOpen: false,
                modalImageUrl: '',
                authView: 'login',
                authForm: { email: '', password: '' },
                authError: '',
                appVersion: '8.0.0', // v8.0
                lastUpdated: '2024-10-26', // v8.0
                aiAnalysisContext: '', // v8.0
                tvWidgetsLoaded: false, // v5.2

                // Firebase
                db: null,
                auth: null,
                storage: null, // v8.0
                userId: null,
                
                // Settings (v8.0)
                settings: {
                    aiProvider: 'gemini',
                    customApiKey: '',
                    customApiUrl: '',
                    usdPrincipal: 35000,
                    theme: 'system', // v1.1
                    displayCurrency: 'HKD' // v3.4
                },
                
                // Data Arrays
                trades: [],
                marketJournals: [],
                buyPlans: [],
                modelBooks: [],
                reflections: [],
                marketCompassLog: [],
                playbooks: [], // v3.2

                // Journal v8.0 State
                selectedTradeId: null,
                selectedTrade: null,
                showTxnForm: false,
                editingTxnId: null, 
                txnForm: {},
                
                // Quick Sizer v2.0 (v3.4)
                quickSizer: {
                    riskPercent: 1.0,
                    stopLossPercent: 5.0,
                    riskAmount: 0,
                    riskAmountConverted: 0,
                    positionSize: 0,
                    positionSizeConverted: 0
                },
                exchangeRates: { // v5.1 (Fallback rates)
                    USD: 1.0,
                    HKD: 7.8,
                    TWD: 32.0,
                    JPY: 140.0,
                    CNY: 7.2
                },

                // Calendar State (v2.3)
                calendar: {
                    year: new Date().getFullYear(),
                    month: new Date().getMonth(),
                    days: [],
                    yearOptions: []
                },
                marketCompass: { US: 'Neutral', HK: 'Neutral' },

                // Forms & Editing State
                editingTradeId: null, journalForm: {},
                editingMarketJournalId: null, marketJournalForm: {},
                editingBuyPlanId: null, buyPlanForm: {},
                editingModelBookId: null, modelBookForm: {},
                editingReflectionId: null, reflectionForm: {},
                editingPlaybookId: null, playbookForm: {}, // v3.2
                marketCompassLogForm: { notes: '' },
                
                // Search
                searchTerm: '',
                searchResults: [],

                // Calculator (Legacy Tab)
                stopLossPercent: 4.6,
                currentRiskPercent: 1,
                customRiskPercent: null,
                
                // Charts (v2.1, 2.2)
                plChart: null,
                dashboardPlChart: null,
                hexagonScoreChart: null,
                
                // AI & Performance
                aiAnalysisResult: '<p class="text-[var(--text-tertiary)]">點擊「獲取分析」按鈕，讓 AI 根據您當前的設定提供交易策略建議。</p>',
                maxDrawdownAnalysis: '<p class="text-[var(--text-tertiary)]">點擊按鈕，讓 AI 為您分析交易數據中的最大資金回撤。</p>',
                aiEmotionAnalysisResult: '<p class="text-[var(--text-tertiary)]">點擊按鈕，讓 AI 分析您的情緒標籤與交易結果之間的關聯。</p>',
                aiModelBookAnalysis: '',
                reviewNotes: { monthly: '', improve: '', goals: '' },
                aiDashboardSummary: '',
                aiQuery: '',

                // --- Computed Properties (v8.0) ---
                
                // Legacy Calculator properties
                get rValueUsd() { return this.settings.usdPrincipal * ((this.currentRiskPercent || 0) / 100); },
                get positionSizeUsd() { if (!this.stopLossPercent) return 0; return this.rValueUsd / (this.stopLossPercent / 100); },

                // v8.0 核心指標計算 (v2.1, 2.2)
                get metrics() {
                    const closedTrades = this.trades
                        .map(t => this.getTradeDetails(t))
                        .filter(t => t.status === 'Closed');
                    
                    const totalTrades = closedTrades.length;
                    if (totalTrades === 0) {
                        const defaultScores = { winRate: 0, profitFactor: 0, avgWinLossRatio: 0, maxDrawdown: 0, recoveryFactor: 0, consistency: 0 };
                        return {
                            totalPl: 0, winRate: 0, profitFactor: 0, avgWinLossRatio: 0, totalTrades: 0, avgR: 0, avgHoldingTime: 'N/A',
                            maxDrawdown: { value: 0, percent: 0 }, recoveryFactor: 0, consistency: 0,
                            scores: defaultScores, totalScore: 0
                        };
                    }

                    // 基礎計算
                    const winningTrades = closedTrades.filter(t => t.totalPl > 0);
                    const losingTrades = closedTrades.filter(t => t.totalPl <= 0);
                    const totalPl = closedTrades.reduce((sum, t) => sum + t.totalPl, 0);
                    const totalR = closedTrades.reduce((sum, t) => sum + t.rMultiple, 0);
                    const totalGrossProfit = winningTrades.reduce((sum, t) => sum + t.totalPl, 0);
                    const totalGrossLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.totalPl, 0));
                    const totalHoldingTime = closedTrades.reduce((sum, t) => sum + t.holdingTime, 0);

                    // 核心指標
                    const winRate = totalTrades > 0 ? (winningTrades.length / totalTrades) * 100 : 0;
                    const avgR = totalTrades > 0 ? totalR / totalTrades : 0;
                    const profitFactor = totalGrossLoss > 0 ? totalGrossProfit / totalGrossLoss : (totalGrossProfit > 0 ? 100 : 0);
                    const avgWin = winningTrades.length > 0 ? totalGrossProfit / winningTrades.length : 0;
                    const avgLoss = losingTrades.length > 0 ? totalGrossLoss / losingTrades.length : 0;
                    const avgWinLossRatio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? 100 : 0);
                    const avgHoldingTimeDays = totalTrades > 0 ? (totalHoldingTime / totalTrades) : 0;

                    // 最大回撤 (Max Drawdown)
                    let peak = 0;
                    let maxDrawdownValue = 0;
                    let cumulativePl = 0;
                    for (const trade of closedTrades) {
                        cumulativePl += trade.totalPl;
                        if (cumulativePl > peak) {
                            peak = cumulativePl;
                        }
                        const drawdown = peak - cumulativePl;
                        if (drawdown > maxDrawdownValue) {
                            maxDrawdownValue = drawdown;
                        }
                    }
                    const maxDrawdownPercent = (this.settings.usdPrincipal + peak) > 0 ? (maxDrawdownValue / (this.settings.usdPrincipal + peak)) * 100 : 0;
                    
                    // 恢復因子 (Recovery Factor)
                    const recoveryFactor = maxDrawdownValue > 0 ? totalPl / maxDrawdownValue : (totalPl > 0 ? 100 : 0);

                    // 一致性 (Consistency) - (簡易標準差)
                    const rValues = closedTrades.map(t => t.rMultiple);
                    const meanR = avgR;
                    const variance = rValues.reduce((sum, r) => sum + Math.pow(r - meanR, 2), 0) / totalTrades;
                    const stdDevR = Math.sqrt(variance);
                    const consistency = stdDevR > 0 ? (meanR / stdDevR) : (meanR > 0 ? 100 : 0); // Sharpe-like ratio

                    // 指標歸一化 (0-100分)
                    const normalize = (val, min, max) => Math.max(0, Math.min(100, ((val - min) / (max - min)) * 100));
                    
                    const scores = {
                        winRate: normalize(winRate, 30, 60), // 30% = 0分, 60% = 100分
                        profitFactor: normalize(profitFactor, 0.8, 2.5), // 0.8 = 0分, 2.5 = 100分
                        avgWinLossRatio: normalize(avgWinLossRatio, 0.8, 3.0), // 0.8 = 0分, 3.0 = 100分
                        maxDrawdown: 100 - normalize(maxDrawdownPercent, 5, 25), // *反向* 5% = 100分, 25% = 0分
                        recoveryFactor: normalize(recoveryFactor, 0.5, 2.0), // 0.5 = 0分, 2.0 = 100分
                        consistency: normalize(consistency, 0.1, 0.5) // 0.1 = 0分, 0.5 = 100分
                    };

                    // 總分 (加權平均)
                    const weights = { winRate: 0.15, profitFactor: 0.20, avgWinLossRatio: 0.20, maxDrawdown: 0.20, recoveryFactor: 0.15, consistency: 0.10 };
                    const totalScore = Object.keys(scores).reduce((sum, key) => sum + scores[key] * weights[key], 0);

                    return {
                        totalPl, winRate, profitFactor, avgWinLossRatio, totalTrades, avgR,
                        avgHoldingTime: avgHoldingTimeDays.toFixed(1) + ' 天',
                        maxDrawdown: { value: maxDrawdownValue, percent: maxDrawdownPercent },
                        recoveryFactor,
                        consistency,
                        scores,
                        totalScore
                    };
                },
                
                // v8.0 Playbook 績效 (v4.1)
                get playbookPerformance() {
                    const closedTrades = this.trades
                        .map(t => ({ ...t, details: this.getTradeDetails(t) }))
                        .filter(t => t.details.status === 'Closed' && t.setup);

                    const grouped = closedTrades.reduce((acc, trade) => {
                        const setup = trade.setup || 'Other';
                        if (!acc[setup]) {
                            acc[setup] = [];
                        }
                        acc[setup].push(trade);
                        return acc;
                    }, {});

                    return Object.keys(grouped).map(setup => {
                        const trades = grouped[setup];
                        const totalTrades = trades.length;
                        const winningTrades = trades.filter(t => t.details.totalPl > 0);
                        const losingTrades = trades.filter(t => t.details.totalPl <= 0);

                        const totalPl = trades.reduce((sum, t) => sum + t.details.totalPl, 0);
                        const winRate = (winningTrades.length / totalTrades) * 100;
                        const totalR = trades.reduce((sum, t) => sum + t.details.rMultiple, 0);
                        const avgR = totalR / totalTrades;
                        
                        const totalGrossProfit = winningTrades.reduce((sum, t) => sum + t.details.totalPl, 0);
                        const totalGrossLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.details.totalPl, 0));
                        const profitFactor = totalGrossLoss > 0 ? totalGrossProfit / totalGrossLoss : (totalGrossProfit > 0 ? 100 : 0);

                        const totalHoldingTime = trades.reduce((sum, t) => sum + t.details.holdingTime, 0);
                        const avgHoldingTime = (totalHoldingTime / totalTrades).toFixed(1) + ' 天';

                        return { setup, totalPl, winRate, avgR, profitFactor, totalTrades, avgHoldingTime };
                    });
                },

                // --- Init & Core Methods (v8.0) ---
                
                init() {
                    this.loadSettings();
                    this.applyThemeSetting(); // v1.1 - 必須在 loadSettings 之後
                    this.resetAllForms();
                    this.initFirebase();
                    this.fetchExchangeRates(); // v5.1

                    // v2.3 - 填充日曆年份選項
                    const currentYear = new Date().getFullYear();
                    for (let y = currentYear + 1; y >= currentYear - 5; y--) {
                        this.calendar.yearOptions.push(y);
                    }
                    this.generateCalendar();

                    // 監聽日曆變化
                    this.$watch('calendar.year', () => this.generateCalendar());
                    this.$watch('calendar.month', () => this.generateCalendar());
                    this.$watch('trades', () => {
                        this.generateCalendar();
                        this.renderAllCharts(); // v8.0 - 交易變化時重繪所有圖表
                    });

                    // 監聽本金變化
                    this.$watch('settings.usdPrincipal', () => {
                        this.updateQuickSizer(); // v3.4
                        this.renderAllCharts(); // v8.0 - 本金影響回撤百分比
                    });

                    // 監聽標籤頁變化
                    this.$watch('activeTab', (newTab, oldTab) => {
                        // v5.2 - 載入/卸載 TradingView
                        if (newTab === 'tradingView') {
                            this.$nextTick(() => this.loadTradingViewWidgets());
                        } else if (oldTab === 'tradingView') {
                            this.unloadTradingViewWidgets();
                        }
                        
                        // v8.0 - 載入圖表
                        if ((newTab === 'performance' || newTab === 'dashboard') && this.isLoggedIn) {
                           this.$nextTick(() => this.renderAllCharts());
                        }
                    });
                    
                    // v1.1 - 監聽系統主題變化
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                        if (this.settings.theme === 'system') {
                            this.setTheme(e.matches ? 'dark' : 'light', false);
                        }
                    });
                },

                // v1.1 - 主題切換 (Theme)
                applyThemeSetting() {
                    this.saveSettings();
                    if (this.settings.theme === 'system') {
                        this.setTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light', false);
                    } else {
                        this.setTheme(this.settings.theme, false);
                    }
                },
                setTheme(theme, save = true) {
                    const html = document.documentElement;
                    if (theme === 'light') {
                        html.classList.remove('dark');
                        html.classList.add('light');
                    } else {
                        html.classList.remove('light');
                        html.classList.add('dark');
                    }
                    if (save) {
                        this.settings.theme = theme;
                        this.saveSettings();
                    }
                    // v5.2 - 重載 TradingView Widgets
                    this.reloadTradingViewWidgets();
                },
                toggleTheme() {
                    const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                    this.setTheme(newTheme, true);
                },

                // v8.0 - 設定 (Settings)
                loadSettings() {
                    const savedSettings = localStorage.getItem('tradingWorkbenchSettings_v8'); // v8.0
                    if (savedSettings) {
                        this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                    }
                },
                saveSettings(showAlert = false) {
                    localStorage.setItem('tradingWorkbenchSettings_v8', JSON.stringify(this.settings)); // v8.0
                    if (showAlert) {
                        // v8.0 - 避免使用 alert
                        this.showToast('設定已儲存！');
                    }
                },
                showToast(message) {
                    // 簡易提示框實現 (未來可替換為更美觀的組件)
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                },

                // --- Firebase (v8.0) ---
                async initFirebase() {
                    try {
                        // !! 警告：此處的 API Key 僅為範例，實際部署時應使用安全的方式管理 !!
                        const firebaseConfig = {
                            apiKey: "AIzaSyD_NXXcXNzKfeUct_kcv9nhSEk5ynguO0o",
                            authDomain: "my-trading-workbench.firebaseapp.com",
                            projectId: "my-trading-workbench",
                            storageBucket: "my-trading-workbench.appspot.com", // v8.0
                            messagingSenderId: "386958713208",
                            appId: "1:386958713208:web:028035e1ac4b47bd55e88d",
                            measurementId: "G-2WEVVMRHV7"
                        };
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        this.auth = getAuth(app);
                        this.storage = getStorage(app); // v8.0
                        
                        onAuthStateChanged(this.auth, (user) => {
                            this.isInitialized = true;
                            if (user) {
                                this.isLoggedIn = true;
                                this.userId = user.uid;
                                this.initializeDataListeners();
                            } 
                            else {
                                this.isLoggedIn = false;
                                this.userId = null;
                                this.clearAllData();
                            }
                        });
                    } catch(e) {
                        console.error("Firebase initialization failed:", e);
                        this.authError = "Firebase 初始化失敗。";
                        this.isInitialized = true;
                    }
                },
                initializeDataListeners() {
                    if (!this.userId) return;
                    this.loadCollection(`users/${this.userId}/trades`, 'trades', 'entryDate'); 
                    this.loadCollection(`users/${this.userId}/marketJournals`, 'marketJournals', 'date');
                    this.loadCollection(`users/${this.userId}/buyPlans`, 'buyPlans', 'createdAt');
                    this.loadCollection(`users/${this.userId}/modelBooks`, 'modelBooks', 'year');
                    this.loadCollection(`users/${this.userId}/reflections`, 'reflections', 'date');
                    this.loadCollection(`users/${this.userId}/marketCompassLog`, 'marketCompassLog', 'timestamp');
                    this.loadCollection(`users/${this.userId}/playbooks`, 'playbooks', 'name', 'asc'); // v3.2
                    
                    // 監聽羅盤數據以更新 UI
                    onSnapshot(query(collection(this.db, `users/${this.userId}/marketCompassLog`), orderBy('timestamp', 'desc')), (snapshot) => {
                        this.marketCompassLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // 更新儀表板羅盤狀態
                        const latestUS = this.marketCompassLog.find(log => log.market === 'US');
                        const latestHK = this.marketCompassLog.find(log => log.market === 'HK');
                        if (latestUS) this.marketCompass.US = latestUS.sentiment;
                        if (latestHK) this.marketCompass.HK = latestHK.sentiment;
                    });

                },
                loadCollection(path, targetProperty, orderByField, orderDirection = "desc") {
                    const q = query(collection(this.db, path), orderBy(orderByField, orderDirection));
                    onSnapshot(q, (snapshot) => {
                        this[targetProperty] = snapshot.docs.map(doc => {
                            const data = doc.data();
                            // 轉換 Timestamp (如果存在)
                            Object.keys(data).forEach(key => {
                                if (data[key] instanceof Timestamp) {
                                    data[key] = data[key].toDate().toISOString().split('T')[0];
                                }
                            });
                            return { id: doc.id, ...data };
                        });
                    }, (error) => { console.error(`Error loading ${targetProperty}:`, error); });
                },

                // ... (Auth methods: register, login, loginWithGoogle, logout, getFirebaseAuthErrorMessage) ...
                async register() { this.authError = ''; try { await createUserWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
                async login() { this.authError = ''; try { await signInWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
                async loginWithGoogle() { this.authError = ''; try { const provider = new GoogleAuthProvider(); await signInWithPopup(this.auth, provider); } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); console.error("Google Sign-in Error:", error); } },
                async logout() { await signOut(this.auth); },
                getFirebaseAuthErrorMessage(error) {
                    switch (error.code) {
                        case 'auth/email-already-in-use': return '此電子郵件已被註冊。';
                        case 'auth/invalid-email': return '電子郵件格式不正確。';
                        case 'auth/weak-password': return '密碼強度不足，請至少設定 6 個字元。';
                        case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': return '電子郵件或密碼錯誤。';
                        default: return '發生未知錯誤，請稍後再試。';
                    }
                },
                
                // v8.0 - 通用 Firebase 儲存 (Save/Delete/Upload)
                async saveEntity(collectionName, entityId, formData) {
                    if (!this.userId) return this.showToast("用戶未登入，無法儲存。");
                    try {
                        const data = { ...formData, userId: this.userId };
                        const collectionRef = collection(this.db, `users/${this.userId}/${collectionName}`);
                        
                        if (entityId) {
                            data.updatedAt = serverTimestamp();
                            await setDoc(doc(collectionRef, entityId), data, { merge: true });
                        } else {
                            data.createdAt = serverTimestamp();
                            if(collectionName === 'marketCompassLog') data.timestamp = serverTimestamp();
                            await addDoc(collectionRef, data);
                        }
                    } catch(e) { console.error("Error saving entity:", e); this.showToast("儲存失敗！"); throw e; }
                },
                async deleteEntity(collectionName, entityId, confirmMsg = "確定要刪除嗎？") {
                    if (!this.userId) return;
                    if (confirm(confirmMsg)) {
                        try {
                            await deleteDoc(doc(this.db, `users/${this.userId}/${collectionName}`, entityId));
                        } catch (e) {
                            console.error("Error deleting entity:", e); this.showToast("刪除失敗！");
                        }
                    }
                },
                async handleImageUpload(event, targetForm, collectionName) {
                    if (!this.userId) return this.showToast("請先登入");
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 5 * 1024 * 1024) return this.showToast("圖片需小於 5MB");

                    this.isUploadingImage = true;
                    try {
                        const storageRef = ref(this.storage, `users/${this.userId}/${collectionName}/${Date.now()}_${file.name}`);
                        const snapshot = await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(snapshot.ref);
                        targetForm.chartImage = downloadURL;
                    } catch (e) {
                        console.error("Image upload failed:", e);
                        this.showToast("圖片上傳失敗。");
                    } finally {
                        this.isUploadingImage = false;
                        // 清空 file input 以便下次上傳同名檔案
                        event.target.value = null;
                    }
                },
                
                // ... (Utility methods: formatCurrency, clearAllData, openChartModal, closeChartModal) ...
                formatCurrency(value, currency = 'USD') { if (typeof value !== 'number' || isNaN(value)) return '0.00'; try { return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 2 }).format(value).replace(currency, '').trim(); } catch (e) { return value.toFixed(2); } },
                clearAllData() { this.trades = []; this.marketJournals = []; this.buyPlans = []; this.modelBooks = []; this.reflections = []; this.marketCompassLog = []; this.playbooks = []; this.selectedTradeId = null; this.selectedTrade = null; },
                openChartModal(url) { if(url) { this.modalImageUrl = url; this.isModalOpen = true; } },
                closeChartModal() { this.isModalOpen = false; this.modalImageUrl = ''; },

                // --- Form Reset Methods (v8.0) ---
                resetAllForms() {
                    this.resetForm();
                    this.resetMarketJournalForm();
                    this.resetBuyPlanForm();
                    this.resetModelBookForm();
                    this.resetReflectionForm();
                    this.resetPlaybookForm(); // v3.2
                },
                getBlankForm() { return { entryDate: new Date().toISOString().split('T')[0], ticker: '', direction: 'Long', riskPercent: 1.0, riskAmount: null, setup: '', rationale: '', chartImage: '', transactions: [] }; },
                resetForm() { this.editingTradeId = null; this.journalForm = this.getBlankForm(); },
                getBlankMarketJournalForm() { return { date: new Date().toISOString().split('T')[0], marketSummary: '', leadingSectors: '', watchlist: '', mindset: '', sentiment: 3, summary: '' }; },
                resetMarketJournalForm() { this.editingMarketJournalId = null; this.marketJournalForm = this.getBlankMarketJournalForm(); },
                getBlankBuyPlanForm() { return { name: '', ticker: '', sector: '', pattern: '', pivot: null, stopLoss: null, target: null, rationale: '', chartImage: '' }; },
                resetBuyPlanForm() { this.editingBuyPlanId = null; this.buyPlanForm = this.getBlankBuyPlanForm(); },
                getBlankModelBookForm() { return { name: '', ticker: '', market: '', year: new Date().getFullYear(), sector: '', pattern: '', performance: '', pivot: '', takeaways: '', chartImage: '' }; },
                resetModelBookForm() { this.editingModelBookId = null; this.modelBookForm = this.getBlankModelBookForm(); },
                getBlankReflectionForm() { return { date: new Date().toISOString().split('T')[0], problem: '', thoughts: '' }; },
                resetReflectionForm() { this.editingReflectionId = null; this.reflectionForm = this.getBlankReflectionForm(); },
                
                // v3.2 - Playbook CRUD
                getBlankPlaybookForm() { return { name: '', timeframe: '', marketCondition: '', entryCriteria: '', stopLossStrategy: '', profitTakingStrategy: '', notes: '', chartImage: '' }; },
                resetPlaybookForm() { this.editingPlaybookId = null; this.playbookForm = this.getBlankPlaybookForm(); },
                async savePlaybook() { await this.saveEntity('playbooks', this.editingPlaybookId, this.playbookForm); this.resetPlaybookForm(); },
                editPlaybook(playbook) { this.editingPlaybookId = playbook.id; this.playbookForm = { ...this.getBlankPlaybookForm(), ...playbook }; this.activeTab = 'playbook'; },
                async deletePlaybook(id) { await this.deleteEntity('playbooks', id); },
                handlePlaybookImageUpload(event) { this.handleImageUpload(event, this.playbookForm, 'playbooks'); },

                // ... (CRUD for MarketJournal, BuyPlan, ModelBook, Reflection) ...
                async saveMarketJournal() { await this.saveEntity('marketJournals', this.editingMarketJournalId, this.marketJournalForm); this.resetMarketJournalForm(); },
                async saveBuyPlan() { await this.saveEntity('buyPlans', this.editingBuyPlanId, this.buyPlanForm); this.resetBuyPlanForm(); },
                async saveModelBook() { await this.saveEntity('modelBooks', this.editingModelBookId, this.modelBookForm); this.resetModelBookForm(); },
                async saveReflection() { await this.saveEntity('reflections', this.editingReflectionId, this.reflectionForm); this.resetReflectionForm(); },
                async deleteMarketJournal(id) { await this.deleteEntity('marketJournals', id); },
                async deleteBuyPlan(id) { await this.deleteEntity('buyPlans', id); },
                async deleteModelBook(id) { await this.deleteEntity('modelBooks', id); },
                async deleteReflection(id) { await this.deleteEntity('reflections', id); },
                editMarketJournal(entry) { this.editingMarketJournalId = entry.id; this.marketJournalForm = { ...this.getBlankMarketJournalForm(), ...entry }; this.activeTab = 'marketJournal'; },
                editBuyPlan(plan) { this.editingBuyPlanId = plan.id; this.buyPlanForm = { ...this.getBlankBuyPlanForm(), ...plan }; this.activeTab = 'buyPlan'; },
                editModelBook(model) { this.editingModelBookId = model.id; this.modelBookForm = { ...this.getBlankModelBookForm(), ...model }; this.activeTab = 'modelBook'; },
                editReflection(entry) { this.editingReflectionId = entry.id; this.reflectionForm = { ...this.getBlankReflectionForm(), ...entry }; this.activeTab = 'reflection'; },
                
                // ... (Market Compass Methods) ...
                async setMarketCompass(market, sentiment) {
                    this.marketCompass[market] = sentiment;
                    await this.saveEntity('marketCompassLog', null, { market, sentiment, notes: `狀態更新為: ${sentiment}` });
                },
                async saveMarketCompassLog() {
                    if (!this.marketCompassLogForm.notes) return;
                    await this.saveEntity('marketCompassLog', null, { ...this.marketCompassLogForm, market: 'General' });
                    this.marketCompassLogForm.notes = '';
                },
                async deleteMarketCompassLog(id) { await this.deleteEntity('marketCompassLog', id); },

                // --- Journal Methods (v8.0) ---
                
                // v3.4 - Quick Sizer v2.0
                async fetchExchangeRates() {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        this.exchangeRates = { ...this.exchangeRates, ...data.rates };
                    } catch (error) {
                        console.warn('無法獲取實時匯率，將使用後備匯率:', error);
                        // Fallback rates are already set
                    }
                    this.updateQuickSizer(); // 更新一次
                },
                updateQuickSizer() {
                    const { usdPrincipal, displayCurrency } = this.settings;
                    const { riskPercent, stopLossPercent } = this.quickSizer;
                    const rate = this.exchangeRates[displayCurrency] || 1.0;

                    this.quickSizer.riskAmount = (usdPrincipal * (riskPercent / 100));
                    this.quickSizer.riskAmountConverted = this.quickSizer.riskAmount * rate;
                    
                    if (stopLossPercent > 0) {
                        this.quickSizer.positionSize = this.quickSizer.riskAmount / (stopLossPercent / 100);
                        this.quickSizer.positionSizeConverted = this.quickSizer.positionSize * rate;
                    } else {
                        this.quickSizer.positionSize = 0;
                        this.quickSizer.positionSizeConverted = 0;
                    }
                },
                applyQuickSizer() {
                    this.journalForm.riskPercent = this.quickSizer.riskPercent;
                    this.journalForm.riskAmount = parseFloat(this.quickSizer.riskAmount.toFixed(2));
                    this.journalForm.stopLossPercent = this.quickSizer.stopLossPercent; // v8.0 - 順便也更新
                    this.showToast('注碼已套用至表單');
                },

                // Journal CRUD
                selectTrade(trade) {
                    this.selectedTradeId = trade.id;
                    this.selectedTrade = this.trades.find(t => t.id === trade.id);
                    this.resetTxnForm();
                },
                resetTxnForm() {
                    this.editingTxnId = null;
                    this.showTxnForm = false;
                    this.txnForm = { id: '', type: 'Buy', date: new Date().toISOString().split('T')[0], quantity: null, price: null, notes: '' };
                },
                async saveSubTransaction() {
                    if (!this.selectedTradeId || !this.userId) return;
                    const tradeRef = doc(this.db, `users/${this.userId}/trades`, this.selectedTradeId);
                    try {
                        if (this.editingTxnId) { // Update
                            const existingTxn = this.selectedTrade.transactions.find(t => t.id === this.editingTxnId);
                            const updatedTransactions = this.selectedTrade.transactions.map(t => t.id === this.editingTxnId ? this.txnForm : t);
                            await updateDoc(tradeRef, { transactions: updatedTransactions });
                        } else { // Add
                            this.txnForm.id = 'txn_' + Date.now();
                            await updateDoc(tradeRef, { transactions: arrayUnion(this.txnForm) });
                        }
                    } catch (e) {
                        // Firebase < 9 arrayUnion/arrayRemove are tricky. Fallback to full update.
                        console.warn("Array operation failed, trying full update:", e);
                        let transactions = [...(this.selectedTrade.transactions || [])];
                        if (this.editingTxnId) {
                            transactions = transactions.map(t => t.id === this.editingTxnId ? this.txnForm : t);
                        } else {
                            if (!this.txnForm.id) this.txnForm.id = 'txn_' + Date.now();
                            transactions.push(this.txnForm);
                        }
                        await updateDoc(tradeRef, { transactions });
                    }
                    this.resetTxnForm();
                },
                editSubTransaction(txn) {
                    this.editingTxnId = txn.id;
                    this.txnForm = { ...txn };
                    this.showTxnForm = true;
                },
                async deleteSubTransaction(txnId) {
                    if (!this.selectedTradeId || !this.userId || !confirm("確定要刪除這筆子交易嗎？")) return;
                    const tradeRef = doc(this.db, `users/${this.userId}/trades`, this.selectedTradeId);
                    const txnToDelete = this.selectedTrade.transactions.find(t => t.id === txnId);
                    if (txnToDelete) {
                        try {
                            await updateDoc(tradeRef, { transactions: arrayRemove(txnToDelete) });
                        } catch (e) {
                            console.warn("ArrayRemove failed, trying full update:", e);
                            const updatedTransactions = this.selectedTrade.transactions.filter(t => t.id !== txnId);
                            await updateDoc(tradeRef, { transactions: updatedTransactions });
                        }
                    }
                    this.resetTxnForm();
                },
                
                // v8.0 - 交易詳情計算
                getTradeDetails(trade) {
                    if (!trade) return { totalPl: 0, rMultiple: 0, status: 'N/A', holdingTime: 0 };
                    const txns = (trade.transactions || []).sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    let totalPl = 0;
                    let totalBuyCost = 0;
                    let totalSellValue = 0;
                    let totalBuyQty = 0;
                    let totalSellQty = 0;

                    txns.forEach(txn => {
                        const quantity = Number(txn.quantity) || 0;
                        const price = Number(txn.price) || 0;
                        if (txn.type === 'Buy') {
                            totalBuyCost += quantity * price;
                            totalBuyQty += quantity;
                        } else { // Sell
                            totalSellValue += quantity * price;
                            totalSellQty += quantity;
                        }
                    });

                    const avgBuyPrice = totalBuyQty > 0 ? totalBuyCost / totalBuyQty : 0;
                    const avgSellPrice = totalSellQty > 0 ? totalSellValue / totalSellQty : 0;

                    if (trade.direction === 'Long') {
                        // 假設 FIFO 或平均成本
                        // 簡化：如果已平倉，P/L 是總賣出 - 總買入。如果未平倉...
                        // 為了P/L曲線，我們只計算已實現的盈虧
                        const realizedQty = Math.min(totalBuyQty, totalSellQty);
                        totalPl = (avgSellPrice - avgBuyPrice) * realizedQty;
                    } else { // Short
                        const realizedQty = Math.min(totalBuyQty, totalSellQty);
                        totalPl = (avgSellPrice - avgBuyPrice) * realizedQty;
                    }
                    
                    const status = (totalBuyQty === totalSellQty) && totalBuyQty > 0 ? 'Closed' : 'Open';
                    const rMultiple = (trade.riskAmount > 0 && status === 'Closed') ? totalPl / trade.riskAmount : 0;

                    // 持倉時間
                    let holdingTime = 0;
                    if (status === 'Closed' && txns.length > 0) {
                        const entryDate = new Date(trade.entryDate);
                        const closeDate = new Date(txns[txns.length - 1].date);
                        holdingTime = Math.max(1, Math.round((closeDate - entryDate) / (1000 * 60 * 60 * 24)));
                    }

                    return { totalPl, rMultiple, status, holdingTime, entryDate: trade.entryDate, closeDate: status === 'Closed' ? txns[txns.length - 1].date : null };
                },
                
                async saveTrade() { await this.saveEntity('trades', this.editingTradeId, this.journalForm); this.resetForm(); },
                editTrade(trade) { this.editingTradeId = trade.id; this.journalForm = { ...this.getBlankForm(), ...trade, transactions: trade.transactions || [] }; },
                async deleteTrade(id) { if(this.selectedTradeId === id) { this.selectedTradeId = null; this.selectedTrade = null; } await this.deleteEntity('trades', id, "確定要刪除整個主交易及其所有子記錄嗎？"); },
                
                // --- Search ---
                search() {
                    if (!this.searchTerm) return this.searchResults = [];
                    const term = this.searchTerm.toLowerCase();
                    const tradeResults = this.trades.filter(t => t.ticker.toLowerCase().includes(term) || (t.setup && t.setup.toLowerCase().includes(term))).map(t => ({...t, type: '交易日誌', date: t.entryDate}));
                    const modelResults = this.modelBooks.filter(m => m.name.toLowerCase().includes(term) || m.ticker.toLowerCase().includes(term) || m.pattern.toLowerCase().includes(term)).map(m => ({...m, type: '模型庫'}));
                    this.searchResults = [...tradeResults, ...modelResults].slice(0, 10);
                },
                goToSearchResult(item) {
                    if (item.type === '交易日誌') { this.activeTab = 'journal'; this.selectTrade(item); } 
                    else if (item.type === '模型庫') { this.activeTab = 'modelBook'; this.editModelBook(item); }
                    this.searchTerm = ''; this.searchResults = [];
                },

                // --- Chart Methods (v8.0) ---
                renderAllCharts() {
                    this.renderPlChart('plChart');
                    this.renderPlChart('dashboardPlChart');
                    this.renderHexagonScoreChart();
                },
                renderPlChart(canvasId) {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const isDark = document.documentElement.classList.contains('dark');
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    const textColor = isDark ? '#9ca3af' : '#4b5563';

                    const closedTrades = this.trades
                        .map(t => this.getTradeDetails(t))
                        .filter(t => t.status === 'Closed')
                        .sort((a,b) => new Date(a.entryDate) - new Date(b.entryDate));
                    
                    let chartInstance = (canvasId === 'plChart') ? this.plChart : this.dashboardPlChart;
                    if (chartInstance) chartInstance.destroy();
                    
                    if (closedTrades.length === 0) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = textColor;
                        ctx.textAlign = 'center';
                        ctx.font = '16px "Inter", "Noto Sans TC"';
                        ctx.fillText('暫無已平倉交易數據', canvas.width / 2, canvas.height / 2);
                        return;
                    }

                    let cumulativePl = 0;
                    const dataPoints = [0].concat(closedTrades.map(t => cumulativePl += t.totalPl));

                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Start'].concat(closedTrades.map((t, i) => `T${i+1}`)),
                            datasets: [{
                                label: '累計盈虧 (USD)',
                                data: dataPoints,
                                borderColor: 'rgba(59, 130, 246, 0.8)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { ticks: { color: textColor }, grid: { color: gridColor } },
                                x: { ticks: { color: textColor }, grid: { color: gridColor } }
                            },
                            plugins: {
                                legend: { labels: { color: textColor } },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `累計盈虧: ${this.formatCurrency(context.parsed.y)}`
                                    }
                                }
                            }
                        }
                    });
                    
                    if (canvasId === 'plChart') this.plChart = chartInstance;
                    else this.dashboardPlChart = chartInstance;
                },
                renderHexagonScoreChart() {
                    const canvas = document.getElementById('hexagonScoreChart');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const isDark = document.documentElement.classList.contains('dark');
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';
                    const textColor = isDark ? '#9ca3af' : '#4b5563';
                    
                    if (this.hexagonScoreChart) this.hexagonScoreChart.destroy();
                    
                    const scores = this.metrics.scores;
                    const data = [
                        scores.winRate,
                        scores.profitFactor,
                        scores.avgWinLossRatio,
                        scores.maxDrawdown,
                        scores.recoveryFactor,
                        scores.consistency
                    ];

                    this.hexagonScoreChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['勝率', '利潤因子', '盈虧比', '回撤控制', '恢復因子', '一致性'],
                            datasets: [{
                                label: '交易者評分',
                                data: data,
                                fill: true,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: gridColor },
                                    grid: { color: gridColor },
                                    pointLabels: { color: textColor, font: { size: 12 } },
                                    ticks: {
                                        color: textColor,
                                        backdropColor: 'transparent',
                                        stepSize: 25,
                                        font: { size: 10 }
                                    },
                                    min: 0,
                                    max: 100
                                }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                },

                // --- Calendar Methods (v2.3) ---
                generateCalendar() {
                    const year = this.calendar.year;
                    const month = this.calendar.month;
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startDayOfWeek = firstDay.getDay();
                    
                    const days = [];
                    // Previous month's days
                    for (let i = startDayOfWeek; i > 0; i--) {
                        const date = new Date(year, month, 1 - i);
                        days.push({ date: date.toISOString().split('T')[0], dayOfMonth: date.getDate(), isCurrentMonth: false, pl: 0, tradeCount: 0 });
                    }
                    // Current month's days
                    for (let i = 1; i <= daysInMonth; i++) {
                        const date = new Date(year, month, i);
                        days.push({ date: date.toISOString().split('T')[0], dayOfMonth: i, isCurrentMonth: true, isToday: date.toDateString() === new Date().toDateString(), pl: 0, tradeCount: 0 });
                    }
                    // Next month's days (fill up to 6 weeks)
                    const totalCells = days.length;
                    const remainingCells = (totalCells > 35 ? 42 : 35) - totalCells;
                    for (let i = 1; i <= remainingCells; i++) {
                        const date = new Date(year, month + 1, i);
                        days.push({ date: date.toISOString().split('T')[0], dayOfMonth: i, isCurrentMonth: false, pl: 0, tradeCount: 0 });
                    }

                    // Populate with trade data (based on close date)
                    this.trades.forEach(trade => {
                        const details = this.getTradeDetails(trade);
                        if (details.status === 'Closed' && details.closeDate) {
                            const day = days.find(d => d.date === details.closeDate);
                            if (day) {
                                // 這裡假設 P/L 歸屬於平倉日
                                // 注意：原 v4 邏輯是按每筆 txn 計算，v8 改為按主交易平倉日計算
                                // 為了簡化，我們只在第一次遇到該日的平倉時增加 P/L
                                // 一個更準確的邏輯是按 txn.date 累加
                                // 我們暫時保留按 txn.date 累加的邏輯，以保持與 v4 的一致性
                            }
                        }
                    });
                    
                    // 重置 P/L
                    days.forEach(d => { d.pl = 0; d.tradeCount = 0; });
                    
                    // v4 的 P/L 計算邏輯 (按子交易日)
                    this.trades.forEach(trade => {
                        (trade.transactions || []).forEach(txn => {
                            if (txn.type === 'Sell') {
                                const day = days.find(d => d.date === txn.date);
                                if (day) {
                                    // 找到這筆 txn 對應的 P/L (這很複雜，需要FIFO)
                                    // 簡化：我們只在 v8.0 getTradeDetails 裡計算總 P/L
                                    // 為了日曆，我們需要一個按日 P/L。
                                    // 暫時使用一個簡化邏輯：將平倉日的總P/L歸屬到最後一個txn日期
                                    const details = this.getTradeDetails(trade);
                                    if (details.status === 'Closed' && txn.date === details.closeDate) {
                                        // 僅在最後一筆交易日累加一次總P/L
                                        // 檢查是否已累加
                                        if (!day.tradesProcessed?.includes(trade.id)) {
                                            day.pl += details.totalPl;
                                            day.tradeCount += 1;
                                            if (!day.tradesProcessed) day.tradesProcessed = [];
                                            day.tradesProcessed.push(trade.id);
                                        }
                                    }
                                }
                            }
                        });
                    });

                    this.calendar.days = days;
                },
                changeMonth(delta) {
                    let newMonth = this.calendar.month + delta;
                    let newYear = this.calendar.year;
                    if (newMonth > 11) { newMonth = 0; newYear++; }
                    if (newMonth < 0) { newMonth = 11; newYear--; }
                    this.calendar.month = newMonth;
                    this.calendar.year = newYear;
                },
                goToToday() {
                    this.calendar.year = new Date().getFullYear();
                    this.calendar.month = new Date().getMonth();
                },
                
                // --- TradingView Methods (v5.2) ---
                getTvTheme() {
                    return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                },
                loadTickerTapeWidget() {
                    const theme = this.getTvTheme();
                    const container = document.getElementById('tv-ticker-tape-container');
                    if (!container) return;
                    container.innerHTML = ''; // 清空
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
                    script.async = true;
                    script.text = JSON.stringify({
                        "symbols": [ { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" }, { "proName": "FOREXCOM:NSXUSD", "title": "US 100" }, { "proName": "FX_IDC:EURUSD", "title": "EUR/USD" }, { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" }, { "proName": "BITSTAMP:ETHUSD", "title": "Ethereum" }, { "proName": "HSI:HSI", "title": "Hang Seng" } ],
                        "showSymbolLogo": true,
                        "colorTheme": theme,
                        "isTransparent": true,
                        "displayMode": "adaptive",
                        "locale": "zh_TW"
                    });
                    container.appendChild(script);
                },
                loadTradingViewWidgets() {
                    if (this.tvWidgetsLoaded || this.activeTab !== 'tradingView') return;
                    
                    const theme = this.getTvTheme();
                    
                    // 1. Advanced Chart
                    const chartContainer = document.getElementById('tv-advanced-chart-container');
                    if (chartContainer) {
                        chartContainer.innerHTML = '';
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                        script.async = true;
                        script.text = JSON.stringify({
                            "allow_symbol_change": true, "calendar": false, "details": true, "hide_side_toolbar": false,
                            "hide_top_toolbar": false, "hide_legend": false, "hide_volume": false, "hotlist": true,
                            "interval": "D", "locale": "zh_TW", "save_image": true, "style": "1", "symbol": "NASDAQ:AAPL",
                            "theme": theme, "timezone": "Etc/UTC", "watchlist": [], "withdateranges": true, "range": "YTD",
                            "studies": [], "autosize": true
                        });
                        chartContainer.appendChild(script);
                    }
                    
                    // 2. Heatmap
                    const heatmapContainer = document.getElementById('tv-heatmap-container');
                    if (heatmapContainer) {
                        heatmapContainer.innerHTML = '';
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
                        script.async = true;
                        script.text = JSON.stringify({
                            "dataSource": "SPX500", "blockSize": "market_cap_basic", "blockColor": "change",
                            "grouping": "sector", "locale": "zh_TW", "symbolUrl": "", "colorTheme": theme,
                            "exchanges": [], "hasTopBar": true, "isDataSetEnabled": true, "isZoomEnabled": true,
                            "hasSymbolTooltip": true, "isMonoSize": false, "width": "100%", "height": "100%"
                        });
                        heatmapContainer.appendChild(script);
                    }

                    // 3. Timeline
                    const timelineContainer = document.getElementById('tv-timeline-container');
                    if (timelineContainer) {
                        timelineContainer.innerHTML = '';
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-timeline.js';
                        script.async = true;
                        script.text = JSON.stringify({
                            "displayMode": "regular", "feedMode": "all_symbols", "colorTheme": theme,
                            "isTransparent": false, "locale": "zh_TW", "width": "100%", "height": "100%"
                        });
                        timelineContainer.appendChild(script);
                    }
                    
                    this.tvWidgetsLoaded = true;
                },
                unloadTradingViewWidgets() {
                    const ids = ['tv-advanced-chart-container', 'tv-heatmap-container', 'tv-timeline-container'];
                    ids.forEach(id => {
                        const container = document.getElementById(id);
                        if (container) container.innerHTML = '';
                    });
                    this.tvWidgetsLoaded = false;
                },
                reloadTradingViewWidgets() {
                    // Ticker Tape 總是重載
                    this.loadTickerTapeWidget();
                    
                    // 僅當 'tradingView' 標籤頁活動時才重載
                    if (this.activeTab === 'tradingView') {
                        this.unloadTradingViewWidgets();
                        // 稍微延遲以確保 DOM 清理完畢
                        setTimeout(() => this.loadTradingViewWidgets(), 100);
                    }
                },

                // --- All AI Methods (v8.0) ---
                
                async callAiApi(systemPrompt, userQuery, context, formatHtml = true, isJsonOutput = false) {
                    this.isLoading = true;
                    this.aiAnalysisContext = context;
                    let resultText = '';
                    
                    // v8.0 附帶個人化記憶
                    const personalization = `
                        用戶技術分析偏好 (用於 swing trading):
                        - 移動平均線: MA10, MA20, MA50, MA150, MA200
                        - 支撐/阻力: 來自均線和 K 線
                        - 量能分析
                        - 型態: 旗形 (Flag patterns), 回檔買入 (Pullback buys)
                    `;
                    systemPrompt = systemPrompt + "\n\n" + personalization;

                    try {
                        if (this.settings.aiProvider === 'custom' && this.settings.customApiKey) {
                            resultText = await this.callCustomApi(systemPrompt, userQuery, isJsonOutput);
                        } else {
                            // 預設使用 Gemini
                            resultText = await this.callGeminiApi(systemPrompt, userQuery, isJsonOutput);
                        }
                    } catch (error) {
                        console.error('AI API Call failed:', error);
                        resultText = `與 AI API 通訊時發生錯誤: ${error.message}`;
                        formatHtml = true; // 錯誤總是格式化
                    } finally {
                        this.isLoading = false;
                        this.aiAnalysisContext = '';
                        if (formatHtml && !isJsonOutput) {
                            // 簡易 Markdown 轉換
                            return resultText
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                                .replace(/`(.*?)`/g, '<code>$1</code>')
                                .replace(/\n/g, '<br>');
                        }
                        return resultText;
                    }
                },
                async callGeminiApi(systemPrompt, userQuery, isJsonOutput) {
                    // Gemini API Key - 留空以使用內建代理
                    const apiKey = ""; // AIza...
                    if (!apiKey) {
                        console.warn("使用內建 API 代理 (如果可用的話)。如果失敗，請填入您自己的 Gemini API Key。");
                    }
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    
                    if (isJsonOutput) {
                        payload.generationConfig = { responseMimeType: "application/json" };
                    }
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`Gemini API 請求失敗，狀態: ${response.status}`);
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error('無法從 Gemini 獲取有效的分析結果。');
                    return text;
                },
                async callCustomApi(systemPrompt, userQuery, isJsonOutput) {
                    const apiUrl = this.settings.customApiUrl || 'https://api.openai.com/v1/chat/completions';
                    const payload = {
                        model: "gpt-4-turbo", // 假設
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userQuery }
                        ]
                    };
                    
                    if (isJsonOutput) {
                        payload.response_format = { type: "json_object" };
                    }
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.settings.customApiKey}`
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`自訂 API 請求失敗，狀態: ${response.status}`);
                    
                    const result = await response.json();
                    const text = result.choices?.[0]?.message?.content;
                    if (!text) throw new Error('無法從自訂 API 獲取有效的分析結果。');
                    return text;
                },

                // --- AI Prompt Methods (v8.0) ---
                
                async getAiDashboardSummary() {
                    const { system, user } = this.getAiPrompts('dashboardSummary');
                    this.aiDashboardSummary = await this.callAiApi(system, user, 'dashboard');
                },
                async askAi() {
                    if(!this.aiQuery) return;
                    const query = this.aiQuery;
                    this.aiQuery = '';
                    this.aiDashboardSummary = `<blockquote><strong>你的提問:</strong> ${query}</blockquote><br><p>AI 正在思考中...</p>`;
                    
                    const { system, user } = this.getAiPrompts('dashboardChat', query);
                    const answer = await this.callAiApi(system, user, 'dashboard');
                    this.aiDashboardSummary = `<blockquote><strong>你的提問:</strong> ${query}</blockquote><br>${answer}`;
                },
                async getAiAnalysis() {
                    const { system, user } = this.getAiPrompts('calculator');
                    this.aiAnalysisResult = await this.callAiApi(system, user, 'calculator');
                },
                async getAiDrawdownAnalysis() {
                    const { system, user } = this.getAiPrompts('drawdown');
                    this.maxDrawdownAnalysis = await this.callAiApi(system, user, 'drawdown');
                },
                async getAiEmotionAnalysis() {
                    const { system, user } = this.getAiPrompts('emotion');
                    this.aiEmotionAnalysisResult = await this.callAiApi(system, user, 'emotion');
                },
                async getAiModelBookAnalysis() {
                    const { system, user } = this.getAiPrompts('modelBook');
                    this.aiModelBookAnalysis = await this.callAiApi(system, user, 'modelBook');
                },
                async getAiPerformanceReview() {
                    const { system, user } = this.getAiPrompts('review');
                    // 必須是 JSON 輸出
                    const reviewJson = await this.callAiApi(system, user, 'review', false, true);
                    try {
                        let parsed;
                        // 處理 Gemini 可能返回的 ```json ... ```
                        if (reviewJson.includes('```json')) {
                            parsed = JSON.parse(reviewJson.match(/\{[\s\S]*\}/)[0]);
                        } else {
                            parsed = JSON.parse(reviewJson);
                        }
                        this.reviewNotes.monthly = parsed.monthlyPerformance || 'N/A';
                        this.reviewNotes.improve = parsed.areasToImprove || 'N/A';
                        this.reviewNotes.goals = parsed.nextMonthGoals || 'N/A';
                    } catch(e) {
                        console.error("AI Review JSON parse error:", e, reviewJson);
                        this.reviewNotes.monthly = "AI 回應格式錯誤。請重試。";
                        this.reviewNotes.improve = "";
                        this.reviewNotes.goals = "";
                    }
                },

                // v8.0 - 統一的 AI Prompt 管理
                getAiPrompts(type, query = '') {
                    const systemBase = "你是一位專業的交易心理與績效分析教練。請使用繁體中文回答。你的分析應簡潔、深入且具有可操作性。";
                    const data = {
                        metrics: this.metrics,
                        trades: this.trades.map(t => ({...this.getTradeDetails(t), setup: t.setup, rationale: t.rationale})),
                        playbooks: this.playbooks,
                        models: this.modelBooks,
                        reflections: this.reflections
                    };

                    switch(type) {
                        case 'dashboardSummary':
                            return {
                                system: systemBase + " 分析儀表板的總體數據，提供 3 個關鍵的總結點。",
                                user: `這是我的儀表板數據: ${JSON.stringify(data.metrics)}`
                            };
                        case 'dashboardChat':
                            return {
                                system: systemBase + " 根據用戶的完整交易數據回答問題。",
                                user: `這是我的數據: ${JSON.stringify(data)} \n\n我的問題是: ${query}`
                            };
                        case 'calculator':
                            return {
                                system: systemBase + " 分析這個注碼設定。判斷這個風險是否合理。",
                                user: `我的設定: ${JSON.stringify({principal: this.settings.usdPrincipal, riskPercent: this.currentRiskPercent, stopLoss: this.stopLossPercent})}`
                            };
                        case 'drawdown':
                            return {
                                system: systemBase + " 分析最大回撤數據。是什麼導致了這次回撤？提供 2 個避免未來發生同樣情況的建議。",
                                user: `我的最大回撤數據: ${JSON.stringify(data.metrics.maxDrawdown)} \n\n 相關的交易 (P/L): ${JSON.stringify(data.trades.map(t => t.totalPl))}`
                            };
                        case 'emotion':
                            return {
                                system: systemBase + " 分析用戶的「自我反思」和交易P/L之間的關聯。找出情緒模式。",
                                user: `我的反思: ${JSON.stringify(data.reflections)} \n\n 我的交易: ${JSON.stringify(data.trades.map(t => ({r: t.rMultiple, setup: t.setup})))}`
                            };
                        case 'modelBook':
                            return {
                                system: systemBase + " 分析這些成功的「模型庫」案例。總結出 3 個共通的技術特徵 (例如均線、型態)。",
                                user: `我的模型庫: ${JSON.stringify(data.models)}`
                            };
                        case 'review':
                            return {
                                system: systemBase + " 產生一份 JSON 格式的月度回顧報告，包含 'monthlyPerformance', 'areasToImprove', 'nextMonthGoals' 三個鍵。",
                                user: `我的績效數據: ${JSON.stringify(data.metrics)} \n\n 最近的交易: ${JSON.stringify(data.trades.slice(-20))}`
                            };
                        default:
                            return { system: systemBase, user: query };
                    }
                }
                
                // --- 結束符 ---
            }
        }
        
        Alpine.data('tradingApp', tradingApp);
        Alpine.start();
    </script>
</body>
</html>

