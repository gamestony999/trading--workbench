<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“å·¥ä½œå° (AI å°ˆæ¥­ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .input-group { display: flex; align-items: center; background-color: #374151; border-radius: 0.5rem; border: 1px solid #4b5563; }
        .input-group span { padding-left: 0.75rem; color: #9ca3af; }
        .input-group input, .input-group select, .input-group textarea { background-color: transparent; border: none; outline: none; width: 100%; padding: 0.75rem; color: white; }
        .risk-btn, .tab-btn { transition: all 0.2s ease-in-out; padding: 0.75rem 1rem; border-bottom: 2px solid transparent; white-space: nowrap; font-size: 0.875rem; font-weight: 500; color: #9ca3af; }
        .tab-btn:hover { color: white; border-color: #4b5563; }
        .tab-btn.active { background-color: #3b82f6; color: white; font-weight: 600; border-color: #3b82f6; }
        [x-cloak] { display: none !important; }
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.75); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; max-width: 90vw; max-height: 90vh; overflow: auto; }
        .playbook-card { transition: transform 0.2s, box-shadow 0.2s; }
        .playbook-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1), 0 4px 6px -2px rgba(59, 130, 246, 0.05); }
        .search-input { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 12px center; padding-left: 40px; }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8" x-data="tradingApp()">

    <div x-show="!isInitialized" class="min-h-screen flex items-center justify-center text-center">
        <div>
            <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-gray-400">æ­£åœ¨é€£æ¥é›²ç«¯...</p>
        </div>
    </div>

    <div x-show="isInitialized && !isLoggedIn" x-cloak class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
            <h2 class="text-2xl font-bold text-center text-blue-400 mb-6" x-text="authView === 'login' ? 'ç™»å…¥å·¥ä½œå°' : 'è¨»å†Šæ–°å¸³è™Ÿ'"></h2>
            <form @submit.prevent="authView === 'login' ? login() : register()">
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300">é›»å­éƒµä»¶</label>
                        <input id="email" type="email" x-model="authForm.email" required class="w-full bg-gray-700 rounded p-2 mt-1 border border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-300">å¯†ç¢¼</label>
                        <input id="password" type="password" x-model="authForm.password" required class="w-full bg-gray-700 rounded p-2 mt-1 border border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <p x-show="authError" class="text-red-400 text-sm mt-4" x-text="authError"></p>
                <div class="mt-6">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="authView === 'login' ? 'ç™»å…¥' : 'è¨»å†Š'"></button>
                </div>
            </form>

            <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400">æˆ–</span></div></div>

            <div>
                <button @click.prevent="loginWithGoogle()" class="w-full inline-flex justify-center py-2 px-4 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg>
                    <span>ä½¿ç”¨ Google ç™»å…¥</span>
                </button>
            </div>

            <div class="mt-4 text-center"><button @click="authView = (authView === 'login' ? 'register' : 'login')" class="text-sm text-gray-400 hover:text-white" x-text="authView === 'login' ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šä¸€å€‹' : 'å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿå‰å¾€ç™»å…¥'"></button></div>
        </div>
    </div>

    <div x-show="isInitialized && isLoggedIn" x-cloak class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                 <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-blue-400">äº¤æ˜“å·¥ä½œå° âœ¨</h1>
                    <p class="text-gray-400 mt-2">ç”± AI é©…å‹•çš„æ•´åˆå¼äº¤æ˜“åˆ†æç³»çµ±</p>
                 </div>
                 <div class="relative w-full md:w-1/3">
                    <input type="text" x-model="searchTerm" @input.debounce.300ms="search" placeholder="æœå°‹äº¤æ˜“æ—¥èªŒæˆ–æ¨¡å‹åº«..." class="search-input w-full bg-gray-800 border border-gray-700 rounded-full py-2 px-4 text-white focus:ring-blue-500 focus:border-blue-500">
                    <div x-show="searchTerm && searchResults.length > 0" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg max-h-80 overflow-y-auto">
                        <ul>
                            <template x-for="item in searchResults" :key="item.id">
                                <li @click="goToSearchResult(item)" class="px-4 py-3 hover:bg-gray-700 cursor-pointer">
                                    <p class="font-semibold text-white" x-text="item.ticker || item.name"></p>
                                    <p class="text-sm text-gray-400" x-text="`${item.type} - ${item.date || item.pattern}`"></p>
                                </li>
                            </template>
                        </ul>
                    </div>
                 </div>
            </div>
            <p class="text-xl text-yellow-400 mt-4 font-bold text-center max-w-3xl mx-auto">
                "é•·æœŸï¼ˆ10 è¬æ¬¡äº¤æ˜“ï¼‰ â†’ å€‹åˆ¥è¼¸è´å®Œå…¨ä¸é‡è¦ï¼ŒçœŸæ­£çš„è¼¸è´ä¾†è‡ªã€Œæ¬¡æ•¸ + ç´€å¾‹ã€çš„è¤‡åˆ©åŠç²¾æº–è²·å…¥é»ã€‚"
            </p>
            <div class="tradingview-widget-container mt-4">
              <div class="tradingview-widget-container__widget"></div>
              <div class="tradingview-widget-copyright"><a href="https://tw.tradingview.com/markets/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
              {
                "symbols": [
                  { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500 Index" },
                  { "proName": "FOREXCOM:NSXUSD", "title": "US 100 Cash CFD" },
                  { "proName": "FX_IDC:EURUSD", "title": "EUR to USD" },
                  { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" },
                  { "proName": "BITSTAMP:ETHUSD", "title": "Ethereum" },
                  { "proName": "HSI:HSI", "title": "Hang Seng Index" }
                ],
                "colorTheme": "dark", "locale": "zh_TW", "largeChartUrl": "",
                "isTransparent": false, "showSymbolLogo": false, "displayMode": "adaptive"
              }
              </script>
            </div>
            </header>

        <div class="mb-6">
            <div class="border-b border-gray-700">
                 <nav class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto" aria-label="Tabs">
                    <button @click="activeTab = 'dashboard'" :class="{ 'active': activeTab === 'dashboard' }" class="tab-btn">å„€è¡¨æ¿</button>
                    <button @click="activeTab = 'tradingView'" :class="{ 'active': activeTab === 'tradingView' }" class="tab-btn">å¸‚å ´åœ–è¡¨</button>
                    <button @click="activeTab = 'reflection'" :class="{ 'active': activeTab === 'reflection' }" class="tab-btn">è‡ªæˆ‘åæ€</button>
                    <button @click="activeTab = 'marketJournal'" :class="{ 'active': activeTab === 'marketJournal' }" class="tab-btn">å¸‚å ´æ—¥èªŒ</button>
                    <button @click="activeTab = 'buyPlan'" :class="{ 'active': activeTab === 'buyPlan' }" class="tab-btn">è²·å…¥è¨ˆåŠƒ</button>
                    <button @click="activeTab = 'calculator'" :class="{ 'active': activeTab === 'calculator' }" class="tab-btn">æ³¨ç¢¼è¨ˆç®—æ©Ÿ</button>
                    <button @click="activeTab = 'journal'" :class="{ 'active': activeTab === 'journal' }" class="tab-btn">äº¤æ˜“æ—¥èªŒ</button>
                    <button @click="activeTab = 'modelBook'" :class="{ 'active': activeTab === 'modelBook' }" class="tab-btn">æ¨¡å‹åº«</button>
                    <button @click="activeTab = 'performance'" :class="{ 'active': activeTab === 'performance' }" class="tab-btn">ç¸¾æ•ˆå›é¡§</button>
                    <button @click="activeTab = 'settings'" :class="{ 'active': activeTab === 'settings' }" class="tab-btn">è¨­å®š</button>
                </nav>
            </div>
        </div>
        
        <div class="flex justify-between items-center text-center mb-4 text-xs text-gray-500">
            <p>User ID: <span x-text="userId || 'N/A'"></span></p>
            <button @click="logout()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-lg text-xs">ç™»å‡º</button>
        </div>
        
        <div x-show="activeTab === 'dashboard'" x-cloak>
            <div class="space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                     <div>
                        <h2 class="text-2xl font-semibold mb-4 text-blue-300">æ ¸å¿ƒç¸¾æ•ˆ</h2>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">å‹ç‡</h3><p class="mt-2 text-3xl font-bold" x-text="`${performance.winRate.toFixed(2)}%`"></p></div>
                            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">ç¸½ç›ˆè™§</h3><p class="mt-2 text-3xl font-bold" :class="performance.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(performance.totalPl, 'USD')"></p></div>
                            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">å¹³å‡ R å€¼</h3><p class="mt-2 text-3xl font-bold" :class="performance.avgR >= 0 ? 'text-green-400' : 'text-red-400'" x-text="`${performance.avgR.toFixed(2)} R`"></p></div>
                            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">ç¸½äº¤æ˜“æ•¸</h3><p class="mt-2 text-3xl font-bold" x-text="performance.totalTrades"></p></div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-300">è¿‘æœŸåæ€</h2>
                        <div class="bg-gray-700/50 p-4 rounded-lg min-h-[150px] flex items-center justify-center">
                            <template x-if="latestReflection">
                                <div class="text-left w-full">
                                    <p class="text-sm text-gray-400" x-text="latestReflection.date"></p>
                                    <p class="text-lg font-bold mt-2 text-yellow-300" x-text="latestReflection.problem"></p>
                                    <p class="text-sm mt-2 text-gray-300" x-text="latestReflection.thoughts.substring(0, 100) + (latestReflection.thoughts.length > 100 ? '...' : '')"></p>
                                </div>
                            </template>
                             <div x-show="!latestReflection" class="text-gray-500">
                                <p>æš«ç„¡åæ€è¨˜éŒ„ï¼Œå¿«å»ã€Œè‡ªæˆ‘åæ€ã€åˆ†é æ–°å¢å§ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-blue-300">å¸‚å ´ç¾…ç›¤ (Market Compass)</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="tradingview-widget-container">
                              <div class="tradingview-widget-container__widget"></div>
                              <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/markets/" rel="noopener nofollow" target="_blank"><span class="blue-text">Market summary</span></a> by TradingView</div>
                              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-quotes.js" async>
                              {
                                "colorTheme": "dark", "locale": "en", "largeChartUrl": "", "isTransparent": false,
                                "showSymbolLogo": true, "backgroundColor": "#1f2937", "width": "100%", "height": 450,
                                "symbolsGroups": [
                                  { "name": "Indices", "symbols": [ { "name": "FOREXCOM:SPXUSD", "displayName": "S&P 500" }, { "name": "FOREXCOM:NSXUSD", "displayName": "US 100" }, { "name": "FOREXCOM:DJI", "displayName": "Dow 30" }, { "name": "INDEX:NKY", "displayName": "Nikkei 225" }, { "name": "INDEX:DEU40", "displayName": "DAX" }, { "name": "FOREXCOM:UKXGBP", "displayName": "UK 100" }, { "name": "HSI:HSI", "displayName": "Hang Seng" } ] },
                                  { "name": "Futures", "symbols": [ { "name": "CME_MINI:ES1!", "displayName": "S&P 500" }, { "name": "CME:6E1!", "displayName": "Euro" }, { "name": "COMEX:GC1!", "displayName": "Gold" }, { "name": "NYMEX:CL1!", "displayName": "Crude Oil" }, { "name": "CBOT:ZS1!", "displayName": "Soybeans" } ] },
                                  { "name": "Bonds", "symbols": [ { "name": "CBOT:ZB1!", "displayName": "T-Bond" }, { "name": "CBOT:ZN1!", "displayName": "10-Year T-Note" }, { "name": "CBOT:ZF1!", "displayName": "5-Year T-Note" } ] },
                                  { "name": "Forex", "symbols": [ { "name": "FX:EURUSD", "displayName": "EUR/USD" }, { "name": "FX:GBPUSD", "displayName": "GBP/USD" }, { "name": "FX:USDJPY", "displayName": "USD/JPY" }, { "name": "FX:USDCHF", "displayName": "USD/CHF" }, { "name": "FX:AUDUSD", "displayName": "AUD/USD" }, { "name": "FX:USDCAD", "displayName": "USD/CAD" } ] }
                                ]
                              }
                              </script>
                            </div>
                            </div>
                        <div class="lg:col-span-1">
                            <div class="tradingview-widget-container">
                              <div class="tradingview-widget-container__widget"></div>
                              <div class="tradingview-widget-copyright"><a href="https://tw.tradingview.com/economic-calendar/" rel="noopener nofollow" target="_blank"><span class="blue-text">Economic Calendar</span></a> by TradingView</div>
                              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                              {
                                "colorTheme": "dark", "isTransparent": false, "locale": "zh_TW",
                                "countryFilter": "ar,au,br,ca,cn,fr,de,in,id,it,jp,kr,mx,ru,sa,za,tr,gb,us,eu",
                                "importanceFilter": "-1,0,1", "width": "100%", "height": 450
                              }
                              </script>
                            </div>
                            </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-lg font-bold text-center mb-4">ç¾è‚¡å¸‚å ´</h3><div class="flex justify-center gap-4"><button @click="setMarketCompass('US', 'Bull')" class="text-2xl px-6 py-3 rounded-lg bg-green-800 hover:bg-green-700">ğŸ‚</button><button @click="setMarketCompass('US', 'Bear')" class="text-2xl px-6 py-3 rounded-lg bg-red-800 hover:bg-red-700">ğŸ»</button><button @click="setMarketCompass('US', 'Neutral')" class="text-2xl px-6 py-3 rounded-lg bg-yellow-800 hover:bg-yellow-700">âš–ï¸</button></div></div>
                            <div class="bg-gray-800 p-6 rounded-xl"><h3 class="text-lg font-bold text-center mb-4">æ¸¯è‚¡å¸‚å ´</h3><div class="flex justify-center gap-4"><button @click="setMarketCompass('HK', 'Bull')" class="text-2xl px-6 py-3 rounded-lg bg-green-800 hover:bg-green-700">ğŸ‚</button><button @click="setMarketCompass('HK', 'Bear')" class="text-2xl px-6 py-3 rounded-lg bg-red-800 hover:bg-red-700">ğŸ»</button><button @click="setMarketCompass('HK', 'Neutral')" class="text-2xl px-6 py-3 rounded-lg bg-yellow-800 hover:bg-yellow-700">âš–ï¸</button></div></div>
                            <div class="mt-4 bg-gray-800 p-4 rounded-xl max-h-48 overflow-y-auto">
                                <template x-for="log in marketCompassLog" :key="log.id"><div class="text-sm text-gray-400 border-b border-gray-700/50 py-1" x-text="`${log.timestamp ? log.timestamp.toLocaleString() : ''} - ${log.market === 'US' ? 'ç¾è‚¡' : 'æ¸¯è‚¡'} å¸‚å ´åˆ¤æ–·ç‚º ${log.sentiment === 'Bull' ? 'ç‰›å¸‚' : log.sentiment === 'Bear' ? 'ç†Šå¸‚' : 'éœ‡ç›ª'}`"></div></template>
                                <p x-show="marketCompassLog.length === 0" class="text-gray-500 text-center py-4">æš«ç„¡ç¾…ç›¤è¨˜éŒ„</p>
                            </div>
                        </div>
                    </div>
                </div>

                 <div>
                    <h2 class="text-2xl font-semibold mb-4 text-blue-300">AI æ•¸æ“šç¸½çµèˆ‡å°è©±</h2>
                    <div class="bg-gray-800 p-6 rounded-xl">
                        <button @click="getAiDashboardSummary()" :disabled="isLoading" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">ç”¢ç”Ÿç¸½çµ</button>
                        <div x-show="isLoading && aiQuery === ''" class="text-center py-4"><p class="text-sm text-gray-400">AI ç¸½çµä¸­...</p></div>
                        <div x-show="aiDashboardSummary" x-html="aiDashboardSummary" class="mt-4 p-4 bg-gray-700/50 rounded-lg prose prose-sm prose-invert max-w-none"></div>
                        <div class="mt-6">
                            <form @submit.prevent="askAi" class="flex gap-4">
                                <input type="text" x-model="aiQuery" placeholder="å‘ AI æå•é—œæ–¼ä½ çš„äº¤æ˜“æ•¸æ“š..." class="w-full bg-gray-700 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                                <button type="submit" :disabled="isLoading || !aiQuery" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-5 rounded-lg disabled:opacity-50">ç™¼é€</button>
                            </form>
                        </div>
                    </div>
                 </div>

                 <div>
                    <h2 class="text-2xl font-semibold mb-4 text-blue-300">æœ€æ–°äº¤æ˜“è¨˜éŒ„</h2>
                    <div class="bg-gray-800 p-4 rounded-xl overflow-x-auto">
                         <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th class="px-4 py-3">æ—¥æœŸ</th><th class="px-4 py-3">ä»£è™Ÿ</th><th class="px-4 py-3">åœ–è¡¨</th><th class="px-4 py-3">æ–¹å‘</th><th class="px-4 py-3">æç›Š (P/L $)</th><th class="px-4 py-3">R å€æ•¸</th></tr></thead>
                            <tbody>
                                <template x-for="trade in trades.slice(0, 5)" :key="trade.id">
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="px-4 py-3" x-text="trade.date"></td><td class="px-4 py-3" x-text="trade.ticker"></td>
                                        <td class="px-4 py-3"><button x-show="trade.chartImage" @click="openChartModal(trade.chartImage)"><img :src="trade.chartImage" class="h-10 w-16 object-cover rounded-md hover:scale-110 transition-transform"/></button></td>
                                        <td class="px-4 py-3" x-text="trade.direction" :class="trade.direction === 'Long' ? 'text-green-400' : 'text-red-400'"></td>
                                        <td class="px-4 py-3 font-mono" x-text="formatCurrency(trade.plAmount, 'USD')" :class="trade.plAmount >= 0 ? 'text-green-400' : 'text-red-400'"></td>
                                        <td class="px-4 py-3 font-mono" x-text="trade.rMultiple.toFixed(2) + ' R'" :class="trade.rMultiple >= 0 ? 'text-green-400' : 'text-red-400'"></td>
                                    </tr>
                                </template>
                                 <tr x-show="trades.length === 0"><td colspan="6" class="text-center py-8 text-gray-500">æš«ç„¡äº¤æ˜“è¨˜éŒ„</td></tr>
                            </tbody>
                         </table>
                         <div class="text-center mt-4"><button @click="activeTab = 'journal'" class="text-blue-400 hover:underline text-sm">æŸ¥çœ‹æ‰€æœ‰äº¤æ˜“è¨˜éŒ„ &rarr;</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'tradingView'" x-cloak class="space-y-8">
            <div class="h-[70vh] bg-gray-800 rounded-xl">
                <div class="tradingview-widget-container" style="height:100%;width:100%">
                  <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                  <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/symbols/NASDAQ-AAPL/" rel="noopener nofollow" target="_blank"><span class="blue-text">AAPL stock chart</span></a><span class="trademark"> by TradingView</span></div>
                  <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                  {
                    "allow_symbol_change": true, "calendar": false, "details": true, "hide_side_toolbar": false,
                    "hide_top_toolbar": false, "hide_legend": false, "hide_volume": false, "hotlist": true,
                    "interval": "D", "locale": "zh_TW", "save_image": true, "style": "1",
                    "symbol": "NASDAQ:AAPL", "theme": "dark", "timezone": "Etc/UTC", "backgroundColor": "#1f2937",
                    "gridColor": "rgba(242, 242, 242, 0.06)", "watchlist": [], "withdateranges": true,
                    "range": "YTD", "studies": [], "autosize": true
                  }
                  </script>
                </div>
                </div>
    
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-blue-300">å¸‚å ´ç†±åœ– (Market Heatmap)</h2>
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <div class="tradingview-widget-copyright"><a href="https://tw.tradingview.com/heatmap/stock/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js" async>
                    {
                        "dataSource": "SPX500", "blockSize": "market_cap_basic", "blockColor": "change",
                        "grouping": "sector", "locale": "zh_TW", "symbolUrl": "", "colorTheme": "dark",
                        "exchanges": [], "hasTopBar": true, "isDataSetEnabled": true, "isZoomEnabled": true,
                        "hasSymbolTooltip": true, "isMonoSize": false, "width": "100%", "height": 700
                    }
                    </script>
                </div>
                </div>
    
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                     <h2 class="text-2xl font-semibold mb-4 text-blue-300">é ­æ¢æ–°è (Top Stories)</h2>
                    <div class="tradingview-widget-container" style="height: 600px;">
                      <div class="tradingview-widget-container__widget"></div>
                      <div class="tradingview-widget-copyright"><a href="https://tw.tradingview.com/news/top-providers/tradingview/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
                      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                      {
                        "displayMode": "regular", "feedMode": "all_symbols", "colorTheme": "dark",
                        "isTransparent": false, "locale": "zh_TW", "width": "100%", "height": "100%"
                      }
                      </script>
                    </div>
                    </div>
                <div>
                     <h2 class="text-2xl font-semibold mb-4 text-blue-300">å¸‚å ´æ–°è (Market News)</h2>
                    <div class="tradingview-widget-container" style="height: 600px;">
                      <div class="tradingview-widget-container__widget"></div>
                      <div class="tradingview-widget-copyright"><a href="https://tw.tradingview.com/news/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
                      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                      {
                        "feedMode": "market", "market": "us", "isTransparent": false,
                        "displayMode": "regular", "width": "100%", "height": "100%",
                        "colorTheme": "dark", "locale": "zh_TW"
                      }
                      </script>
                    </div>
                    </div>
            </div>
        </div>


        <div x-show="activeTab === 'reflection'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingReflectionId ? 'ç·¨è¼¯åæ€' : 'æ–°å¢è‡ªæˆ‘åæ€'"></h2>
                    <form @submit.prevent="saveReflection" class="space-y-4">
                        <div><label class="block text-sm">æ—¥æœŸ</label><input type="date" x-model="reflectionForm.date" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">éœ€è¦æ”¹å–„çš„å•é¡Œ</label><input type="text" x-model="reflectionForm.problem" required class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="ä¾‹å¦‚: éæ—©æ­¢ç›ˆã€FOMOè¿½é«˜..."></div>
                        <div><label class="block text-sm">è©³ç´°ç™¼ç¾èˆ‡æ€è€ƒ</label><textarea x-model="reflectionForm.thoughts" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="è¨˜éŒ„ä¸‹ç•¶æ™‚çš„æƒ³æ³•ã€æƒ…ç·’å’Œäº‹å¾Œåˆ†æ..."></textarea></div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingReflectionId ? 'æ›´æ–°' : 'å„²å­˜'"></button>
                             <button type="button" @click="resetReflectionForm" x-show="editingReflectionId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">æ­·å²åæ€åˆ—è¡¨</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <template x-for="entry in reflections" :key="entry.id">
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-lg text-yellow-300" x-text="entry.problem"></p>
                                    <div>
                                        <button @click="editReflection(entry)" class="text-blue-400 hover:text-blue-300 text-sm">ç·¨è¼¯</button>
                                        <button @click="deleteReflection(entry.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">åˆªé™¤</button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1" x-text="entry.date"></p>
                                <p class="text-sm mt-2 whitespace-pre-wrap" x-text="entry.thoughts"></p>
                            </div>
                        </template>
                        <div x-show="reflections.length === 0" class="text-center py-16 text-gray-500">æš«ç„¡åæ€è¨˜éŒ„</div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'marketJournal'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingMarketJournalId ? 'ç·¨è¼¯æ—¥èªŒ' : 'æ–°å¢å¸‚å ´æ—¥èªŒ'"></h2>
                    <form @submit.prevent="saveMarketJournal" class="space-y-4">
                        <div><label class="block text-sm">æ—¥æœŸ</label><input type="date" x-model="marketJournalForm.date" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">å¤§ç›¤èµ°å‹¢æ‘˜è¦</label><textarea x-model="marketJournalForm.marketSummary" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="ä¾‹å¦‚: S&P 500 ç›¤æ•´ï¼ŒNASDAQ å¼·å‹¢..."></textarea></div>
                        <div><label class="block text-sm">é ˜æ¼²æ¿å¡Š</label><input type="text" x-model="marketJournalForm.leadingSectors" placeholder="åŠå°é«”, è»Ÿä»¶..." class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">è§€å¯Ÿè‚¡æ¸…å–®</label><textarea x-model="marketJournalForm.watchlist" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="NVDA, PLTR..."></textarea></div>
                        <div><label class="block text-sm">å¿ƒç†ç‹€æ…‹ / Mindset</label><textarea x-model="marketJournalForm.mindset" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="å†·éœ, ç„¦æ…®, æœ‰ä¿¡å¿ƒ..."></textarea></div>
                        <div><label class="block text-sm">å¸‚å ´æ°›åœæŒ‡æ•¸ (1-5)</label><input type="range" min="1" max="5" x-model.number="marketJournalForm.sentiment" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"><div class="text-center" x-text="marketJournalForm.sentiment"></div></div>
                        <div><label class="block text-sm">ç¸½çµ (é€²æ”»/é˜²å®ˆ)</label><textarea x-model="marketJournalForm.summary" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="ç›®å‰é©åˆç©æ¥µé€²æ”»/ä¿æŒé˜²å®ˆ, å› ç‚º..."></textarea></div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingMarketJournalId ? 'æ›´æ–°' : 'å„²å­˜'"></button>
                             <button type="button" @click="resetMarketJournalForm" x-show="editingMarketJournalId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">éå¾€æ—¥èªŒ</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <template x-for="entry in marketJournals" :key="entry.id">
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-lg" x-text="entry.date"></p>
                                    <div>
                                        <button @click="editMarketJournal(entry)" class="text-blue-400 hover:text-blue-300 text-sm">ç·¨è¼¯</button>
                                        <button @click="deleteMarketJournal(entry.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">åˆªé™¤</button>
                                    </div>
                                </div>
                                <p class="text-sm mt-2"><strong class="text-gray-400">å¤§ç›¤:</strong> <span x-text="entry.marketSummary"></span></p>
                                <p class="text-sm"><strong class="text-gray-400">é ˜æ¼²:</strong> <span x-text="entry.leadingSectors"></span></p>
                                <p class="text-sm"><strong class="text-gray-400">ç¸½çµ:</strong> <span x-text="entry.summary"></span></p>
                            </div>
                        </template>
                        <div x-show="marketJournals.length === 0" class="text-center py-16 text-gray-500">æš«ç„¡å¸‚å ´æ—¥èªŒ</div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'buyPlan'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingBuyPlanId ? 'ç·¨è¼¯è¨ˆåŠƒ' : 'æ–°å¢è²·å…¥è¨ˆåŠƒ'"></h2>
                    <form @submit.prevent="saveBuyPlan" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">åç¨±</label><input type="text" x-model="buyPlanForm.name" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                            <div><label class="block text-sm">ä»£è™Ÿ</label><input type="text" x-model="buyPlanForm.ticker" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">è¡Œæ¥­</label><input type="text" x-model="buyPlanForm.sector" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                            <div><label class="block text-sm">å‹æ…‹</label><input type="text" x-model="buyPlanForm.pattern" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div><label class="block text-sm">é—œéµè²·é» (Pivot)</label><input type="number" step="any" x-model.number="buyPlanForm.pivot" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">åœæåƒ¹</label><input type="number" step="any" x-model.number="buyPlanForm.stopLoss" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                            <div><label class="block text-sm">ç›®æ¨™åƒ¹</label><input type="number" step="any" x-model.number="buyPlanForm.target" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div><label class="block text-sm">ç†ç”± / Rationale</label><textarea x-model="buyPlanForm.rationale" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                        <div>
                            <label class="block text-sm">è‚¡åƒ¹åœ–ç‰‡</label>
                            <input type="file" @change="handleImageUpload($event, buyPlanForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                            <template x-if="buyPlanForm.chartImage"><div class="relative mt-2"><img :src="buyPlanForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="buyPlanForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingBuyPlanId ? 'æ›´æ–°' : 'å„²å­˜'"></button>
                             <button type="button" @click="resetBuyPlanForm" x-show="editingBuyPlanId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                     <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">å¾…åŸ·è¡Œè¨ˆåŠƒ</h2>
                     <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <template x-for="plan in buyPlans" :key="plan.id">
                            <div class="bg-gray-700/50 p-4 rounded-lg flex items-start gap-4">
                               <img :src="plan.chartImage || 'https://placehold.co/120x90/1f2937/9ca3af?text=No+Chart'" @click="openChartModal(plan.chartImage)" class="w-32 h-24 object-cover rounded-md cursor-pointer flex-shrink-0">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg" x-text="`${plan.name} (${plan.ticker})`"></p>
                                            <p class="text-sm text-gray-400" x-text="plan.pattern"></p>
                                        </div>
                                        <div>
                                            <button @click="editBuyPlan(plan)" class="text-blue-400 hover:text-blue-300 text-sm">ç·¨è¼¯</button>
                                            <button @click="deleteBuyPlan(plan.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">åˆªé™¤</button>
                                        </div>
                                    </div>
                                    <p class="text-sm mt-2"><strong class="text-gray-400">è²·é»:</strong> <span x-text="plan.pivot"></span> | <strong class="text-gray-400">æ­¢æ:</strong> <span x-text="plan.stopLoss"></span></p>
                                    <p class="text-sm mt-1"><strong class="text-gray-400">ç†ç”±:</strong> <span x-text="plan.rationale"></span></p>
                                </div>
                            </div>
                        </template>
                         <div x-show="buyPlans.length === 0" class="text-center py-16 text-gray-500">æš«ç„¡è²·å…¥è¨ˆåŠƒ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div x-show="activeTab === 'calculator'" x-cloak>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">1. è³‡é‡‘è¼¸å…¥</h2>
                    <div class="space-y-4">
                        <div><label for="usdPrincipal" class="block text-sm font-medium text-gray-300 mb-1">è‚¡ç¥¨æˆ¶å£æœ¬é‡‘ (USD)</label><div class="input-group"><span>$</span><input type="number" id="usdPrincipal" x-model.number="usdPrincipal" class="text-lg"></div></div>
                        <div><p class="text-sm font-medium text-gray-300">ç­‰å€¼æ¸¯å…ƒ (HKD)</p><div class="mt-1 p-3 bg-gray-700 rounded-lg text-lg font-mono" x-text="`HKD ${formatCurrency(usdPrincipal * 7.8, 'HKD')}`"></div><p class="text-xs text-gray-500 mt-1 text-right">æŒ‰ 1 USD = 7.8 HKD æ›ç®—</p></div>
                    </div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">2. äº¤æ˜“è¨­å®š</h2>
                    <div class="space-y-4">
                        <div><label for="stopLossPercent" class="block text-sm font-medium text-gray-300 mb-1">æ­¢æå¹…åº¦ (%)</label><div class="input-group"><input type="number" id="stopLossPercent" x-model.number="stopLossPercent" step="0.1" class="text-lg"><span>%</span></div></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">é¢¨éšªå€‰ä½ (R%)</label>
                            <div class="grid grid-cols-3 gap-2"><template x-for="risk in [0.25, 0.55, 0.75, 0.93, 1, 1.5]" :key="risk"><button @click="currentRiskPercent = risk; customRiskPercent = null" :class="{'active': currentRiskPercent === risk}" class="risk-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" x-text="`${risk}%`"></button></template></div>
                            <div class="mt-2 input-group"><span>è‡ªè¨‚</span><input type="number" id="customRiskPercent" placeholder="ä¾‹å¦‚: 2" x-model.number="customRiskPercent" @input="currentRiskPercent = customRiskPercent" step="0.1" class="text-sm"><span>%</span></div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">3. è¨ˆç®—çµæœ</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                    <div><p class="text-sm text-blue-300">å–®æ¬¡äº¤æ˜“é¢¨éšªé‡‘é¡ (1R)</p><p class="text-2xl font-bold mt-1" x-text="`USD ${formatCurrency(rValueUsd, 'USD')}`"></p><p class="text-md text-gray-400" x-text="`HKD ${formatCurrency(rValueUsd * 7.8, 'HKD')}`"></p></div>
                    <div><p class="text-sm text-green-300">å»ºè­°è²·å…¥è³‡é‡‘ (ä¸‹æ³¨é‡‘é¡)</p><p class="text-2xl font-bold mt-1" x-text="`USD ${formatCurrency(positionSizeUsd, 'USD')}`"></p><p class="text-md text-gray-400" x-text="`HKD ${formatCurrency(positionSizeUsd * 7.8, 'HKD')}`"></p></div>
                </div>
            </div>
            <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2 flex justify-between items-center flex-wrap"><span>ç›ˆåˆ©ç›®æ¨™</span><span class="text-sm font-medium text-gray-400">é¢¨éšªå€‰ä½: <span x-text="`${currentRiskPercent || 0}%`" class="text-blue-400"></span> / æ­¢æå¹…åº¦: <span x-text="`${stopLossPercent || 0}%`" class="text-yellow-400"></span></span></h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left"><thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th scope="col" class="px-4 py-3 rounded-l-lg">ç›ˆè™§æ¯” (R)</th><th scope="col" class="px-4 py-3">ç›®æ¨™åƒ¹æ ¼å‡å¹… (%)</th><th scope="col" class="px-4 py-3">æ½›åœ¨åˆ©æ½¤ (USD)</th><th scope="col" class="px-4 py-3 rounded-r-lg">æ½›åœ¨åˆ©æ½¤ (HKD)</th></tr></thead>
                        <tbody><template x-for="ratio in [1, 2, 2.5, 3, 4, 5, 7, 10]" :key="ratio"><tr class="border-b border-gray-700 hover:bg-gamma-700/50"><td class="px-4 py-3 font-medium text-white" x-text="`${ratio}R`"></td><td class="px-4 py-3 text-yellow-400 font-mono" x-text="`+${(stopLossPercent * ratio).toFixed(2)}%`"></td><td class="px-4 py-3 text-green-400 font-mono" x-text="`+${formatCurrency(rValueUsd * ratio, 'USD')}`"></td><td class="px-4 py-3 text-green-400 font-mono" x-text="`+${formatCurrency((rValueUsd * ratio) * 7.8, 'HKD')}`"></td></tr></template></tbody>
                    </table>
                </div>
            </div>
             <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b border-gray-600 pb-2 gap-4"><h2 class="text-xl font-semibold whitespace-nowrap">âœ¨ AI äº¤æ˜“ç­–ç•¥åˆ†æ</h2><button @click="getAiAnalysis()" :disabled="isLoading" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">ç²å–åˆ†æ</button></div>
                <div x-html="aiAnalysisResult" class="text-gray-300 prose prose-invert max-w-none"></div>
                <div x-show="isLoading" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2 text-sm text-gray-400">åˆ†æä¸­ï¼Œè«‹ç¨å€™...</p></div>
            </div>
        </div>

        <div x-show="activeTab === 'journal'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingTradeId ? 'ç·¨è¼¯äº¤æ˜“' : 'æ–°å¢äº¤æ˜“æ—¥èªŒ'"></h2>
                    <form @submit.prevent="saveTrade" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div> <label class="block text-sm">æ—¥æœŸ</label> <input type="date" x-model="journalForm.date" required class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                            <div> <label class="block text-sm">ä»£è™Ÿ</label> <input type="text" x-model="journalForm.ticker" placeholder="AAPL" required class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div> <label class="block text-sm">æ–¹å‘</label> <select x-model="journalForm.direction" class="w-full bg-gray-700 rounded p-2 mt-1"> <option>Long</option> <option>Short</option> </select> </div>
                            <div> <label class="block text-sm">è¡Œæ¥­/æ¿å¡Š</label> <input type="text" x-model="journalForm.sector" placeholder="ç§‘æŠ€" class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm">äº¤æ˜“æ­¢æå¹…åº¦ (%)</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" step="any" x-model.number="journalForm.tradeStopLossPercent" placeholder="ä¾‹å¦‚: 4.6" required class="w-full bg-gray-700 rounded p-2 mt-1">
                                    <button @click.prevent="journalForm.tradeStopLossPercent = stopLossPercent" class="bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-lg" title="å¥—ç”¨è¨ˆç®—æ©Ÿè¨­å®š"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M15 2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2zM0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm10.096 3.146a.5.5 0 1 1 .707.708L6.707 9.95h2.768a.5.5 0 1 1 0 1H5.5a.5.5 0 0 1-.5-.5V6.475a.5.5 0 1 1 1 0v2.768l4.096-4.097z"/> </svg></button>
                                </div>
                            </div>
                            <div> <label class="block text-sm">æœ€çµ‚ç›ˆè™§ (P/L $)</label> <input type="number" step="any" x-model.number="journalForm.plAmount" placeholder="ä¾‹å¦‚: 500" required class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                        </div>
                        <div>
                            <label class="block text-sm">é¢¨éšªé‡‘é¡ (Risk $)</label>
                            <div class="flex items-center space-x-2"><input type="number" step="any" x-model.number="journalForm.riskAmount" placeholder="ä¾‹å¦‚: 350" required class="w-full bg-gray-700 rounded p-2 mt-1"><select @change="journalForm.riskAmount = parseFloat((rValueUsd * $event.target.value).toFixed(2)); $event.target.value=''" class="bg-gray-600 hover:bg-gray-500 text-xs text-white font-bold py-2.5 px-3 rounded-lg appearance-none text-center"><option value="" disabled selected>å¥—ç”¨R</option> <option value="0.25">0.25R</option> <option value="0.5">0.5R</option> <option value="0.75">0.75R</option> <option value="1">1R</option> <option value="1.5">1.5R</option> <option value="2">2R</option></select></div>
                        </div>
                        <div> <label class="block text-sm">é€²å ´æ¢ä»¶</label> <textarea x-model="journalForm.entryCriteria" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="è¨˜éŒ„é€²å ´çš„æŠ€è¡“æˆ–åŸºæœ¬é¢åŸå› ..."></textarea> </div>
                        <div> <label class="block text-sm">å‡ºå ´æ¢ä»¶</label> <textarea x-model="journalForm.exitCriteria" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="è¨˜éŒ„å‡ºå ´æ˜¯è§¸åŠæ­¢æã€ç›®æ¨™æˆ–..."></textarea> </div>
                        <div><label class="block text-sm">è‚¡åƒ¹åœ–ç‰‡</label><div class="flex items-center space-x-2 mt-1"><input type="file" @change="handleImageUpload($event, journalForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"><svg x-show="isUploadingImage" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg></div>
                            <template x-if="journalForm.chartImage"><div class="relative mt-2"><img :src="journalForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="journalForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
                        </div>
                        <div> <label class="block text-sm">æƒ…ç·’æ¨™ç±¤</label> <input type="text" x-model="journalForm.emotions" placeholder="FOMO, å†·éœ, çŒ¶è±«..." class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                        <div> <label class="block text-sm">äº¤æ˜“ç­–ç•¥ / Setup</label> <input type="text" x-model="journalForm.setup" placeholder="è¶¨å‹¢çªç ´, ç›¤æ•´è²·å…¥..." class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingTradeId ? 'æ›´æ–°' : 'å„²å­˜'"></button>
                             <button type="button" @click="resetForm" x-show="editingTradeId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">äº¤æ˜“è¨˜éŒ„</h2>
                     <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th class="px-4 py-3">æ—¥æœŸ</th><th class="px-4 py-3">ä»£è™Ÿ</th><th class="px-4 py-3">åœ–è¡¨</th><th class="px-4 py-3">æ–¹å‘</th><th class="px-4 py-3">æç›Š (P/L $)</th><th class="px-4 py-3">R å€æ•¸</th><th class="px-4 py-3">æ“ä½œ</th></tr></thead>
                        <tbody>
                            <template x-for="trade in trades" :key="trade.id">
                                <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td class="px-4 py-3" x-text="trade.date"></td><td class="px-4 py-3" x-text="trade.ticker"></td>
                                    <td class="px-4 py-3"><button x-show="trade.chartImage" @click="openChartModal(trade.chartImage)"><img :src="trade.chartImage" class="h-10 w-16 object-cover rounded-md hover:scale-110 transition-transform"/></button></td>
                                    <td class="px-4 py-3" x-text="trade.direction" :class="trade.direction === 'Long' ? 'text-green-400' : 'text-red-400'"></td>
                                    <td class="px-4 py-3 font-mono" x-text="formatCurrency(trade.plAmount, 'USD')" :class="trade.plAmount >= 0 ? 'text-green-400' : 'text-red-400'"></td>
                                    <td class="px-4 py-3 font-mono" x-text="trade.rMultiple.toFixed(2) + ' R'" :class="trade.rMultiple >= 0 ? 'text-green-400' : 'text-red-400'"></td>
                                    <td class="px-4 py-3 flex gap-2"><button @click="editTrade(trade)" class="text-blue-400 hover:text-blue-300">ç·¨è¼¯</button><button @click="deleteTrade(trade.id)" class="text-red-400 hover:text-red-300">åˆªé™¤</button></td>
                                </tr>
                            </template>
                             <tr x-show="trades.length === 0"><td colspan="7" class="text-center py-8 text-gray-500">æš«ç„¡äº¤æ˜“è¨˜éŒ„</td></tr>
                        </tbody>
                     </table>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'modelBook'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingModelBookId ? 'ç·¨è¼¯æ¨¡å‹' : 'æ–°å¢æ¨¡å‹'"></h2>
                    <form @submit.prevent="saveModelBook" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">åç¨±</label><input type="text" x-model="modelBookForm.name" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                            <div><label class="block text-sm">ä»£è™Ÿ</label><input type="text" x-model="modelBookForm.ticker" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div><label class="block text-sm">å¸‚å ´</label><input type="text" x-model="modelBookForm.market" placeholder="US, HK" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                             <div><label class="block text-sm">å¹´ä»½</label><input type="number" x-model.number="modelBookForm.year" placeholder="2023" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div><label class="block text-sm">è¡Œæ¥­</label><input type="text" x-model="modelBookForm.sector" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">å‹æ…‹</label><input type="text" x-model="modelBookForm.pattern" placeholder="Cup with Handle, VCP..." class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">çªç ´å¾Œè¡¨ç¾</label><input type="text" x-model="modelBookForm.performance" placeholder="+150% in 3 months" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">é—œéµè²·å…¥é»</label><textarea x-model="modelBookForm.pivot" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                        <div><label class="block text-sm">å¿ƒå¾—</label><textarea x-model="modelBookForm.takeaways" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                        <div>
                            <label class="block text-sm">åœ–è¡¨å¿«ç…§</label>
                            <div class="flex items-center space-x-2 mt-1"><input type="file" @change="handleImageUpload($event, modelBookForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"><svg x-show="isUploadingImage" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                            <template x-if="modelBookForm.chartImage">
                                <div class="relative mt-2"><img :src="modelBookForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="modelBookForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div>
                            </template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingModelBookId ? 'æ›´æ–°' : 'å„²å­˜'"></button>
                             <button type="button" @click="resetModelBookForm" x-show="editingModelBookId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-semibold">æ¨¡å‹åº«</h2>
                        <button @click="getAiModelBookAnalysis()" :disabled="isLoading || modelBooks.length < 2" class="w-full mt-2 sm:mt-0 sm:w-auto bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">âœ¨ AI ç¸½çµå…±é€šç‰¹å¾µ</button>
                    </div>
                    <div x-show="isLoading" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-teal-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                    <div x-html="aiModelBookAnalysis" x-show="aiModelBookAnalysis" class="prose prose-sm prose-invert max-w-none text-gray-300 mb-4 p-4 bg-gray-700/50 rounded-lg"></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto">
                        <template x-for="model in modelBooks" :key="model.id">
                            <div class="playbook-card bg-gray-700 rounded-xl overflow-hidden border border-gray-600">
                                <img :src="model.chartImage || 'https://placehold.co/600x400/1f2937/9ca3af?text=No+Image'" class="w-full h-64 object-cover" @click="openChartModal(model.chartImage || '')">
                                <div class="p-4">
                                    <h3 class="font-bold text-lg" x-text="`${model.name} (${model.ticker})`"></h3>
                                    <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-green-900 text-green-300" x-text="model.pattern"></span>
                                    <p class="text-sm text-gray-300 mt-2"><strong class="text-gray-400">è¡¨ç¾:</strong> <span x-text="model.performance"></span></p>
                                    <p class="text-sm text-gray-300 mt-2 h-12 overflow-y-auto"><strong class="text-gray-400">å¿ƒå¾—:</strong> <span x-text="model.takeaways"></span></p>
                                    <div class="mt-4 flex justify-end gap-2"><button @click="editModelBook(model)" class="text-blue-400 hover:text-blue-300">ç·¨è¼¯</button><button @click="deleteModelBook(model.id)" class="text-red-400 hover:text-red-300">åˆªé™¤</button></div>
                                </div>
                            </div>
                        </template>
                         <div x-show="modelBooks.length === 0" class="md:col-span-2 text-center py-16 text-gray-500"><p>æ‚¨çš„æ¨¡å‹åº«æ˜¯ç©ºçš„ï¼Œè«‹åœ¨å·¦æ–¹æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æˆåŠŸæ¡ˆä¾‹æ¨¡å‹ã€‚</p></div>
                     </div>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'playbook'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingPlaybookId ? 'ç·¨è¼¯ç­–ç•¥' : 'æ–°å¢ç­–ç•¥'"></h2>
                    <form @submit.prevent="savePlaybook" class="space-y-4">
                        <div><label class="block text-sm">ç­–ç•¥åç¨±</label><input type="text" x-model="playbookForm.name" placeholder="MA20 å›èª¿è²·å…¥" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">å¸‚å ´ç‹€æ…‹</label><select x-model="playbookForm.marketCondition" class="w-full bg-gray-700 rounded p-2 mt-1"><option>å¤šé ­ (Bull)</option><option>ç©ºé ­ (Bear)</option><option>éœ‡ç›ª (Range-bound)</option><option>æœªåˆ†é¡</option></select></div>
                        <div><label class="block text-sm">é€²å ´æ¨™æº– (Criteria)</label><textarea x-model="playbookForm.criteria" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="ä¾‹å¦‚: åƒ¹æ ¼åœ¨MA50ä¹‹ä¸Šï¼Œå›èª¿è‡³MA20..."></textarea></div>
                        <div>
                            <label class="block text-sm">ç¯„ä¾‹åœ–è¡¨</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="file" @change="handleImageUpload($event, playbookForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                                <svg x-show="isUploadingImage" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </div>
                            <template x-if="playbookForm.chartImage">
                                <div class="relative mt-2"><img :src="playbookForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="playbookForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div>
                            </template>
                        </div>
                        <div><label class="block text-sm">å‚™è¨»</label><textarea x-model="playbookForm.notes" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="ç­–ç•¥çš„å„ªç¼ºé»ã€æ³¨æ„äº‹é …..."></textarea></div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingPlaybookId ? 'æ›´æ–°ç­–ç•¥' : 'å„²å­˜ç­–ç•¥'"></button>
                             <button type="button" @click="resetPlaybookForm" x-show="editingPlaybookId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">ç­–ç•¥å¡ç‰‡ (Gallery View)</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto">
                        <template x-for="playbook in playbooks" :key="playbook.id">
                            <div class="playbook-card bg-gray-700 rounded-xl overflow-hidden border border-gray-600">
                                <img :src="playbook.chartImage || 'https://placehold.co/600x400/1f2937/9ca3af?text=No+Image'" class="w-full h-40 object-cover" @click="openChartModal(playbook.chartImage || '')">
                                <div class="p-4">
                                    <h3 class="font-bold text-lg" x-text="playbook.name"></h3><span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-blue-900 text-blue-300" x-text="playbook.marketCondition"></span>
                                    <p class="text-sm text-gray-300 mt-2 h-16 overflow-y-auto" x-text="playbook.criteria"></p>
                                    <div class="mt-4 flex justify-end gap-2"><button @click="editPlaybook(playbook)" class="text-blue-400 hover:text-blue-300">ç·¨è¼¯</button><button @click="deletePlaybook(playbook.id)" class="text-red-400 hover:text-red-300">åˆªé™¤</button></div>
                                </div>
                            </div>
                        </template>
                         <div x-show="playbooks.length === 0" class="md:col-span-2 text-center py-16 text-gray-500"><p>æ‚¨çš„ç­–ç•¥åº«æ˜¯ç©ºçš„ï¼Œè«‹åœ¨å·¦æ–¹æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹ç­–ç•¥ã€‚</p></div>
                     </div>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'performance'" x-cloak>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">å‹ç‡ (Win Rate)</h3><p class="mt-2 text-3xl font-bold" x-text="`${performance.winRate.toFixed(2)}%`"></p></div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">ç¸½ç›ˆè™§ (Total P&L)</h3><p class="mt-2 text-3xl font-bold" :class="performance.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(performance.totalPl, 'USD')"></p></div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">å¹³å‡ R å€¼</h3><p class="mt-2 text-3xl font-bold" :class="performance.avgR >= 0 ? 'text-green-400' : 'text-red-400'" x-text="`${performance.avgR.toFixed(2)} R`"></p></div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">ç¸½äº¤æ˜“æ•¸</h3><p class="mt-2 text-3xl font-bold" x-text="performance.totalTrades"></p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                 <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700"><h2 class="text-xl font-semibold mb-4">è³‡é‡‘æ›²ç·šåœ–</h2><canvas id="plChart"></canvas></div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4">æœ€å¤§å›æ’¤ (Max Drawdown)</h2>
                     <button @click="getAiDrawdownAnalysis()" :disabled="isLoading || trades.length < 2" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition mb-4 disabled:opacity-50 disabled:cursor-not-allowed">ç”± AI åˆ†æ</button>
                    <div x-show="isLoading" class="text-center py-4"><svg class="animate-spin h-6 w-6 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div><div x-html="maxDrawdownAnalysis" class="prose prose-sm prose-invert max-w-none text-gray-300"></div>
                </div>
            </div>
            <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"><h2 class="text-xl font-semibold">âœ¨ AI æƒ…ç·’æ¨¡å¼åˆ†æ</h2><button @click="getAiEmotionAnalysis()" :disabled="isLoading || trades.length < 1" class="w-full mt-2 sm:mt-0 sm:w-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">åˆ†ææƒ…ç·’èˆ‡ç¸¾æ•ˆé—œè¯</button></div>
                <div x-show="isLoading" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-purple-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div><div x-html="aiEmotionAnalysisResult" class="prose prose-sm prose-invert max-w-none text-gray-300"></div>
            </div>
            <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"><h2 class="text-xl font-semibold">æœˆåº¦ / å­£åº¦å›é¡§</h2><button @click="getAiPerformanceReview()" :disabled="isLoading || trades.length < 1" class="w-full mt-2 sm:mt-0 sm:w-auto bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">âœ¨ ç”¢ç”Ÿ AI å›é¡§å ±å‘Š</button></div>
                <div x-show="isLoading" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-green-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                <div class="space-y-4">
                     <div><label class="block text-sm font-medium text-gray-300">æ¯æœˆè¡¨ç¾</label><textarea x-model="reviewNotes.monthly" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                     <div><label class="block text-sm font-medium text-gray-300">éœ€è¦æ”¹å–„çš„åœ°æ–¹</label><textarea x-model="reviewNotes.improve" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                     <div><label class="block text-sm font-medium text-gray-300">ä¸‹æœˆç›®æ¨™</label><textarea x-model="reviewNotes.goals" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                </div>
            </div>
        </div>
        
        <div x-show="activeTab === 'settings'" x-cloak>
            <div class="max-w-2xl mx-auto bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 text-blue-300 border-b border-gray-600 pb-2">AI åˆ†æè¨­å®š</h2>
                <div class="space-y-6">
                    <div>
                        <label for="aiProvider" class="block text-sm font-medium text-gray-300">AI æœå‹™ä¾›æ‡‰å•†</label>
                        <select id="aiProvider" x-model="settings.aiProvider" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="gemini">é è¨­ (å…§å»º AI)</option>
                            <option value="custom">è‡ªè¨‚ API Key (OpenAI ç›¸å®¹)</option>
                        </select>
                        <p class="mt-2 text-xs text-gray-400">é¸æ“‡ "é è¨­" å°‡ä½¿ç”¨å…§å»ºçš„ Gemini é€£æ¥ã€‚é¸æ“‡ "è‡ªè¨‚" ä»¥ä½¿ç”¨æ‚¨è‡ªå·±çš„ API Keyã€‚</p>
                    </div>

                    <div x-show="settings.aiProvider === 'custom'" class="space-y-4 p-4 bg-gray-700/50 rounded-lg">
                        <div>
                            <label for="customApiUrl" class="block text-sm font-medium text-gray-300">API ç«¯é» (Endpoint URL)</label>
                            <input type="text" id="customApiUrl" x-model="settings.customApiUrl" placeholder="https://api.openai.com/v1/chat/completions" class="w-full bg-gray-900 rounded p-2 mt-1">
                            <p class="mt-1 text-xs text-gray-400">è«‹è¼¸å…¥ OpenAI ç›¸å®¹çš„ API ç«¯é»ã€‚ç•™ç©ºå°‡ä½¿ç”¨é è¨­çš„ OpenAI URLã€‚</p>
                        </div>
                        <div>
                            <label for="customApiKey" class="block text-sm font-medium text-gray-300">æ‚¨çš„ API Key</label>
                            <input type="password" id="customApiKey" x-model="settings.customApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full bg-gray-900 rounded p-2 mt-1">
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button @click="saveSettings" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">å„²å­˜è¨­å®š</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-xs space-y-1">
            <p>æ­¤å·¥å…·åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ã€‚AI åˆ†æç”±å¤§å‹èªè¨€æ¨¡å‹ç”Ÿæˆï¼Œå¯èƒ½å­˜åœ¨éŒ¯èª¤ï¼Œè«‹è¬¹æ…ç®¡ç†æ‚¨çš„é¢¨éšªã€‚</p>
            <p>ç‰ˆæœ¬: <span x-text="appVersion"></span> | æœ€å¾Œæ›´æ–°: <span x-text="lastUpdated"></span></p>
        </footer>
        
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, serverTimestamp, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/module.esm.js';

        function tradingApp() {
            return {
                // System State
                isInitialized: false,
                isLoggedIn: false,
                activeTab: 'dashboard',
                isLoading: false, 
                isUploadingImage: false,
                isModalOpen: false, 
                modalImageUrl: '',
                authView: 'login',
                authForm: { email: '', password: '' },
                authError: '',
                appVersion: '2.0.3',
                lastUpdated: '2024-07-28',

                // Firebase
                db: null, 
                auth: null, 
                userId: null,
                
                // --- Collections Refs ---
                tradesCollectionRef: null, marketJournalsCollectionRef: null,
                buyPlansCollectionRef: null, modelBooksCollectionRef: null,
                reflectionsCollectionRef: null, marketCompassLogCollectionRef: null,

                // Settings
                settings: { aiProvider: 'gemini', customApiKey: '', customApiUrl: '' },
                
                // Data Arrays
                trades: [], playbooks: [], marketJournals: [], buyPlans: [], modelBooks: [],
                reflections: [], marketCompassLog: [],

                // Forms & Editing State
                editingTradeId: null, journalForm: {},
                editingPlaybookId: null, playbookForm: {},
                editingMarketJournalId: null, marketJournalForm: {},
                editingBuyPlanId: null, buyPlanForm: {},
                editingModelBookId: null, modelBookForm: {},
                editingReflectionId: null, reflectionForm: {},
                
                // Search
                searchTerm: '',
                searchResults: [],

                // Calculator
                usdPrincipal: 35000, 
                stopLossPercent: 4.6, 
                currentRiskPercent: 1, 
                customRiskPercent: null,
                
                // AI & Performance
                plChart: null,
                aiAnalysisResult: '<p class="text-gray-500">é»æ“Šã€Œç²å–åˆ†æã€æŒ‰éˆ•ï¼Œè®“ AI æ ¹æ“šæ‚¨ç•¶å‰çš„è¨­å®šæä¾›äº¤æ˜“ç­–ç•¥å»ºè­°ã€‚</p>',
                maxDrawdownAnalysis: '<p class="text-gray-500">é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI ç‚ºæ‚¨åˆ†æäº¤æ˜“æ•¸æ“šä¸­çš„æœ€å¤§è³‡é‡‘å›æ’¤ã€‚</p>',
                aiEmotionAnalysisResult: '<p class="text-gray-500">é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI åˆ†ææ‚¨çš„æƒ…ç·’æ¨™ç±¤èˆ‡äº¤æ˜“çµæœä¹‹é–“çš„é—œè¯ã€‚</p>',
                aiModelBookAnalysis: '',
                reviewNotes: { monthly: '', improve: '', goals: '' },
                aiDashboardSummary: '',
                aiQuery: '',

                get rValueUsd() { return this.usdPrincipal * ((this.currentRiskPercent || 0) / 100); },
                get positionSizeUsd() { if (!this.stopLossPercent) return 0; return this.rValueUsd / (this.stopLossPercent / 100); },
                get performance() {
                    const totalTrades = this.trades.length;
                    if (totalTrades === 0) return { winRate: 0, totalPl: 0, avgR: 0, totalTrades: 0 };
                    this.trades.forEach(t => t.rMultiple = (t.riskAmount > 0) ? (t.plAmount || 0) / t.riskAmount : 0);
                    const winningTrades = this.trades.filter(t => t.plAmount > 0).length;
                    const totalPl = this.trades.reduce((sum, t) => sum + (t.plAmount || 0), 0);
                    const totalR = this.trades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                    return { winRate: (winningTrades / totalTrades) * 100, totalPl, avgR: totalR !== 0 && totalTrades > 0 ? totalR / totalTrades : 0, totalTrades };
                },
                get playbookBoard() {
                    const board = { 'å¤šé ­ (Bull)': [], 'ç©ºé ­ (Bear)': [], 'éœ‡ç›ª (Range-bound)': [], 'æœªåˆ†é¡': [] };
                    this.playbooks.forEach(playbook => {
                        const condition = playbook.marketCondition || 'æœªåˆ†é¡';
                        if (board.hasOwnProperty(condition)) { board[condition].push(playbook); } 
                        else { board['æœªåˆ†é¡'].push(playbook); }
                    });
                    return board;
                },
                get latestReflection() {
                    return this.reflections.length > 0 ? this.reflections[0] : null;
                },
                
                init() {
                    this.loadSettings();
                    this.resetAllForms();
                    this.initFirebase();
                    this.$watch('activeTab', (newTab) => {
                        if ((newTab === 'performance' || newTab === 'dashboard') && this.isLoggedIn) {
                           this.$nextTick(() => { if (document.getElementById('plChart')) this.renderChart(); });
                        }
                    });
                },

                loadSettings() { const savedSettings = localStorage.getItem('tradingWorkbenchSettings_v1'); if (savedSettings) { this.settings = JSON.parse(savedSettings); } },
                saveSettings() { localStorage.setItem('tradingWorkbenchSettings_v1', JSON.stringify(this.settings)); alert('è¨­å®šå·²å„²å­˜ï¼'); },

                async initFirebase() {
                    try {
                        const firebaseConfig = {
                            apiKey: "AIzaSyD_NXXcXNzKfeUct_kcv9nhSEk5ynguO0o",
                            authDomain: "my-trading-workbench.firebaseapp.com",
                            projectId: "my-trading-workbench",
                            storageBucket: "my-trading-workbench.appspot.com",
                            messagingSenderId: "386958713208",
                            appId: "1:386958713208:web:028035e1ac4b47bd55e88d",
                            measurementId: "G-2WEVVMRHV7"
                        };
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app); 
                        this.auth = getAuth(app); 
                        
                        onAuthStateChanged(this.auth, (user) => {
                            this.isInitialized = true;
                            if (user) {
                                this.isLoggedIn = true;
                                this.userId = user.uid;
                                this.initializeDataListeners();
                            } else {
                                this.isLoggedIn = false;
                                this.userId = null;
                                this.clearAllData();
                            }
                        });
                    } catch(e) { 
                        console.error("Firebase initialization failed:", e); 
                        this.authError = "Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¨­å®šæˆ–ç¶²è·¯é€£ç·šã€‚";
                        this.isInitialized = true;
                    }
                },

                initializeDataListeners() {
                    if (!this.userId) return;
                    this.loadCollection(`users/${this.userId}/trades`, 'trades', 'date'); 
                    this.loadCollection(`users/${this.userId}/playbooks`, 'playbooks', 'name', 'asc');
                    this.loadCollection(`users/${this.userId}/marketJournals`, 'marketJournals', 'date');
                    this.loadCollection(`users/${this.userId}/buyPlans`, 'buyPlans', 'createdAt');
                    this.loadCollection(`users/${this.userId}/modelBooks`, 'modelBooks', 'year');
                    this.loadCollection(`users/${this.userId}/reflections`, 'reflections', 'date');
                    this.loadCollection(`users/${this.userId}/marketCompassLog`, 'marketCompassLog', 'timestamp');
                },

                async register() { this.authError = ''; try { await createUserWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
                async login() { this.authError = ''; try { await signInWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
                async loginWithGoogle() { this.authError = ''; try { const provider = new GoogleAuthProvider(); await signInWithPopup(this.auth, provider); } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); console.error("Google Sign-in Error:", error); } },
                async logout() { await signOut(this.auth); },
                getFirebaseAuthErrorMessage(error) {
                    switch (error.code) {
                        case 'auth/email-already-in-use': return 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚';
                        case 'auth/invalid-email': return 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚';
                        case 'auth/weak-password': return 'å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹è‡³å°‘è¨­å®š 6 å€‹å­—å…ƒã€‚';
                        case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': return 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                        default: return 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    }
                },

                loadCollection(path, targetProperty, orderByField, orderDirection = "desc") {
                    const collectionRef = collection(this.db, path);
                    const q = query(collectionRef, orderBy(orderByField, orderDirection));
                    onSnapshot(q, (snapshot) => {
                        this[targetProperty] = snapshot.docs.map(doc => {
                            const data = doc.data();
                            if (targetProperty === 'trades') { data.rMultiple = (data.riskAmount > 0) ? (data.plAmount || 0) / data.riskAmount : 0; }
                             if (data.timestamp && data.timestamp instanceof Timestamp) { data.timestamp = data.timestamp.toDate(); }
                            return { id: doc.id, ...data };
                        });
                    }, (error) => { console.error(`Error loading ${targetProperty}:`, error); });
                },

                async saveEntity(collectionName, entityId, formData) {
                    if (!this.userId) { alert("ç”¨æˆ¶æœªç™»å…¥ï¼Œç„¡æ³•å„²å­˜ã€‚"); return; }
                    try {
                        const data = { ...formData };
                        const collectionRef = collection(this.db, `users/${this.userId}/${collectionName}`);
                        if (entityId) {
                            await setDoc(doc(collectionRef, entityId), data, { merge: true });
                        } else {
                            data.createdAt = serverTimestamp();
                            if(collectionName === 'marketCompassLog') data.timestamp = serverTimestamp();
                            await addDoc(collectionRef, data);
                        }
                    } catch(e) { console.error("Error saving entity:", e); alert("å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ Firebase å®‰å…¨è¦å‰‡ã€‚"); throw e; }
                },
                
                async deleteEntity(collectionName, entityId) {
                    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ")) return;
                     try { await deleteDoc(doc(this.db, `users/${this.userId}/${collectionName}`, entityId)); } 
                     catch(e) { console.error("Error deleting entity:", e); alert("åˆªé™¤å¤±æ•—ï¼"); }
                },
                 
                handleImageUpload(event, targetForm) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 1024 * 1024) { alert("åœ–ç‰‡æª”æ¡ˆéå¤§ï¼è«‹ä¸Šå‚³å°æ–¼ 1MB çš„åœ–ç‰‡ã€‚"); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => { targetForm.chartImage = e.target.result; };
                    reader.onerror = () => { alert("è®€å–åœ–ç‰‡å¤±æ•—ã€‚"); };
                    reader.readAsDataURL(file);
                },

                formatCurrency(value, currency) {
                    if (typeof value !== 'number' || isNaN(value)) return '0.00';
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value).replace(currency, '').trim();
                },
                clearAllData() { this.trades = []; this.playbooks = []; this.marketJournals = []; this.buyPlans = []; this.modelBooks = []; this.reflections = []; this.marketCompassLog = []; },
                openChartModal(url) { if(url) { this.modalImageUrl = url; this.isModalOpen = true; } },
                closeChartModal() { this.isModalOpen = false; this.modalImageUrl = ''; },

                resetAllForms() {
                    this.resetForm(); this.resetPlaybookForm(); this.resetMarketJournalForm();
                    this.resetBuyPlanForm(); this.resetModelBookForm(); this.resetReflectionForm();
                },
                getBlankForm() { return { date: new Date().toISOString().split('T')[0], ticker: '', direction: 'Long', sector: '', tradeStopLossPercent: null, riskAmount: null, plAmount: null, entryCriteria: '', exitCriteria: '', chartImage: '', emotions: '', setup: '', notes: '' }; },
                getBlankPlaybookForm() { return { name: '', marketCondition: 'å¤šé ­ (Bull)', criteria: '', chartImage: '', notes: ''}; },
                getBlankMarketJournalForm() { return { date: new Date().toISOString().split('T')[0], marketSummary: '', leadingSectors: '', watchlist: '', mindset: '', sentiment: 3, summary: '' }; },
                getBlankBuyPlanForm() { return { name: '', ticker: '', sector: '', pattern: '', pivot: null, stopLoss: null, target: null, rationale: '', chartImage: '' }; },
                getBlankModelBookForm() { return { name: '', ticker: '', market: '', year: new Date().getFullYear(), sector: '', pattern: '', performance: '', pivot: '', takeaways: '', chartImage: '' }; },
                getBlankReflectionForm() { return { date: new Date().toISOString().split('T')[0], problem: '', thoughts: '' }; },
                
                resetForm() { this.editingTradeId = null; this.journalForm = this.getBlankForm(); },
                resetPlaybookForm() { this.editingPlaybookId = null; this.playbookForm = this.getBlankPlaybookForm(); },
                resetMarketJournalForm() { this.editingMarketJournalId = null; this.marketJournalForm = this.getBlankMarketJournalForm(); },
                resetBuyPlanForm() { this.editingBuyPlanId = null; this.buyPlanForm = this.getBlankBuyPlanForm(); },
                resetModelBookForm() { this.editingModelBookId = null; this.modelBookForm = this.getBlankModelBookForm(); },
                resetReflectionForm() { this.editingReflectionId = null; this.reflectionForm = this.getBlankReflectionForm(); },

                async saveTrade() { await this.saveEntity('trades', this.editingTradeId, this.journalForm); this.resetForm(); },
                async savePlaybook() { await this.saveEntity('playbooks', this.editingPlaybookId, this.playbookForm); this.resetPlaybookForm(); },
                async saveMarketJournal() { await this.saveEntity('marketJournals', this.editingMarketJournalId, this.marketJournalForm); this.resetMarketJournalForm(); },
                async saveBuyPlan() { await this.saveEntity('buyPlans', this.editingBuyPlanId, this.buyPlanForm); this.resetBuyPlanForm(); },
                async saveModelBook() { await this.saveEntity('modelBooks', this.editingModelBookId, this.modelBookForm); this.resetModelBookForm(); },
                async saveReflection() { await this.saveEntity('reflections', this.editingReflectionId, this.reflectionForm); this.resetReflectionForm(); },

                async deleteTrade(id) { await this.deleteEntity('trades', id); },
                async deletePlaybook(id) { await this.deleteEntity('playbooks', id); },
                async deleteMarketJournal(id) { await this.deleteEntity('marketJournals', id); },
                async deleteBuyPlan(id) { await this.deleteEntity('buyPlans', id); },
                async deleteModelBook(id) { await this.deleteEntity('modelBooks', id); },
                async deleteReflection(id) { await this.deleteEntity('reflections', id); },

                editTrade(trade) { this.editingTradeId = trade.id; this.journalForm = { ...this.getBlankForm(), ...trade }; this.activeTab = 'journal'; },
                editPlaybook(playbook) { this.editingPlaybookId = playbook.id; this.playbookForm = { ...this.getBlankPlaybookForm(), ...playbook }; this.activeTab = 'playbook'; },
                editMarketJournal(entry) { this.editingMarketJournalId = entry.id; this.marketJournalForm = { ...this.getBlankMarketJournalForm(), ...entry }; this.activeTab = 'marketJournal'; },
                editBuyPlan(plan) { this.editingBuyPlanId = plan.id; this.buyPlanForm = { ...this.getBlankBuyPlanForm(), ...plan }; this.activeTab = 'buyPlan'; },
                editModelBook(model) { this.editingModelBookId = model.id; this.modelBookForm = { ...this.getBlankModelBookForm(), ...model }; this.activeTab = 'modelBook'; },
                editReflection(entry) { this.editingReflectionId = entry.id; this.reflectionForm = { ...this.getBlankReflectionForm(), ...entry }; this.activeTab = 'reflection'; },

                async setMarketCompass(market, sentiment) {
                    await this.saveEntity('marketCompassLog', null, { market, sentiment });
                },

                search() {
                    if (!this.searchTerm) { this.searchResults = []; return; }
                    const term = this.searchTerm.toLowerCase();
                    const tradeResults = this.trades
                        .filter(t => t.ticker.toLowerCase().includes(term) || (t.setup && t.setup.toLowerCase().includes(term)))
                        .map(t => ({...t, type: 'äº¤æ˜“æ—¥èªŒ'}));
                    const modelResults = this.modelBooks
                        .filter(m => m.name.toLowerCase().includes(term) || m.ticker.toLowerCase().includes(term) || m.pattern.toLowerCase().includes(term))
                        .map(m => ({...m, type: 'æ¨¡å‹åº«'}));
                    this.searchResults = [...tradeResults, ...modelResults].slice(0, 10);
                },
                goToSearchResult(item) {
                    if (item.type === 'äº¤æ˜“æ—¥èªŒ') { this.editTrade(item); } 
                    else if (item.type === 'æ¨¡å‹åº«') { this.editModelBook(item); }
                    this.searchTerm = ''; this.searchResults = [];
                },

                renderChart() {
                    const canvas = document.getElementById('plChart');
                    if (!canvas || !this.trades.length) return;
                    const ctx = canvas.getContext('2d');
                    const sortedTrades = [...this.trades].sort((a, b) => new Date(a.date) - new Date(b.date));
                    let cumulativePl = 0;
                    const dataPoints = sortedTrades.map(t => cumulativePl += (t.plAmount || 0));
                    if(this.plChart) this.plChart.destroy();
                    this.plChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: sortedTrades.map((t, i) => `Trade ${i+1}`),
                            datasets: [{ label: 'ç´¯è¨ˆç›ˆè™§ (USD)', data: dataPoints, borderColor: 'rgba(59, 130, 246, 0.8)', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.1, fill: true, }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: false, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } }
                    });
                },
                
                async callAiApi(systemPrompt, userQuery, formatHtml = true, isJsonOutput = false) {
                    this.isLoading = true;
                    let resultText = '';
                    try {
                        if (this.settings.aiProvider === 'custom' && this.settings.customApiKey) {
                            resultText = await this.callCustomApi(systemPrompt, userQuery, isJsonOutput);
                        } else {
                            resultText = await this.callGeminiApi(systemPrompt, userQuery, isJsonOutput);
                        }
                    } catch (error) {
                        console.error('AI API Call failed:', error);
                        resultText = `èˆ‡ AI API é€šè¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
                        formatHtml = true; 
                    } finally {
                        this.isLoading = false;
                        if (formatHtml && !isJsonOutput) {
                            return resultText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        }
                        return resultText;
                    }
                },

                async callGeminiApi(systemPrompt, userQuery, isJsonOutput) {
                    const apiKey = "AIzaSyBtEE_70BID6abB3KWlKAQsFmk7gcIHoo4"; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                    if (isJsonOutput) { payload.generationConfig = { responseMimeType: "application/json" }; }
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Gemini API request failed with status ${response.status}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error('ç„¡æ³•å¾ Gemini ç²å–æœ‰æ•ˆçš„åˆ†æçµæœã€‚');
                    return text;
                },

                async callCustomApi(systemPrompt, userQuery, isJsonOutput) {
                    const apiUrl = this.settings.customApiUrl || 'https://api.openai.com/v1/chat/completions';
                    const payload = { model: "gpt-3.5-turbo", messages: [{ role: "system", content: systemPrompt },{ role: "user", content: userQuery }] };
                    if (isJsonOutput) { payload.response_format = { type: "json_object" }; }
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.settings.customApiKey}` }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Custom API request failed with status ${response.status}`);
                    const result = await response.json();
                    const text = result.choices?.[0]?.message?.content;
                    if (!text) throw new Error('ç„¡æ³•å¾è‡ªè¨‚ API ç²å–æœ‰æ•ˆçš„åˆ†æçµæœã€‚');
                    return text;
                },
                
                getAiPrompts(type) {
                    let systemPrompt = '', userQuery = '';
                    switch (type) {
                        case 'dashboardSummary':
                            const context = {
                                performance: this.performance,
                                latestTrades: this.trades.slice(0, 5).map(t => ({ ticker: t.ticker, rMultiple: t.rMultiple.toFixed(2), emotions: t.emotions, setup: t.setup })),
                                latestMarketJournal: this.marketJournals.length > 0 ? { summary: this.marketJournals[0].summary, mindset: this.marketJournals[0].mindset } : null,
                                latestReflection: this.latestReflection ? { problem: this.latestReflection.problem } : null,
                            };
                            systemPrompt = "ä½ æ˜¯ä¸€ä½é ‚å°–çš„äº¤æ˜“æ•™ç·´å’Œæ•¸æ“šåˆ†æå¸«ã€‚ä½ çš„ä»»å‹™æ˜¯æ•´åˆæ‰€æœ‰æä¾›çš„æ•¸æ“šï¼Œç‚ºäº¤æ˜“è€…æä¾›ä¸€å€‹æ¸…æ™°ã€ç°¡æ½”ã€å¯åŸ·è¡Œçš„æ¯æ—¥å„€è¡¨æ¿ç¸½çµã€‚ä½ çš„èªæ°£æ‡‰è©²æ˜¯å®¢è§€ã€é¼“å‹µæ€§ä¸”å…·å‰ç»æ€§çš„ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
                            userQuery = `è«‹æ ¹æ“šä»¥ä¸‹æˆ‘çš„äº¤æ˜“å·¥ä½œå°æ•¸æ“šï¼Œç”¢ç”Ÿä¸€ä»½å„€è¡¨æ¿ç¸½çµå ±å‘Šï¼š\n\n${JSON.stringify(context, null, 2)}\n\nå ±å‘Šæ‡‰åŒ…å«ï¼š\n1.  **ç¸¾æ•ˆäº®é»**: æ ¹æ“šç¸½é«”ç¸¾æ•ˆï¼ŒæŒ‡å‡ºä¸€å€‹æœ€å€¼å¾—é—œæ³¨çš„æ•¸æ“šé» (ä¾‹å¦‚ï¼Œå‹ç‡ä¸éŒ¯ä½†å¹³å‡Rå€¼éœ€è¦æé«˜)ã€‚\n2.  **æ¨¡å¼è§€å¯Ÿ**: çµåˆè¿‘æœŸäº¤æ˜“ã€å¸‚å ´æ—¥èªŒå’Œåæ€ï¼Œé»å‡ºä¸€å€‹æ½›åœ¨çš„è¡Œç‚ºæ¨¡å¼æˆ–å¸‚å ´é—œè¯æ€§ã€‚\n3.  **ä»Šæ—¥ç„¦é»**: çµ¦å‡ºä¸€é …ä»Šæ—¥æœ€æ‡‰è©²é—œæ³¨çš„å»ºè­°ï¼Œé€™é …å»ºè­°å¿…é ˆåŸºæ–¼ã€Œè¿‘æœŸåæ€ã€ä¸­çš„å•é¡Œã€‚å¦‚æœæ²’æœ‰åæ€ï¼Œå‰‡åŸºæ–¼ç¸¾æ•ˆæ•¸æ“šçµ¦å‡ºå»ºè­°ã€‚`;
                            break;
                        case 'askAi':
                            const askContext = {
                                performance: this.performance,
                                trades: this.trades.map(t => ({ ticker: t.ticker, rMultiple: t.rMultiple.toFixed(2), emotions: t.emotions, setup: t.setup, date: t.date })),
                                reflections: this.reflections.map(r => ({ problem: r.problem, thoughts: r.thoughts })),
                                modelBooks: this.modelBooks.map(m => ({ name: m.name, pattern: m.pattern, takeaways: m.takeaways })),
                            };
                            systemPrompt = "ä½ æ˜¯ä¸€ä½ AI äº¤æ˜“æ•¸æ“šåˆ†æå¸«ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šç”¨æˆ¶æä¾›çš„å…¨éƒ¨æ­·å²æ•¸æ“šå’Œä»–å€‘æå‡ºçš„å…·é«”å•é¡Œï¼Œæä¾›ç²¾ç¢ºã€æ•¸æ“šé©…å‹•çš„å›ç­”ã€‚ä½ åªèƒ½ä½¿ç”¨ç”¨æˆ¶æä¾›çš„æ•¸æ“šä¾†å›ç­”å•é¡Œã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
                            userQuery = `é€™æ˜¯æˆ‘æ‰€æœ‰çš„äº¤æ˜“ç›¸é—œæ•¸æ“šï¼š\n\n${JSON.stringify(askContext, null, 2)}\n\nç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰æ•¸æ“šï¼Œå›ç­”æˆ‘ä»¥ä¸‹é€™å€‹å•é¡Œï¼š\n\n**${this.aiQuery}**`;
                            break;
                        case 'riskAnalysis':
                            systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é‡‘èäº¤æ˜“åˆ†æå¸«å’Œé¢¨éšªç®¡ç†é¡§å•ã€‚ä½ çš„èªæ°£æ‡‰è©²æ˜¯å®¢è§€ã€å°ˆæ¥­ä¸”å…·æœ‰æŒ‡å°æ€§ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä½ çš„ç›®æ¨™æ˜¯æ ¹æ“šç”¨æˆ¶æä¾›çš„åƒæ•¸ï¼Œæä¾›ç°¡æ½”ã€æ¸…æ™°ã€å¯åŸ·è¡Œçš„é¢¨éšªåˆ†æå’Œå»ºè­°ï¼Œå¹«åŠ©ä»–å€‘åšå‡ºæ›´æ˜æ™ºçš„äº¤æ˜“æ±ºç­–ã€‚é¿å…æä¾›ç›´æ¥çš„è²·è³£å»ºè­°ï¼Œè€Œæ˜¯å°ˆæ³¨æ–¼é¢¨éšªç®¡ç†å’Œç­–ç•¥æ€ç¶­ã€‚";
                            userQuery = `æˆ‘æ­£åœ¨è¨ˆåŠƒä¸€ç­†è‚¡ç¥¨äº¤æ˜“ï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„åƒæ•¸è¨­å®šï¼š\n- è‚¡ç¥¨æˆ¶å£æœ¬é‡‘: ${this.formatCurrency(this.usdPrincipal, 'USD')} USD\n- å–®æ¬¡äº¤æ˜“é¢¨éšª (R%): ${this.currentRiskPercent}%\n- è¨ˆåŠƒæ­¢æå¹…åº¦: ${this.stopLossPercent}%\n\nè«‹æ ¹æ“šä»¥ä¸Šæ•¸æ“šï¼Œç‚ºæˆ‘æä¾›ä¸€ä»½ç°¡æ½”çš„äº¤æ˜“é¢¨éšªåˆ†æå ±å‘Šï¼ŒåŒ…å«ä»¥ä¸‹å¹¾é»ï¼š\n1.  **é¢¨éšªè©•ä¼°**: æ ¹æ“šæˆ‘çš„æˆ¶å£æœ¬é‡‘å’Œé¢¨éšªç™¾åˆ†æ¯”ï¼Œè©•ä¼°é€™æ¬¡äº¤æ˜“çš„é¢¨éšªæ°´å¹³ï¼ˆä¾‹å¦‚ï¼šä¿å®ˆã€å‡è¡¡ã€ç©æ¥µï¼‰ã€‚\n2.  **æ ¸å¿ƒå»ºè­°**: æä¾›ä¸€é …æœ€é‡è¦çš„é¢¨éšªç®¡ç†å»ºè­°ã€‚\n3.  **æ½›åœ¨å½±éŸ¿**: ç°¡è¦èªªæ˜é€£çºŒå¹¾æ¬¡è™§æï¼ˆä¾‹å¦‚3æ¬¡ï¼‰å°æˆ‘ç¸½è³‡æœ¬çš„æ½›åœ¨å½±éŸ¿ã€‚\n\nè«‹å°‡å ±å‘Šé‡é»æ¢åˆ—åŒ–ï¼Œä½¿å…¶æ˜“æ–¼é–±è®€ã€‚`;
                            break;
                        case 'drawdown':
                            if (this.trades.length < 2) return {};
                            const plHistory = [...this.trades].sort((a, b) => new Date(a.date) - new Date(b.date)).map(t => (t.plAmount || 0).toFixed(2));
                            systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„äº¤æ˜“ç¸¾æ•ˆåˆ†æå¸«ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä½ çš„ä»»å‹™æ˜¯è¨ˆç®—ä¸¦è§£é‡‹ã€Œæœ€å¤§å›æ’¤ (Max Drawdown)ã€ã€‚ä½ çš„è§£é‡‹éœ€è¦æ¸…æ™°ã€ç°¡æ½”ï¼Œä¸¦å°äº¤æ˜“è€…æœ‰å¯¦éš›çš„æŒ‡å°æ„ç¾©ã€‚";
                            userQuery = `é€™æ˜¯ä¸€å€‹äº¤æ˜“è€…çš„ç›ˆè™§æ­·å²è¨˜éŒ„ (P/L) åˆ—è¡¨ (æŒ‰æ™‚é–“é †åº)ï¼š[${plHistory.join(', ')}]\n\nè«‹æ ¹æ“šé€™å€‹åˆ—è¡¨å®Œæˆä»¥ä¸‹ä»»å‹™ï¼š\n1.  è¨ˆç®—ä¸¦æ˜ç¢ºæŒ‡å‡ºã€Œæœ€å¤§å›æ’¤ã€çš„é‡‘é¡ (USD)ã€‚\n2.  æŒ‡å‡ºé€™æ¬¡æœ€å¤§å›æ’¤ç™¼ç”Ÿåœ¨å“ªå€‹è³‡æœ¬å³°å€¼ (Peak) å’Œå“ªå€‹è³‡æœ¬è°·åº• (Trough)ã€‚\n3.  ç”¨ä¸€å…©å¥è©±ç°¡è¦è§£é‡‹é€™å€‹æœ€å¤§å›æ’¤å°è©²äº¤æ˜“è€…æ„å‘³è‘—ä»€éº¼ï¼Œä»¥åŠå®ƒåœ¨é¢¨éšªç®¡ç†ä¸­çš„é‡è¦æ€§ã€‚`;
                            break;
                        case 'emotion':
                            const tradesWithEmotions = this.trades.filter(t => t.emotions && t.emotions.trim() !== '');
                            if (tradesWithEmotions.length < 1) { alert('éœ€è¦è‡³å°‘ä¸€ç­†å¸¶æœ‰ã€Œæƒ…ç·’æ¨™ç±¤ã€çš„äº¤æ˜“è¨˜éŒ„æ‰èƒ½é€²è¡Œåˆ†æã€‚'); return {}; }
                            const emotionData = tradesWithEmotions.reduce((acc, trade) => { const emotions = trade.emotions.split(',').map(e => e.trim().toLowerCase()); emotions.forEach(emotion => { if (!acc[emotion]) { acc[emotion] = []; } acc[emotion].push(trade.rMultiple.toFixed(2)); }); return acc; }, {});
                            systemPrompt = "ä½ æ˜¯ä¸€ä½é ‚å°–çš„äº¤æ˜“å¿ƒç†å­¸å®¶å’Œç¸¾æ•ˆæ•™ç·´ã€‚ä½ çš„å°ˆé•·æ˜¯åˆ†æäº¤æ˜“è€…çš„æƒ…ç·’æ¨¡å¼ï¼Œä¸¦æ‰¾å‡ºå…¶å°äº¤æ˜“çµæœçš„å½±éŸ¿ã€‚ä½ çš„èªæ°£å¿…é ˆå……æ»¿æ´å¯ŸåŠ›ã€å…·å»ºè¨­æ€§ä¸”å¯ŒåŒç†å¿ƒã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
                            userQuery = `ä½ å¥½ï¼Œè«‹å¹«æˆ‘åˆ†ææˆ‘çš„äº¤æ˜“æƒ…ç·’æ•¸æ“šã€‚é€™æ˜¯ä¸€ä»½æ ¹æ“šæˆ‘çš„ã€Œæƒ…ç·’æ¨™ç±¤ã€åˆ†é¡çš„äº¤æ˜“çµæœï¼Œæ•¸å€¼ç‚ºRå€æ•¸ï¼ˆR-multipleï¼‰ï¼š ${JSON.stringify(emotionData, null, 2)} è«‹æ ¹æ“šé€™ä»½æ•¸æ“šï¼Œæä¾›ä¸€ä»½ç°¡æ½”ä½†æ·±å…¥çš„åˆ†æå ±å‘Šï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰é»ï¼š 1. **é—œéµè§€å¯Ÿ**: æœ€é¡¯è‘—çš„æ¨¡å¼æ˜¯ä»€éº¼ï¼Ÿå“ªä¸€ç¨®æˆ–å“ªå¹¾ç¨®æƒ…ç·’èˆ‡æˆ‘æœ€å¥½çš„äº¤æ˜“ï¼ˆé«˜Rå€æ•¸ï¼‰ç›¸é—œï¼Ÿå“ªå¹¾ç¨®åˆèˆ‡æœ€å·®çš„äº¤æ˜“ï¼ˆè² Rå€æ•¸ï¼‰ç›¸é—œï¼Ÿ 2. **å¿ƒç†æ´å¯Ÿ**: æ ¹æ“šé€™å€‹æ¨¡å¼ï¼Œé€™å¯èƒ½åæ˜ äº†æˆ‘å“ªæ–¹é¢çš„å¿ƒç†åèª¤æˆ–è¡Œç‚ºå‚¾å‘ï¼Ÿï¼ˆä¾‹å¦‚ï¼šèˆ‡FOMOç›¸é—œçš„è™§æå¯èƒ½ä»£è¡¨è¡å‹•äº¤æ˜“ï¼‰ã€‚ 3. **å¯è¡Œå»ºè­°**: æä¾›ä¸€å€‹å…·é«”ã€å¯ä»¥ç«‹å³åŸ·è¡Œçš„å»ºè­°ï¼Œä¾†å¹«åŠ©æˆ‘æ›´å¥½åœ°ç®¡ç†é€™äº›æƒ…ç·’ï¼Œä¸¦å°‡å…¶è½‰åŒ–ç‚ºäº¤æ˜“å„ªå‹¢ã€‚ è«‹å°‡å ±å‘Šé‡é»æ¢åˆ—åŒ–ï¼Œä½¿å…¶æ¸…æ™°æ˜“è®€ã€‚`;
                            break;
                        case 'modelBook':
                             if (this.modelBooks.length < 2) { alert('éœ€è¦è‡³å°‘å…©å€‹æ¨¡å‹æ‰èƒ½é€²è¡Œ AI å…±é€šç‰¹å¾µåˆ†æã€‚'); return {}; }
                            const modelData = this.modelBooks.map(m => ({ pattern: m.pattern, sector: m.sector, takeaways: m.takeaways, performance: m.performance }));
                            systemPrompt = "ä½ æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„é‡åŒ–åˆ†æå¸«å’Œåœ–è¡¨å½¢æ…‹å°ˆå®¶ï¼Œå°ˆé•·æ˜¯å¾æˆåŠŸçš„äº¤æ˜“æ¡ˆä¾‹ä¸­æ­¸ç´å‡ºé«˜å‹ç‡çš„å…±é€šæ¨¡å¼ã€‚ä½ çš„åˆ†æå¿…é ˆæ•¸æ“šé©…å‹•ã€å®¢è§€ä¸”ä¸€é‡è¦‹è¡€ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
                            userQuery = `é€™æ˜¯æˆ‘æ•´ç†çš„æˆåŠŸäº¤æ˜“ã€Œæ¨¡å‹åº« (Model Book)ã€ï¼Œè£¡é¢åŒ…å«äº†æˆ‘èªç‚ºå€¼å¾—å­¸ç¿’çš„æ¡ˆä¾‹ï¼š\n${JSON.stringify(modelData, null, 2)}\n\nè«‹æ·±å…¥åˆ†æä»¥ä¸Šæ‰€æœ‰æ¡ˆä¾‹ï¼Œä¸¦ç‚ºæˆ‘ç¸½çµå‡ºé€™äº›æˆåŠŸäº¤æ˜“èƒŒå¾Œçš„ **3 åˆ° 5 å€‹æœ€é—œéµçš„å…±é€šç‰¹å¾µ**ã€‚\nè«‹å°ˆæ³¨æ–¼ä»¥ä¸‹å¹¾å€‹æ–¹é¢ï¼š\n1.  **å‹æ…‹ (Pattern)**: æ˜¯å¦æœ‰æŸç¨®ç‰¹å®šçš„åœ–è¡¨å‹æ…‹ï¼ˆå¦‚ VCP, æ¯æŸ„ï¼‰åè¦†å‡ºç¾ï¼Ÿ\n2.  **è¡Œæ¥­ (Sector)**: é€™äº›æˆåŠŸçš„è‚¡ç¥¨æ˜¯å¦é›†ä¸­åœ¨æŸå¹¾å€‹ç‰¹å®šçš„è¡Œæ¥­æ¿å¡Šï¼Ÿ\n3.  **é—œéµé©…å‹•å› ç´ **: æ ¹æ“šã€Œå¿ƒå¾— (Takeaways)ã€å’Œã€Œè¡¨ç¾ (Performance)ã€ï¼ŒæˆåŠŸçš„æ ¸å¿ƒé©…å‹•åŠ›æ˜¯ä»€éº¼ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¼·å‹çš„ç›ˆåˆ©å¢é•·ã€è¡Œæ¥­é¾é ­åœ°ä½ã€çªç ´å‰æˆäº¤é‡èç¸®ç­‰ï¼‰ã€‚\n\nè«‹å°‡ä½ çš„ç™¼ç¾ä»¥æ¢åˆ—å¼é‡é»å‘ˆç¾ï¼Œè®“æˆ‘èƒ½å¿«é€Ÿå»ºç«‹ä¸€å€‹å¯ä¾å¾ªçš„ã€Œæ¨¡å‹æ¸…å–®ã€ã€‚`;
                            break;
                        case 'performanceReview':
                            if (this.trades.length < 1) { alert('éœ€è¦è‡³å°‘ä¸€ç­†äº¤æ˜“è¨˜éŒ„æ‰èƒ½ç”Ÿæˆåˆ†æå ±å‘Šã€‚'); return {}; }
                            const perfSummary = `ç¸½äº¤æ˜“æ•¸: ${this.performance.totalTrades}, å‹ç‡: ${this.performance.winRate.toFixed(2)}%, ç¸½ç›ˆè™§: ${this.formatCurrency(this.performance.totalPl, 'USD')} USD, å¹³å‡Rå€¼: ${this.performance.avgR.toFixed(2)} R`;
                            const tradeSamples = this.trades.slice(0, 50).map(t => ({ date: t.date, ticker: t.ticker, direction: t.direction, rMultiple: t.rMultiple.toFixed(2), emotions: t.emotions, setup: t.setup }));
                            systemPrompt = "ä½ æ˜¯ä¸€ä½é ‚å°–çš„äº¤æ˜“ç¸¾æ•ˆæ•™ç·´ï¼Œå°ˆé–€åˆ†æäº¤æ˜“æ—¥èªŒä»¥æ‰¾å‡ºæ¨¡å¼ã€å„ªå‹¢å’ŒåŠ£å‹¢ã€‚ä½ çš„èªæ°£æ‡‰å……æ»¿æ”¯æŒæ€§ã€å»ºè¨­æ€§ï¼Œä¸¦æä¾›å¯è¡Œçš„å»ºè­°ã€‚ä½ å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä½ çš„ç›®æ¨™æ˜¯å¹«åŠ©äº¤æ˜“è€…å¾ä»–å€‘çš„æ­·å²è¨˜éŒ„ä¸­å­¸ç¿’ï¼Œä¸¦ç‚ºæœªä¾†è¨­å®šæ¸…æ™°çš„ç›®æ¨™ã€‚";
                            userQuery = `ä½ å¥½ï¼Œè«‹åˆ†ææˆ‘çš„äº¤æ˜“ç¸¾æ•ˆã€‚é€™æ˜¯æˆ‘çš„ç¸½é«”ç¸¾æ•ˆæ‘˜è¦ï¼š ${perfSummary} é€™æ˜¯æˆ‘æœ€è¿‘çš„äº¤æ˜“è¨˜éŒ„æ¨£æœ¬ï¼ˆJSONæ ¼å¼ï¼‰ï¼š ${JSON.stringify(tradeSamples, null, 2)} è«‹æ ¹æ“šä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œç‚ºæˆ‘ç”Ÿæˆä¸€ä»½äº¤æ˜“å›é¡§å ±å‘Šã€‚è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ä½ çš„åˆ†æï¼Œä¸è¦åŒ…å«ä»»ä½• JSON æ ¼å¼ä»¥å¤–çš„æ–‡å­—æˆ–è§£é‡‹ï¼š { "monthlyPerformance": "å°æœ¬æœˆçš„æ•´é«”è¡¨ç¾é€²è¡Œç¸½çµã€‚æåŠé—œéµæŒ‡æ¨™ã€æœ€è³ºéŒ¢/è™§éŒ¢çš„äº¤æ˜“ç­–ç•¥(setup)ï¼Œä»¥åŠæœ€å¸¸å‡ºç¾çš„æƒ…ç·’(emotions)ã€‚", "areasToImprove": "æ ¹æ“šæ•¸æ“šï¼ˆç‰¹åˆ¥æ˜¯æƒ…ç·’å’Œè™§æäº¤æ˜“ï¼‰ï¼Œæ‰¾å‡º1-2å€‹æœ€éœ€è¦æ”¹å–„çš„å…·é«”å•é¡Œã€‚ä¾‹å¦‚ï¼Œè™•ç† FOMOã€éæ—©æ­¢ç›ˆç­‰ã€‚", "nextMonthGoals": "åŸºæ–¼éœ€è¦æ”¹å–„çš„åœ°æ–¹ï¼Œè¨­å®š1-2å€‹æ¸…æ™°ã€å¯åŸ·è¡Œçš„ä¸‹æœˆç›®æ¨™ã€‚ä¾‹å¦‚ï¼Œã€åªäº¤æ˜“A+ç´šåˆ¥çš„è¨­å®šã€æˆ–ã€æ¯ç­†äº¤æ˜“å‰å¡«å¯«æª¢æŸ¥æ¸…å–®ã€ã€‚" }`;
                            break;
                    }
                    return { systemPrompt, userQuery };
                },
                
                async getAiDashboardSummary() { const { systemPrompt, userQuery } = this.getAiPrompts('dashboardSummary'); if (!userQuery) return; this.aiDashboardSummary = await this.callAiApi(systemPrompt, userQuery); },
                async askAi() { if(!this.aiQuery) return; const { systemPrompt, userQuery } = this.getAiPrompts('askAi'); this.aiDashboardSummary = `<blockquote><strong>ä½ çš„æå•:</strong> ${this.aiQuery}</blockquote><br><p>AI æ­£åœ¨æ€è€ƒä¸­...</p>`; const answer = await this.callAiApi(systemPrompt, userQuery); this.aiDashboardSummary = `<blockquote><strong>ä½ çš„æå•:</strong> ${this.aiQuery}</blockquote><br>${answer}`; this.aiQuery = ''; },
                async getAiAnalysis() { const { systemPrompt, userQuery } = this.getAiPrompts('riskAnalysis'); this.aiAnalysisResult = await this.callAiApi(systemPrompt, userQuery); },
                async getAiDrawdownAnalysis() { const { systemPrompt, userQuery } = this.getAiPrompts('drawdown'); if (!userQuery) return; this.maxDrawdownAnalysis = await this.callAiApi(systemPrompt, userQuery); },
                async getAiEmotionAnalysis() { const { systemPrompt, userQuery } = this.getAiPrompts('emotion'); if (!userQuery) return; this.aiEmotionAnalysisResult = await this.callAiApi(systemPrompt, userQuery); },
                async getAiModelBookAnalysis() { const { systemPrompt, userQuery } = this.getAiPrompts('modelBook'); if (!userQuery) return; this.aiModelBookAnalysis = await this.callAiApi(systemPrompt, userQuery); },
                async getAiPerformanceReview() {
                    const { systemPrompt, userQuery } = this.getAiPrompts('performanceReview'); if (!userQuery) return;
                    this.isLoading = true; this.reviewNotes = { monthly: '', improve: '', goals: '' };
                    try {
                        const rawResponse = await this.callAiApi(systemPrompt, userQuery, false, true);
                        const jsonMatch = rawResponse.match(/\{[\s\S]*\}/);
                        if (jsonMatch) { const parsedResponse = JSON.parse(jsonMatch[0]); this.reviewNotes.monthly = parsedResponse.monthlyPerformance || 'AI æœªèƒ½ç”Ÿæˆæ­¤éƒ¨åˆ†çš„å…§å®¹ã€‚'; this.reviewNotes.improve = parsedResponse.areasToImprove || 'AI æœªèƒ½ç”Ÿæˆæ­¤éƒ¨åˆ†çš„å…§å®¹ã€‚'; this.reviewNotes.goals = parsedResponse.nextMonthGoals || 'AI æœªèƒ½ç”Ÿæˆæ­¤éƒ¨åˆ†çš„å…§å®¹ã€‚';
                        } else { throw new Error("AI å›æ‡‰ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„ JSON å…§å®¹ã€‚"); }
                    } catch (error) { console.error("Error parsing AI performance review:", error); this.reviewNotes.monthly = `ç”Ÿæˆå¤±æ•—ï¼š${error.message}`;
                    } finally { this.isLoading = false; }
                }
            }
        }
        
        Alpine.data('tradingApp', tradingApp);
        Alpine.start();
    </script>
</body>
</html>
