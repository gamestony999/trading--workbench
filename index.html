<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易工作台 (AI 專業版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
        }
        .input-group { 
            display: flex; 
            align-items: center; 
            background-color: #374151; /* gray-700 */
            border-radius: 0.5rem; 
            border: 1px solid #4b5563; /* gray-600 */
        }
        .input-group span { 
            padding-left: 0.75rem; 
            color: #9ca3af; /* gray-400 */
        }
        .input-group input, .input-group select, .input-group textarea { 
            background-color: transparent; 
            border: none; 
            outline: none; 
            width: 100%; 
            padding: 0.75rem; 
            color: white; 
        }
        .risk-btn, .tab-btn { 
            transition: all 0.2s ease-in-out; 
            padding: 0.75rem 1rem; 
            border-bottom: 2px solid transparent; 
            white-space: nowrap; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: #9ca3af; /* gray-400 */
        }
        .tab-btn:hover { 
            color: white; 
            border-color: #4b5563; /* gray-600 */
        }
        .tab-btn.active { 
            background-color: #1f2937; /* gray-800 */
            color: #3b82f6; /* blue-500 */
            font-weight: 600; 
            border-color: #3b82f6; /* blue-500 */
        }
        [x-cloak] { 
            display: none !important; 
        }
        .modal-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: rgba(0, 0, 0, 0.75); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 50; 
        }
        .modal-content { 
            background-color: #1f2937; /* gray-800 */
            padding: 1rem; 
            border-radius: 0.5rem; 
            max-width: 90vw; 
            max-height: 90vh; 
            overflow: auto; 
        }
        .search-input { 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 12px center; 
            padding-left: 40px; 
        }
        
        /* Calendar Styles */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, minmax(0, 1fr)); 
        }
        .calendar-day { 
            min-height: 120px; 
        }
        .calendar-day.other-month { 
            background-color: rgba(31, 41, 55, 0.5); 
        }
        .day-pl.profit { 
            background-color: rgba(16, 185, 129, 0.2); 
            border-left: 3px solid #10B981; 
        }
        .day-pl.loss { 
            background-color: rgba(239, 68, 68, 0.2); 
            border-left: 3px solid #EF4444; 
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8" x-data="tradingApp()" x-init="init()">

    <div x-show="!isInitialized" class="min-h-screen flex items-center justify-center text-center">
        <div>
            <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-gray-400">正在連接雲端...</p>
        </div>
    </div>

    <div x-show="isInitialized && !isLoggedIn" x-cloak class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
            <h2 class="text-2xl font-bold text-center text-blue-400 mb-6" x-text="authView === 'login' ? '登入工作台' : '註冊新帳號'"></h2>
            <form @submit.prevent="authView === 'login' ? login() : register()">
                <div class="space-y-4">
                    <div><label for="email" class="block text-sm font-medium text-gray-300">電子郵件</label><input id="email" type="email" x-model="authForm.email" required class="w-full bg-gray-700 rounded p-2 mt-1 border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="password" class="block text-sm font-medium text-gray-300">密碼</label><input id="password" type="password" x-model="authForm.password" required class="w-full bg-gray-700 rounded p-2 mt-1 border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></div>
                </div>
                <p x-show="authError" class="text-red-400 text-sm mt-4" x-text="authError"></p>
                <div class="mt-6"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="authView === 'login' ? '登入' : '註冊'"></button></div>
            </form>
            <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400">或</span></div></div>
            <div><button @click.prevent="loginWithGoogle()" class="w-full inline-flex justify-center py-2 px-4 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-sm font-medium text-white hover:bg-gray-600"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg><span>使用 Google 登入</span></button></div>
            <div class="mt-4 text-center"><button @click="authView = (authView === 'login' ? 'register' : 'login')" class="text-sm text-gray-400 hover:text-white" x-text="authView === 'login' ? '還沒有帳號？註冊一個' : '已經有帳號？前往登入'"></button></div>
        </div>
    </div>

    <div x-show="isInitialized && isLoggedIn" x-cloak class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                 <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-blue-400">交易工作台 ✨</h1>
                    <p class="text-gray-400 mt-2">由 AI 驅動的整合式交易分析系統</p>
                 </div>
                 <div class="relative w-full md:w-1/3">
                    <input type="text" x-model="searchTerm" @input.debounce.300ms="search" placeholder="搜尋交易日誌、Playbook..." class="search-input w-full bg-gray-800 border border-gray-700 rounded-full py-2 px-4 text-white focus:ring-blue-500 focus:border-blue-500">
                    <div x-show="searchTerm && searchResults.length > 0" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg max-h-80 overflow-y-auto">
                        <ul><template x-for="item in searchResults" :key="item.id"><li @click="goToSearchResult(item)" class="px-4 py-3 hover:bg-gray-700 cursor-pointer"><p class="font-semibold text-white" x-text="item.ticker || item.name"></p><p class="text-sm text-gray-400" x-text="`${item.type} - ${item.date || item.pattern || item.strategyName}`"></p></li></template></ul>
                    </div>
                 </div>
            </div>
            <div class="tradingview-widget-container mt-6">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                { "symbols": [ { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" }, { "proName": "FOREXCOM:NSXUSD", "title": "US 100" }, { "proName": "FX_IDC:EURUSD", "title": "EUR/USD" }, { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" }, { "proName": "BITSTAMP:ETHUSD", "title": "Ethereum" }, { "proName": "HSI:HSI", "title": "Hang Seng" } ], "showSymbolLogo": true, "colorTheme": "dark", "isTransparent": false, "displayMode": "adaptive" }
                </script>
            </div>
        </header>

        <div class="mb-6">
            <div class="border-b border-gray-700">
                 <nav class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto" aria-label="Tabs">
                    <button @click="activeTab = 'dashboard'" :class="{ 'active': activeTab === 'dashboard' }" class="tab-btn">儀表板</button>
                    <button @click="activeTab = 'tradingView'" :class="{ 'active': activeTab === 'tradingView' }" class="tab-btn">市場圖表</button>
                    <button @click="activeTab = 'reflection'" :class="{ 'active': active-tab === 'reflection' }" class="tab-btn">自我反思</button>
                    <button @click="activeTab = 'marketJournal'" :class="{ 'active': activeTab === 'marketJournal' }" class="tab-btn">市場日誌</button>
                    <button @click="activeTab = 'buyPlan'" :class="{ 'active': activeTab === 'buyPlan' }" class="tab-btn">買入計劃</button>
                    <button @click="activeTab = 'journal'" :class="{ 'active': activeTab === 'journal' }" class="tab-btn">交易日誌</button>
                    <button @click="activeTab = 'playbook'" :class="{ 'active': activeTab === 'playbook' }" class="tab-btn">Playbook</button>
                    <button @click="activeTab = 'modelBook'" :class="{ 'active': activeTab === 'modelBook' }" class="tab-btn">Model Book</button>
                    <button @click="activeTab = 'performance'" :class="{ 'active': activeTab === 'performance' }" class="tab-btn">績效回顧</button>
                    <button @click="activeTab = 'settings'" :class="{ 'active': activeTab === 'settings' }" class="tab-btn">設定</button>
                </nav>
            </div>
        </div>
         
        <div class="flex justify-between items-center text-center mb-4 text-xs text-gray-500">
            <p>User ID: <span x-text="userId || 'N/A'"></span></p>
            <button @click="logout()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-lg text-xs">登出</button>
        </div>
        
        <div x-show="activeTab === 'dashboard'" x-cloak>
            <div class="space-y-8">

                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg"><h3 class="text-sm font-medium text-gray-400">總盈虧</h3><p class="mt-2 text-2xl font-bold" :class="performance.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(performance.totalPl, 'USD')"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg"><h3 class="text-sm font-medium text-gray-400">勝率</h3><p class="mt-2 text-2xl font-bold" x-text="`${performance.winRate.toFixed(2)}%`"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg"><h3 class="text-sm font-medium text-gray-400">利潤因子</h3><p class="mt-2 text-2xl font-bold" x-text="metrics.profitFactor.toFixed(2)"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg"><h3 class="text-sm font-medium text-gray-400">平均盈虧比</h3><p class="mt-2 text-2xl font-bold" x-text="metrics.avgWinLossRatio.toFixed(2)"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg"><h3 class="text-sm font-medium text-gray-400">總交易數</h3><p class="mt-2 text-2xl font-bold" x-text="performance.totalTrades"></p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-3 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-blue-300">資金曲線</h2>
                            <div class="input-group w-48">
                                <span class="text-lg font-bold text-blue-400">$</span>
                                <input type="number" x-model.number="settings.usdPrincipal" @blur="saveSettings(true)" placeholder="戶口本金" class="text-lg font-bold text-blue-400 bg-gray-700/50 rounded-md">
                            </div>
                        </div>
                        <div class="h-96"><canvas id="dashboardPlChart"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                         <h2 class="text-xl font-semibold mb-4 text-blue-300">交易者評分</h2>
                         <div class="relative h-80"><canvas id="hexagonScoreChart"></canvas></div>
                         <div class="text-center mt-4">
                            <p class="text-gray-400 text-sm">綜合分數</p>
                            <p class="text-4xl font-bold text-blue-400" x-text="metrics.totalScore.toFixed(1)"></p>
                         </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-blue-300">交易日曆</h2>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                            <div class="flex items-center gap-2">
                                <button @click="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-700" aria-label="Previous Month">&larr;</button>
                                <button @click="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-700" aria-label="Next Month">&rarr;</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <select x-model.number="calendar.year" @change="generateCalendar()" class="w-28 bg-gray-700 border border-gray-600 rounded-md p-2">
                                    <template x-for="y in calendar.yearOptions">
                                        <option :value="y" x-text="y"></option>
                                    </template>
                                </select>
                                <select x-model.number="calendar.month" @change="generateCalendar()" class="w-24 bg-gray-700 border border-gray-600 rounded-md p-2">
                                    <template x-for="m in 12">
                                         <option :value="m-1" x-text="`${m} 月`"></option>
                                    </template>
                                </select>
                            </div>
                             <button @click="goToToday()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">回到本月</button>
                        </div>
                        <div class="calendar-grid border-t border-l border-gray-700">
                            <template x-for="day in ['日', '一', '二', '三', '四', '五', '六']">
                                 <div class="text-center font-semibold text-xs text-gray-400 py-2 border-r border-b border-gray-700" x-text="day"></div>
                            </template>
                            <template x-for="day in calendar.days" :key="day.date">
                                 <div class="calendar-day p-2 border-r border-b border-gray-700 relative" :class="{'other-month': !day.isCurrentMonth}">
                                    <span class="text-sm" :class="{'text-gray-500': !day.isCurrentMonth, 'font-bold text-blue-400': day.isToday}" x-text="day.dayOfMonth"></span>
                                    <div x-show="day.pl !== 0" class="day-pl mt-2 p-2 rounded-md text-xs space-y-1 cursor-pointer hover:bg-gray-600/50">
                                        <p class="font-bold" :class="day.pl > 0 ? 'text-green-400' : 'text-red-400'" x-text="`P/L: ${formatCurrency(day.pl)}`"></p>
                                        <p class="text-gray-400" x-text="`筆數: ${day.tradeCount}`"></p>
                                    </div>
                                 </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-blue-300">市場羅盤</h2>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <p class="text-gray-500">市場羅盤功能區 (保留)</p>
                    </div>
                </div>

            </div>
        </div>

        <div x-show="activeTab === 'tradingView'" x-cloak class="space-y-8">
            <div class="h-[70vh] bg-gray-800 rounded-xl">
                <div class="tradingview-widget-container" style="height:100%;width:100%"><div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div><script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>{ "allow_symbol_change": true, "calendar": false, "details": true, "hide_side_toolbar": false, "hide_top_toolbar": false, "hide_legend": false, "hide_volume": false, "hotlist": true, "interval": "D", "save_image": true, "style": "1", "symbol": "NASDAQ:AAPL", "theme": "dark", "timezone": "Etc/UTC", "backgroundColor": "rgba(15, 15, 15, 1)", "gridColor": "rgba(242, 242, 242, 0.06)", "watchlist": [], "withdateranges": true, "range": "YTD", "studies": [], "autosize": true }</script></div>
            </div>
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-blue-300">市場熱圖 (Market Heatmap)</h2>
                <div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div><script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js" async>{ "dataSource": "SPX500", "blockSize": "market_cap_basic", "blockColor": "change", "grouping": "sector", "symbolUrl": "", "colorTheme": "dark", "exchanges": [], "hasTopBar": true, "isDataSetEnabled": true, "isZoomEnabled": true, "hasSymbolTooltip": true, "isMonoSize": false, "width": "100%", "height": 700 }</script></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                     <h2 class="text-2xl font-semibold mb-4 text-blue-300">頭條新聞 (Top Stories)</h2>
                     <div class="tradingview-widget-container" style="height: 700px;"><div class="tradingview-widget-container__widget"></div><script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>{ "displayMode": "regular", "feedMode": "all_symbols", "colorTheme": "dark", "isTransparent": false, "width": "100%", "height": "100%" }</script></div>
                </div>
                <div>
                     <h2 class="text-2xl font-semibold mb-4 text-blue-300">市場新聞 (Market News)</h2>
                     <div class="tradingview-widget-container" style="height: 700px;"><div class="tradingview-widget-container__widget"></div><script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>{ "feedMode": "market", "market": "us", "isTransparent": false, "displayMode": "regular", "width": "100%", "height": "100%", "colorTheme": "dark" }</script></div>
                </div>
            </div>
        </div>
        <div x-show="activeTab === 'reflection'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingReflectionId ? '編輯反思' : '新增自我反思'"></h2>
                    <form @submit.prevent="saveReflection" class="space-y-4">
                        <div><label class="block text-sm">日期</label><input type="date" x-model="reflectionForm.date" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">需要改善的問題</label><input type="text" x-model="reflectionForm.problem" required class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="例如: 過早止盈、FOMO追高..."></div>
                         <div><label class="block text-sm">詳細發現與思考</label><textarea x-model="reflectionForm.thoughts" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="記錄下當時的想法、情緒和事後分析..."></textarea></div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingReflectionId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetReflectionForm" x-show="editingReflectionId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                        </div>
                    </form>
                 </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">歷史反思列表</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <template x-for="entry in reflections" :key="entry.id">
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                     <p class="font-bold text-lg text-yellow-300" x-text="entry.problem"></p>
                                    <div>
                                        <button @click="editReflection(entry)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                         <button @click="deleteReflection(entry.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1" x-text="entry.date"></p>
                                <p class="text-sm mt-2 whitespace-pre-wrap" x-text="entry.thoughts"></p>
                            </div>
                        </template>
                        <div x-show="reflections.length === 0" class="text-center py-16 text-gray-500">暫無反思記錄</div>
                    </div>
                </div>
             </div>
        </div>

        <div x-show="activeTab === 'marketJournal'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingMarketJournalId ? '編輯日誌' : '新增市場日誌'"></h2>
                    <form @submit.prevent="saveMarketJournal" class="space-y-4">
                        <div><label class="block text-sm">日期</label><input type="date" x-model="marketJournalForm.date" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">大盤走勢摘要</label><textarea x-model="marketJournalForm.marketSummary" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="例如: S&P 500 盤整，NASDAQ 強勢..."></textarea></div>
                         <div><label class="block text-sm">領漲板塊</label><input type="text" x-model="marketJournalForm.leadingSectors" placeholder="半導體, 軟件..." class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">觀察股清單</label><textarea x-model="marketJournalForm.watchlist" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="NVDA, PLTR..."></textarea></div>
                        <div><label class="block text-sm">心理狀態 / Mindset</label><textarea x-model="marketJournalForm.mindset" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="冷靜, 焦慮, 有信心..."></textarea></div>
                        <div><label class="block text-sm">市場氛圍指數 (1-5)</label><input type="range" min="1" max="5" x-model.number="marketJournalForm.sentiment" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"><div class="text-center" x-text="marketJournalForm.sentiment"></div></div>
                        <div><label class="block text-sm">總結 (進攻/防守)</label><textarea x-model="marketJournalForm.summary" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="目前適合積極進攻/保持防守, 因為..."></textarea></div>
                         <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingMarketJournalId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetMarketJournalForm" x-show="editingMarketJournalId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                        </div>
                    </form>
                 </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">過往日誌</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <template x-for="entry in marketJournals" :key="entry.id">
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                     <p class="font-bold text-lg" x-text="entry.date"></p>
                                    <div>
                                        <button @click="editMarketJournal(entry)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                         <button @click="deleteMarketJournal(entry.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                    </div>
                                </div>
                                 <p class="text-sm mt-2"><strong class="text-gray-400">大盤:</strong> <span x-text="entry.marketSummary"></span></p>
                                <p class="text-sm"><strong class="text-gray-400">領漲:</strong> <span x-text="entry.leadingSectors"></span></p>
                                 <p class="text-sm"><strong class="text-gray-400">總結:</strong> <span x-text="entry.summary"></span></p>
                            </div>
                        </template>
                        <div x-show="marketJournals.length === 0" class="text-center py-16 text-gray-500">暫無市場日誌</div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'buyPlan'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit">
                     <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingBuyPlanId ? '編輯計劃' : '新增買入計劃'"></h2>
                    <form @submit.prevent="saveBuyPlan" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">名稱</label><input type="text" x-model="buyPlanForm.name" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                             <div><label class="block text-sm">代號</label><input type="text" x-model="buyPlanForm.ticker" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div><label class="block text-sm">行業</label><input type="text" x-model="buyPlanForm.sector" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                            <div><label class="block text-sm">型態</label><input type="text" x-model="buyPlanForm.pattern" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        
                        <div><label class="block text-sm">關鍵買點 (Pivot)</label><input type="number" step="any" x-model.number="buyPlanForm.pivot" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">停損價</label><input type="number" step="any" x-model.number="buyPlanForm.stopLoss" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                             <div><label class="block text-sm">目標價</label><input type="number" step="any" x-model.number="buyPlanForm.target" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div><label class="block text-sm">理由 / Rationale</label><textarea x-model="buyPlanForm.rationale" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                        <div>
                             <label class="block text-sm">股價圖片</label>
                            <input type="file" @change="handleImageUpload($event, buyPlanForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                             <template x-if="buyPlanForm.chartImage"><div class="relative mt-2"><img :src="buyPlanForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="buyPlanForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingBuyPlanId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetBuyPlanForm" x-show="editingBuyPlanId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                        </div>
                    </form>
                 </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                     <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">待執行計劃</h2>
                     <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <template x-for="plan in buyPlans" :key="plan.id">
                            <div class="bg-gray-700/50 p-4 rounded-lg flex items-start gap-4">
                               <img :src="plan.chartImage || 'https://placehold.co/120x90/1f2937/9ca3af?text=No+Chart'" @click="openChartModal(plan.chartImage)" class="w-32 h-24 object-cover rounded-md cursor-pointer flex-shrink-0">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start">
                                         <div>
                                            <p class="font-bold text-lg" x-text="`${plan.name} (${plan.ticker})`"></p>
                                             <p class="text-sm text-gray-400" x-text="plan.pattern"></p>
                                        </div>
                                        <div>
                                             <button @click="editBuyPlan(plan)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                            <button @click="deleteBuyPlan(plan.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                         </div>
                                    </div>
                                     <p class="text-sm mt-2"><strong class="text-gray-400">買點:</strong> <span x-text="plan.pivot"></span> | <strong class="text-gray-400">止損:</strong> <span x-text="plan.stopLoss"></span></p>
                                    <p class="text-sm mt-1"><strong class="text-gray-400">理由:</strong> <span x-text="plan.rationale"></span></p>
                                </div>
                             </div>
                        </template>
                         <div x-show="buyPlans.length === 0" class="text-center py-16 text-gray-500">暫無買入計劃</div>
                    </div>
                </div>
             </div>
        </div>

        <div x-show="activeTab === 'journal'" x-cloak>
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 mb-6">
                <h3 class="text-lg font-semibold text-blue-300 mb-3">快速注碼計算器 v2.0</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                    <div class="lg:col-span-1">
                        <label class="text-xs text-gray-400">戶口本金</label>
                         <p class="text-lg font-bold" x-text="formatCurrency(settings.usdPrincipal, 'USD')"></p>
                    </div>
                    <div>
                        <label for="qsStopLoss" class="text-xs text-gray-400">止損幅度 (%)</label>
                        <input type="number" id="qsStopLoss" x-model.number="quickSizer.stopLossPercent" @input="updateQuickSizer()" class="w-full bg-gray-700 rounded p-2 mt-1">
                    </div>
                    <div>
                        <label for="qsRiskPercent" class="text-xs text-gray-400">風險倉位 (%)</label>
                        <input type="number" id="qsRiskPercent" x-model.number="quickSizer.riskPercent" @input="updateQuickSizer()" class="w-full bg-gray-700 rounded p-2 mt-1">
                    </div>
                    <div class="lg:col-span-2">
                        <label class="text-xs text-gray-400">計算結果</label>
                        <div class="flex items-baseline space-x-2 mt-1">
                            <p class="text-md font-semibold text-yellow-400" x-text="`1R = ${formatCurrency(quickSizer.riskAmount, 'USD')}`"></p>
                            <p class="text-md font-semibold text-green-400" x-text="`買入 = ${formatCurrency(quickSizer.positionSize, quickSizer.displayCurrency)}`"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <select x-model="quickSizer.displayCurrency" class="w-full bg-gray-700 rounded p-2 h-11">
                            <template x-for="currency in Object.keys(exchangeRates.rates || {})">
                                <option :value="currency" x-text="currency"></option>
                            </template>
                         </select>
                         <button @click="applyQuickSizer()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-3 rounded-lg h-11">套用</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                 <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingTradeId ? '編輯主交易' : '新增主交易 (開倉)'"></h2>
                    <form @submit.prevent="saveTrade" class="space-y-4">
                        <div> <label class="block text-sm">開倉日期</label> <input type="date" x-model="journalForm.entryDate" required class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                        <div> <label class="block text-sm">代號</label> <input type="text" x-model="journalForm.ticker" placeholder="AAPL" required class="w-full bg-gray-700 rounded p-2 mt-1"> </div>
                        <div> <label class="block text-sm">方向</label> <select x-model="journalForm.direction" class="w-full bg-gray-700 rounded p-2 mt-1"> <option>Long</option> <option>Short</option> </select> </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">風險倉位 (%)</label><input type="number" step="0.01" x-model.number="journalForm.riskPercent" placeholder="1.0" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                            <div><label class="block text-sm">初始風險金額 (1R)</label><input type="number" step="any" x-model.number="journalForm.initialRiskAmount" placeholder="350" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div> 
                            <label class="block text-sm">交易策略 / Setup</label> 
                            <select x-model="journalForm.setup" class="w-full bg-gray-700 rounded p-2 mt-1">
                                <option value="">-- 選擇 Playbook --</option>
                                <template x-for="playbook in playbooks" :key="playbook.id">
                                    <option :value="playbook.strategyName" x-text="playbook.strategyName"></option>
                                </template>
                            </select>
                        </div>
                        <div> <label class="block text-sm">進場理由</label> <textarea x-model="journalForm.rationale" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="記錄進場的技術或基本面原因..."></textarea> </div>
                        <div><label class="block text-sm">股價圖片</label><input type="file" @change="handleImageUpload($event, journalForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                             <template x-if="journalForm.chartImage"><div class="relative mt-2"><img :src="journalForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="journalForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                              <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingTradeId ? '更新主交易' : '儲存新主交易'"></button>
                             <button type="button" @click="resetForm" x-show="editingTradeId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                        </div>
                    </form>
                 </div>

                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">主交易列表</h2>
                         <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th class="px-4 py-3">開倉日</th><th class="px-4 py-3">代號</th><th class="px-4 py-3">狀態</th><th class="px-4 py-3">現有R倍數</th><th class="px-4 py-3">操作</th></tr></thead>
                            <tbody>
                                 <template x-for="trade in trades" :key="trade.id">
                                    <tr @click="selectTrade(trade)" class="border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer" :class="{'bg-blue-900/50': selectedTradeId === trade.id}">
                                        <td class="px-4 py-3" x-text="trade.entryDate"></td>
                                         <td class="px-4 py-3" x-text="trade.ticker"></td>
                                        <td class="px-4 py-3"><span x-text="getTradeDetails(trade).status" :class="getTradeDetails(trade).status === 'Open' ? 'text-yellow-400' : 'text-gray-400'"></span></td>
                                        <td class="px-4 py-3 font-mono" x-text="`${getTradeDetails(trade).rMultiple.toFixed(2)} R`" :class="getTradeDetails(trade).rMultiple >= 0 ? 'text-green-400' : 'text-red-400'"></td>
                                        <td class="px-4 py-3 flex gap-2"><button @click.stop="editTrade(trade)" class="text-blue-400 hover:text-blue-300">編輯</button><button @click.stop="deleteTrade(trade.id)" class="text-red-400 hover:text-red-300">刪除</button></td>
                                    </tr>
                                 </template>
                                 <tr x-show="trades.length === 0"><td colspan="5" class="text-center py-8 text-gray-500">暫無交易記錄</td></tr>
                            </tbody>
                         </table>
                    </div>
                    
                    <div x-show="selectedTradeId" x-cloak>
                        <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2 flex justify-between">
                            <span>子交易記錄 (<span x-text="selectedTrade ? selectedTrade.ticker : ''"></span>)</span>
                            <button @click="showTxnForm = !showTxnForm" class="text-sm bg-green-600 hover:bg-green-500 px-3 py-1 rounded-lg" x-text="showTxnForm ? '關閉表單' : '新增記錄'"></button>
                        </h2>

                        <div x-show="showTxnForm" class="bg-gray-700/50 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold mb-2" x-text="editingTxnId ? '編輯子交易' : '新增子交易'"></h3>
                            <form @submit.prevent="saveSubTransaction" class="space-y-3">
                                <div class="grid grid-cols-3 gap-3">
                                     <div><label class="text-xs">動作</label><select x-model="txnForm.type" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"><option>Buy</option><option>Sell</option></select></div>
                                    <div><label class="text-xs">日期</label><input type="date" x-model="txnForm.date" required class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                                    <div><label class="text-xs">股數</label><input type="number" step="any" x-model.number="txnForm.quantity" required placeholder="100" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                                </div>
                                <div><label class="text-xs">價格</label><input type="number" step="any" x-model.number="txnForm.price" required placeholder="150.25" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                                 <div><label class="text-xs">備註</label><input type="text" x-model="txnForm.notes" placeholder="跌穿5天線, 賣出1/3" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                                <div class="flex justify-end gap-3 pt-2">
                                    <button type="button" @click="resetTxnForm" class="text-xs bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded-lg">取消</button>
                                    <button type="submit" class="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg" x-text="editingTxnId ? '更新記錄' : '儲存記錄'"></button>
                                </div>
                            </form>
                        </div>

                         <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th class="px-4 py-2">日期</th><th class="px-4 py-2">動作</th><th class="px-4 py-2">股數</th><th class="px-4 py-2">價格</th><th class="px-4 py-2">備註</th><th class="px-4 py-2">操作</th></tr></thead>
                            <tbody>
                                 <template x-for="txn in (selectedTrade ? selectedTrade.transactions.sort((a, b) => new Date(a.date) - new Date(b.date)) : [])" :key="txn.id">
                                    <tr class="border-b border-gray-700">
                                         <td class="px-4 py-2" x-text="txn.date"></td>
                                        <td class="px-4 py-2" x-text="txn.type" :class="txn.type === 'Buy' ? 'text-green-400' : 'text-red-400'"></td>
                                        <td class="px-4 py-2" x-text="txn.quantity"></td>
                                        <td class="px-4 py-2" x-text="txn.price"></td>
                                         <td class="px-4 py-2 text-gray-400" x-text="txn.notes"></td>
                                        <td class="px-4 py-2 flex gap-2">
                                             <button @click="editSubTransaction(txn)" class="text-blue-400 hover:text-blue-300 text-xs">編輯</button>
                                            <button @click="deleteSubTransaction(txn.id)" class="text-red-400 hover:text-red-300 text-xs">刪除</button>
                                         </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div x-show="activeTab === 'playbook'" x-cloak>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingPlaybookId ? '編輯 Playbook' : '新增 Playbook'"></h2>
                    <form @submit.prevent="savePlaybook" class="space-y-4">
                        <div><label class="block text-sm">策略名稱</label><input type="text" x-model="playbookForm.strategyName" required class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="例如: VCP 突破"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">圖表週期</label><input type="text" x-model="playbookForm.chartTimeframe" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="日線, 4小時"></div>
                            <div><label class="block text-sm">市場環境</label><input type="text" x-model="playbookForm.marketCondition" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="牛市, 盤整"></div>
                        </div>
                        <div><label class="block text-sm">進場標準</label><textarea x-model="playbookForm.entryCriteria" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="- 成交量放大&#10;- 價格突破關鍵點"></textarea></div>
                        <div><label class="block text-sm">停損策略</label><textarea x-model="playbookForm.stopLossStrategy" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="跌破前低 或 8% 固定停損"></textarea></div>
                        <div><label class="block text-sm">停利策略</label><textarea x-model="playbookForm.takeProfitStrategy" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="分批賣出: 2R, 4R..."></textarea></div>
                        <div><label class="block text-sm">筆記 / 心得</label><textarea x-model="playbookForm.notes" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                        <div>
                            <label class="block text-sm">範例圖表</label>
                            <input type="file" @change="handleImageUpload($event, playbookForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                            <template x-if="playbookForm.exampleChart"><div class="relative mt-2"><img :src="playbookForm.exampleChart" alt="Playbook Chart" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="playbookForm.exampleChart = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingPlaybookId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetPlaybookForm" x-show="editingPlaybookId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">我的 Playbooks</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <template x-for="playbook in playbooks" :key="playbook.id">
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-lg text-blue-300" x-text="playbook.strategyName"></h3>
                                        <p class="text-xs text-gray-400" x-text="`週期: ${playbook.chartTimeframe || 'N/A'} | 環境: ${playbook.marketCondition || 'N/A'}`"></p>
                                    </div>
                                    <div>
                                        <button @click="editPlaybook(playbook)" class="text-blue-400 hover:text-blue-300 text-sm">編輯</button>
                                        <button @click="deletePlaybook(playbook.id)" class="text-red-400 hover:text-red-300 text-sm ml-2">刪除</button>
                                    </div>
                                </div>
                                <div class="mt-3 text-sm space-y-2">
                                    <p><strong class="text-gray-400">進場:</strong> <span class="whitespace-pre-wrap" x-text="playbook.entryCriteria"></span></p>
                                    <p><strong class="text-gray-400">停損:</strong> <span x-text="playbook.stopLossStrategy"></span></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="playbooks.length === 0" class="text-center py-16 text-gray-500">尚無 Playbook，請在左側新增您的第一個交易策略。</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div x-show="activeTab === 'modelBook'" x-cloak>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit self-start">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingModelBookId ? '編輯模型' : '新增模型'"></h2>
                    <form @submit.prevent="saveModelBook" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">名稱</label><input type="text" x-model="modelBookForm.name" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                             <div><label class="block text-sm">代號</label><input type="text" x-model="modelBookForm.ticker" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                              <div><label class="block text-sm">市場</label><input type="text" x-model="modelBookForm.market" placeholder="US, HK" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                             <div><label class="block text-sm">年份</label><input type="number" x-model.number="modelBookForm.year" placeholder="2023" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        </div>
                         <div><label class="block text-sm">行業</label><input type="text" x-model="modelBookForm.sector" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">型態</label><input type="text" x-model="modelBookForm.pattern" placeholder="Cup with Handle, VCP..." class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                        <div><label class="block text-sm">突破後表現</label><input type="text" x-model="modelBookForm.performance" placeholder="+150% in 3 months" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
                         <div><label class="block text-sm">關鍵買入點</label><textarea x-model="modelBookForm.pivot" rows="2" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                        <div><label class="block text-sm">心得</label><textarea x-model="modelBookForm.takeaways" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
                        <div>
                             <label class="block text-sm">圖表快照</label>
                            <div class="flex items-center space-x-2 mt-1"><input type="file" @change="handleImageUpload($event, modelBookForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"><svg x-show="isUploadingImage" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                             <template x-if="modelBookForm.chartImage">
                                <div class="relative mt-2"><img :src="modelBookForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="modelBookForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div>
                             </template>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingModelBookId ? '更新' : '儲存'"></button>
                             <button type="button" @click="resetModelBookForm" x-show="editingModelBookId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                        </div>
                    </form>
                 </div>
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">模型庫</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto">
                        <template x-for="model in modelBooks" :key="model.id">
                              <div class="bg-gray-700 rounded-xl overflow-hidden border border-gray-600">
                                <img :src="model.chartImage || 'https://placehold.co/600x400/1f2937/9ca3af?text=No+Image'" class="w-full h-64 object-cover cursor-pointer" @click="openChartModal(model.chartImage || '')">
                                <div class="p-4">
                                    <h3 class="font-bold text-lg" x-text="`${model.name} (${model.ticker})`"></h3>
                                     <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-green-900 text-green-300" x-text="model.pattern"></span>
                                    <p class="text-sm text-gray-300 mt-2"><strong class="text-gray-400">表現:</strong> <span x-text="model.performance"></span></p>
                                     <p class="text-sm text-gray-300 mt-2 h-12 overflow-y-auto"><strong class="text-gray-400">心得:</strong> <span x-text="model.takeaways"></span></p>
                                    <div class="mt-4 flex justify-end gap-2"><button @click="editModelBook(model)" class="text-blue-400 hover:text-blue-300">編輯</button><button @click="deleteModelBook(model.id)" class="text-red-400 hover:text-red-300">刪除</button></div>
                                </div>
                             </div>
                        </template>
                         <div x-show="modelBooks.length === 0" class="md:col-span-2 text-center py-16 text-gray-500"><p>您的模型庫是空的，請在左方新增您的第一個成功案例模型。</p></div>
                     </div>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'performance'" x-cloak>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">勝率 (Win Rate)</h3><p class="mt-2 text-3xl font-bold" x-text="`${performance.winRate.toFixed(2)}%`"></p></div>
                 <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">總盈虧 (Total P&L)</h3><p class="mt-2 text-3xl font-bold" :class="performance.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(performance.totalPl, 'USD')"></p></div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">平均 R 值</h3><p class="mt-2 text-3xl font-bold" :class="performance.avgR >= 0 ? 'text-green-400' : 'text-red-400'" x-text="`${performance.avgR.toFixed(2)} R`"></p></div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">總交易數</h3><p class="mt-2 text-3xl font-bold" x-text="performance.totalTrades"></p></div>
            </div>
            
            <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4">資金曲線圖</h2>
                <div class="h-96"><canvas id="plChart"></canvas></div>
            </div>

            <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4">按 Playbook 策略進行績效分析</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="px-4 py-3 rounded-l-lg">Playbook / Setup</th>
                                <th scope="col" class="px-4 py-3 text-center">總交易數</th>
                                <th scope="col" class="px-4 py-3 text-center">勝率</th>
                                <th scope="col" class="px-4 py-3 text-right">總盈虧</th>
                                <th scope="col" class="px-4 py-3 text-center">利潤因子</th>
                                <th scope="col" class="px-4 py-3 text-right rounded-r-lg">平均 R 值</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="perf in playbookPerformance" :key="perf.setup">
                                <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td class="px-4 py-3 font-medium text-white" x-text="perf.setup || '未分類'"></td>
                                    <td class="px-4 py-3 text-center" x-text="perf.totalTrades"></td>
                                    <td class="px-4 py-3 text-center" x-text="`${perf.winRate.toFixed(2)}%`"></td>
                                    <td class="px-4 py-3 text-right" :class="perf.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(perf.totalPl, 'USD')"></td>
                                    <td class="px-4 py-3 text-center" x-text="perf.profitFactor.toFixed(2)"></td>
                                    <td class="px-4 py-3 text-right" :class="perf.avgR >= 0 ? 'text-green-400' : 'text-red-400'" x-text="`${perf.avgR.toFixed(2)} R`"></td>
                                </tr>
                            </template>
                            <tr x-show="playbookPerformance.length === 0">
                                <td colspan="6" class="text-center py-8 text-gray-500">沒有足夠的已平倉交易數據來分析 Playbook 表現。</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div x-show="activeTab === 'settings'" x-cloak>
            <div class="max-w-2xl mx-auto bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 text-blue-300 border-b border-gray-600 pb-2">設定</h2>
                 <div class="space-y-6">
                    <div>
                        <label for="settingsPrincipal" class="block text-sm font-medium text-gray-300">股票戶口本金 (USD)</label>
                        <div class="input-group mt-1">
                            <span>$</span>
                            <input id="settingsPrincipal" type="number" x-model.number="settings.usdPrincipal" @blur="saveSettings()" class="text-lg">
                        </div>
                    </div>

                    <div>
                        <label for="displayCurrency" class="block text-sm font-medium text-gray-300">預設顯示貨幣</label>
                        <select id="displayCurrency" x-model="settings.displayCurrency" @change="saveSettings()" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                             <template x-for="currency in Object.keys(exchangeRates.rates || {'USD':1, 'HKD':7.8, 'JPY':150})">
                                <option :value="currency" x-text="currency"></option>
                            </template>
                        </select>
                         <p class="mt-2 text-xs text-gray-400">此設定將影響快速注碼計算器中的次要顯示貨幣。</p>
                    </div>
                    
                    <hr class="border-gray-600">

                    <h3 class="text-xl font-semibold text-blue-300">AI 分析設定</h3>
                    <div>
                        <label for="aiProvider" class="block text-sm font-medium text-gray-300">AI 服務供應商</label>
                        <select id="aiProvider" x-model="settings.aiProvider" @change="saveSettings()" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                             <option value="gemini">預設 (內建 AI)</option>
                            <option value="custom">自訂 API Key (OpenAI 相容)</option>
                        </select>
                         <p class="mt-2 text-xs text-gray-400">選擇 "預設" 將使用內建的 Gemini 連接。選擇 "自訂" 以使用您自己的 API Key。</p>
                    </div>

                    <div x-show="settings.aiProvider === 'custom'" class="space-y-4 p-4 bg-gray-700/50 rounded-lg">
                        <div>
                             <label for="customApiUrl" class="block text-sm font-medium text-gray-300">API 端點 (Endpoint URL)</label>
                            <input type="text" id="customApiUrl" x-model="settings.customApiUrl" placeholder="https://api.openai.com/v1/chat/completions" class="w-full bg-gray-900 rounded p-2 mt-1">
                        </div>
                         <div>
                            <label for="customApiKey" class="block text-sm font-medium text-gray-300">您的 API Key</label>
                            <input type="password" id="customApiKey" x-model="settings.customApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full bg-gray-900 rounded p-2 mt-1">
                         </div>
                    </div>

                    <div class="flex justify-end">
                        <button @click="saveSettings(true)" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">儲存設定</button>
                    </div>
                 </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-xs space-y-1">
            <p>此工具僅供參考，不構成任何投資建議。AI 分析由大型語言模型生成，可能存在錯誤，請謹慎管理您的風險。</p>
            <p>版本: <span x-text="appVersion"></span></p>
        </footer>

        <div x-show="isModalOpen" x-cloak class="modal-backdrop" @click="closeChartModal">
            <div class="modal-content" @click.stop><img :src="modalImageUrl" class="max-w-full max-h-full"></div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, serverTimestamp, query, orderBy, Timestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        function tradingApp() {
            return {
                // System State
                isInitialized: false, isLoggedIn: false, activeTab: 'dashboard',
                isLoading: false, isUploadingImage: false, isModalOpen: false, modalImageUrl: '',
                authView: 'login', authForm: { email: '', password: '' }, authError: '',
                appVersion: '8.2.0',

                // Firebase
                db: null, auth: null, userId: null,
                
                // Settings & Data
                settings: { 
                    aiProvider: 'gemini', 
                    customApiKey: '', 
                    customApiUrl: '', 
                    usdPrincipal: 35000,
                    displayCurrency: 'HKD' 
                },
                exchangeRates: { base: 'USD', rates: { 'USD': 1, 'HKD': 7.8, 'JPY': 150 } }, // Fallback rates
                
                // Data Arrays
                trades: [], 
                marketJournals: [], 
                buyPlans: [], 
                modelBooks: [],
                reflections: [],
                playbooks: [],

                // Journal State
                selectedTradeId: null,
                selectedTrade: null,
                showTxnForm: false,
                editingTxnId: null, 
                txnForm: {},
                quickSizer: { 
                    riskPercent: 1.0, 
                    stopLossPercent: 5.0, 
                    riskAmount: 0, 
                    positionSize: 0, 
                    displayCurrency: 'HKD' 
                },

                // Calendar State
                calendar: { 
                    year: new Date().getFullYear(), 
                    month: new Date().getMonth(), 
                    days: [],
                    yearOptions: []
                },

                // Forms & Editing State
                editingTradeId: null, journalForm: {},
                editingMarketJournalId: null, marketJournalForm: {},
                editingBuyPlanId: null, buyPlanForm: {},
                editingModelBookId: null, modelBookForm: {},
                editingReflectionId: null, reflectionForm: {},
                editingPlaybookId: null, playbookForm: {},
                
                // Search
                searchTerm: '', searchResults: [],

                // Charts & Performance
                plChart: null, dashboardPlChart: null, hexagonScoreChart: null,

                // Computed Properties
                get performance() {
                    const closedTrades = this.trades.map(t => this.getTradeDetails(t)).filter(t => t.status === 'Closed');
                    const totalTrades = closedTrades.length;
                    if (totalTrades === 0) return { winRate: 0, totalPl: 0, avgR: 0, totalTrades: 0, closedTrades: [] };
                    const winningTrades = closedTrades.filter(t => t.totalPl > 0).length;
                    const totalPl = closedTrades.reduce((sum, t) => sum + t.totalPl, 0);
                    const totalR = closedTrades.reduce((sum, t) => sum + t.rMultiple, 0);
                    return { 
                        winRate: (winningTrades / totalTrades) * 100, 
                        totalPl, 
                        avgR: totalTrades > 0 ? totalR / totalTrades : 0, 
                        totalTrades,
                        closedTrades // Pass for metrics calculation
                    };
                },

                get metrics() {
                    const perf = this.performance;
                    const closedTrades = perf.closedTrades;
                    if (closedTrades.length < 2) {
                        return { totalScore: 0, scores: {}, profitFactor: 0, avgWinLossRatio: 0 };
                    }

                    const wins = closedTrades.filter(t => t.totalPl > 0);
                    const losses = closedTrades.filter(t => t.totalPl < 0);
                    const grossProfit = wins.reduce((sum, t) => sum + t.totalPl, 0);
                    const grossLoss = Math.abs(losses.reduce((sum, t) => sum + t.totalPl, 0));
                    
                    const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? 999 : 0);
                    const avgWin = wins.length > 0 ? grossProfit / wins.length : 0;
                    const avgLoss = losses.length > 0 ? grossLoss / losses.length : 0;
                    const avgWinLossRatio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? 999 : 0);

                    // Max Drawdown Calculation
                    let peak = 0;
                    let maxDrawdown = 0;
                    let cumulativePl = 0;
                    for (const trade of closedTrades) {
                        cumulativePl += trade.totalPl;
                        if (cumulativePl > peak) {
                            peak = cumulativePl;
                        }
                        const drawdown = peak - cumulativePl;
                        if (drawdown > maxDrawdown) {
                            maxDrawdown = drawdown;
                        }
                    }
                    const maxDrawdownPercent = this.settings.usdPrincipal > 0 ? (maxDrawdown / (this.settings.usdPrincipal + peak)) * 100 : 0;

                    const recoveryFactor = maxDrawdown > 0 ? perf.totalPl / maxDrawdown : (perf.totalPl > 0 ? 999 : 0);

                    // Consistency (Std Dev of R-Multiples)
                    const rMultiples = closedTrades.map(t => t.rMultiple);
                    const meanR = perf.avgR;
                    const stdDevR = Math.sqrt(rMultiples.map(r => Math.pow(r - meanR, 2)).reduce((a, b) => a + b, 0) / rMultiples.length);
                    const consistency = stdDevR > 0 ? 1 / stdDevR : 10; // Inverse, higher is better

                    // --- Normalization (0-10 scale) ---
                    const normalize = (value, good, excellent) => Math.min(10, (value / excellent) * 10);
                    const scores = {
                        winRate: normalize(perf.winRate, 40, 60),
                        profitFactor: normalize(profitFactor, 1.5, 3),
                        avgWinLossRatio: normalize(avgWinLossRatio, 1.5, 3),
                        maxDrawdown: Math.max(0, 10 - normalize(maxDrawdownPercent, 20, 10)), // Inverted
                        recoveryFactor: normalize(recoveryFactor, 1, 2.5),
                        consistency: normalize(consistency, 1.5, 3) 
                    };

                    const totalScore = (Object.values(scores).reduce((sum, s) => sum + s, 0) / 6) * 10; // Scale to 100

                    return { totalScore, scores, profitFactor, avgWinLossRatio };
                },
                
                get playbookPerformance() {
                    const grouped = {};
                    this.performance.closedTrades.forEach(trade => {
                        const setup = trade.setup || '未分類';
                        if (!grouped[setup]) {
                            grouped[setup] = [];
                        }
                        grouped[setup].push(trade);
                    });

                    return Object.entries(grouped).map(([setup, trades]) => {
                        const totalTrades = trades.length;
                        const wins = trades.filter(t => t.totalPl > 0);
                        const winRate = (wins.length / totalTrades) * 100;
                        const totalPl = trades.reduce((sum, t) => sum + t.totalPl, 0);
                        const totalR = trades.reduce((sum, t) => sum + t.rMultiple, 0);
                        const avgR = totalR / totalTrades;
                        
                        const grossProfit = wins.reduce((sum, t) => sum + t.totalPl, 0);
                        const grossLoss = Math.abs(trades.filter(t => t.totalPl < 0).reduce((sum, t) => sum + t.totalPl, 0));
                        const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? 999 : 0);

                        return { setup, totalTrades, winRate, totalPl, profitFactor, avgR };
                    }).sort((a,b) => b.totalTrades - a.totalTrades);
                },

                // --- Initialization ---
                init() {
                    this.loadSettings();
                    this.resetAllForms();
                    this.initFirebase();
                    this.fetchExchangeRates();
                    
                    this.generateCalendar();
                    this.$watch('calendar.month', () => this.generateCalendar());
                    this.$watch('calendar.year', () => this.generateCalendar());
                    this.$watch('trades', () => this.generateCalendar());

                    this.$watch('settings.usdPrincipal', () => this.updateQuickSizer());
                    this.$watch('quickSizer.displayCurrency', () => this.settings.displayCurrency = this.quickSizer.displayCurrency);
                    
                    this.$watch('activeTab', (newTab) => {
                        if (this.isLoggedIn) {
                           this.$nextTick(() => { 
                               if (newTab === 'performance' || newTab === 'dashboard') {
                                   this.renderPlCharts();
                               }
                               if (newTab === 'dashboard') {
                                   this.renderHexagonChart();
                               }
                           });
                        }
                    });
                },

                async fetchExchangeRates() {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        this.exchangeRates = data;
                        console.log("Exchange rates loaded successfully.");
                    } catch (error) {
                        console.error("Could not fetch exchange rates, using fallback:", error);
                    }
                },

                loadSettings() { 
                    const savedSettings = localStorage.getItem('tradingWorkbenchSettings_v8');
                    if (savedSettings) { this.settings = { ...this.settings, ...JSON.parse(savedSettings) }; } 
                    this.quickSizer.displayCurrency = this.settings.displayCurrency;
                },
                saveSettings(showAlert = false) { 
                    localStorage.setItem('tradingWorkbenchSettings_v8', JSON.stringify(this.settings));
                    if (showAlert) alert('設定已儲存！'); 
                },

                // --- Firebase & Data ---
                async initFirebase() {
                    try {
                        const firebaseConfig = {"apiKey":"AIzaSyD_NXXcXNzKfeUct_kcv9nhSEk5ynguO0o","authDomain":"my-trading-workbench.firebaseapp.com","projectId":"my-trading-workbench","storageBucket":"my-trading-workbench.appspot.com","messagingSenderId":"386958713208","appId":"1:386958713208:web:028035e1ac4b47bd55e88d","measurementId":"G-2WEVVMRHV7"};
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app); this.auth = getAuth(app);
                        onAuthStateChanged(this.auth, (user) => {
                            this.isInitialized = true;
                            if (user) { this.isLoggedIn = true; this.userId = user.uid; this.initializeDataListeners(); } 
                            else { this.isLoggedIn = false; this.userId = null; this.clearAllData(); }
                        });
                    } catch(e) { console.error("Firebase initialization failed:", e); this.authError = "Firebase 初始化失敗。"; this.isInitialized = true; }
                },

                initializeDataListeners() {
                    if (!this.userId) return;
                    this.loadCollection(`users/${this.userId}/trades`, 'trades', 'entryDate'); 
                    this.loadCollection(`users/${this.userId}/marketJournals`, 'marketJournals', 'date');
                    this.loadCollection(`users/${this.userId}/buyPlans`, 'buyPlans', 'createdAt');
                    this.loadCollection(`users/${this.userId}/modelBooks`, 'modelBooks', 'year');
                    this.loadCollection(`users/${this.userId}/reflections`, 'reflections', 'date');
                    this.loadCollection(`users/${this.userId}/playbooks`, 'playbooks', 'strategyName', 'asc');
                },
                
                clearAllData() { 
                    this.trades = []; this.marketJournals = []; this.buyPlans = []; this.modelBooks = []; 
                    this.reflections = []; this.playbooks = []; this.selectedTradeId = null; this.selectedTrade = null; 
                },

                // --- CRUD & Forms ---
                resetAllForms() { 
                    this.resetForm(); this.resetMarketJournalForm(); this.resetBuyPlanForm(); 
                    this.resetModelBookForm(); this.resetReflectionForm(); this.resetPlaybookForm();
                },
                
                getBlankForm() { return { entryDate: new Date().toISOString().split('T')[0], ticker: '', direction: 'Long', riskPercent: 1.0, initialRiskAmount: null, setup: '', rationale: '', chartImage: '', transactions: [] }; },
                resetForm() { this.editingTradeId = null; this.journalForm = this.getBlankForm(); },
                async saveTrade() { await this.saveEntity('trades', this.editingTradeId, this.journalForm); this.resetForm(); },
                editTrade(trade) { this.editingTradeId = trade.id; this.journalForm = { ...this.getBlankForm(), ...trade }; },
                async deleteTrade(id) { if(confirm("確定要刪除整個主交易及其所有子記錄嗎？")){ if(this.selectedTradeId === id) { this.selectedTradeId = null; this.selectedTrade = null; } await this.deleteEntity('trades', id); }},

                getBlankPlaybookForm() { return { strategyName: '', chartTimeframe: '日線', marketCondition: '', entryCriteria: '', stopLossStrategy: '', takeProfitStrategy: '', notes: '', exampleChart: '' }; },
                resetPlaybookForm() { this.editingPlaybookId = null; this.playbookForm = this.getBlankPlaybookForm(); },
                async savePlaybook() { await this.saveEntity('playbooks', this.editingPlaybookId, this.playbookForm); this.resetPlaybookForm(); },
                editPlaybook(playbook) { this.editingPlaybookId = playbook.id; this.playbookForm = { ...this.getBlankPlaybookForm(), ...playbook }; this.activeTab = 'playbook'; },
                async deletePlaybook(id) { await this.deleteEntity('playbooks', id); },

                // --- Journal v5.0+ Logic ---
                updateQuickSizer() {
                    const principal = parseFloat(this.settings.usdPrincipal) || 0;
                    const riskPct = parseFloat(this.quickSizer.riskPercent) || 0;
                    const stopLossPct = parseFloat(this.quickSizer.stopLossPercent) || 0;
                    
                    this.quickSizer.riskAmount = principal * (riskPct / 100);
                    if (stopLossPct > 0) {
                        this.quickSizer.positionSize = this.quickSizer.riskAmount / (stopLossPct / 100);
                    } else {
                        this.quickSizer.positionSize = 0;
                    }
                },
                applyQuickSizer() {
                    this.journalForm.riskPercent = parseFloat(this.quickSizer.riskPercent);
                    this.journalForm.initialRiskAmount = parseFloat(this.quickSizer.riskAmount.toFixed(2));
                },

                selectTrade(trade) { this.selectedTradeId = trade.id; this.selectedTrade = this.trades.find(t => t.id === trade.id); this.resetTxnForm(); },
                resetTxnForm() { this.editingTxnId = null; this.showTxnForm = false; this.txnForm = { id: '', type: 'Buy', date: new Date().toISOString().split('T')[0], quantity: null, price: null, notes: '' }; },
                
                async saveSubTransaction() {
                    if (!this.selectedTradeId) return;
                    const tradeRef = doc(this.db, `users/${this.userId}/trades`, this.selectedTradeId);
                    if (this.editingTxnId) {
                        const existingTxn = this.selectedTrade.transactions.find(t => t.id === this.editingTxnId);
                        const updatedTxn = { ...existingTxn, ...this.txnForm };
                        await updateDoc(tradeRef, { transactions: arrayRemove(existingTxn) });
                        await updateDoc(tradeRef, { transactions: arrayUnion(updatedTxn) });
                    } else {
                        this.txnForm.id = 'txn_' + new Date().getTime();
                        await updateDoc(tradeRef, { transactions: arrayUnion(this.txnForm) });
                    }
                    this.resetTxnForm();
                },
                editSubTransaction(txn) { this.editingTxnId = txn.id; this.txnForm = { ...txn }; this.showTxnForm = true; },
                async deleteSubTransaction(txnId) {
                    if (!this.selectedTradeId || !confirm("確定要刪除這筆子交易嗎？")) return;
                    const tradeRef = doc(this.db, `users/${this.userId}/trades`, this.selectedTradeId);
                    const txnToDelete = this.selectedTrade.transactions.find(t => t.id === txnId);
                    if (txnToDelete) { await updateDoc(tradeRef, { transactions: arrayRemove(txnToDelete) }); }
                    this.resetTxnForm();
                },
                getTradeDetails(trade) {
                    if (!trade) return { totalPl: 0, rMultiple: 0, status: 'N/A' };
                    const txns = trade.transactions || [];
                    let totalPl = 0; let totalBuyCost = 0; let totalSellValue = 0;
                    let totalBuyQty = 0; let totalSellQty = 0;

                    txns.forEach(txn => {
                        const quantity = Number(txn.quantity) || 0;
                        const price = Number(txn.price) || 0;
                        if (txn.type === 'Buy') {
                            totalBuyCost += quantity * price;
                            totalBuyQty += quantity;
                        } else {
                            totalSellValue += quantity * price;
                            totalSellQty += quantity;
                        }
                    });
                    
                    if (trade.direction === 'Long') {
                        const avgBuyPrice = totalBuyQty > 0 ? totalBuyCost / totalBuyQty : 0;
                        totalPl = totalSellValue - (totalSellQty * avgBuyPrice);
                    } else { // Short
                        const avgSellPrice = totalSellQty > 0 ? totalSellValue / totalSellQty : 0;
                        totalPl = (totalBuyQty * avgSellPrice) - totalBuyCost;
                    }
                    
                    const initialRisk = Number(trade.initialRiskAmount) || 0;
                    const rMultiple = initialRisk > 0 ? totalPl / initialRisk : 0;
                    const status = totalBuyQty === totalSellQty && totalBuyQty > 0 ? 'Closed' : 'Open';
                    
                    return { ...trade, totalPl, rMultiple, status, totalBuyQty, totalSellQty, totalBuyCost };
                },

                // --- Calendar Methods ---
                generateCalendar() {
                    const year = this.calendar.year;
                    const month = this.calendar.month;
                    const currentYear = new Date().getFullYear();
                    this.calendar.yearOptions = Array.from({length: 11}, (_, i) => currentYear - 5 + i);

                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startDayOfWeek = firstDay.getDay();
                    
                    const days = [];
                    for (let i = startDayOfWeek; i > 0; i--) { days.push({ date: new Date(year, month, 1 - i).toISOString().split('T')[0], dayOfMonth: new Date(year, month, 1 - i).getDate(), isCurrentMonth: false, pl: 0, tradeCount: 0 }); }
                    for (let i = 1; i <= daysInMonth; i++) { const d = new Date(year, month, i); days.push({ date: d.toISOString().split('T')[0], dayOfMonth: i, isCurrentMonth: true, isToday: d.toDateString() === new Date().toDateString(), pl: 0, tradeCount: 0 }); }
                    const remainingCells = 42 - days.length;
                    for (let i = 1; i <= remainingCells; i++) { days.push({ date: new Date(year, month + 1, i).toISOString().split('T')[0], dayOfMonth: i, isCurrentMonth: false, pl: 0, tradeCount: 0 }); }

                    this.trades.forEach(trade => {
                        const details = this.getTradeDetails(trade);
                        if (details.status !== 'Closed') return;
                        
                        const avgBuyPrice = (details.totalBuyQty > 0) ? details.totalBuyCost / details.totalBuyQty : 0;
                        (trade.transactions || []).forEach(txn => {
                            if (txn.type === 'Sell') {
                                const day = days.find(d => d.date === txn.date);
                                if (day) {
                                    const plForThisTxn = (trade.direction === 'Long') ? (txn.price - avgBuyPrice) * txn.quantity : (avgBuyPrice - txn.price) * txn.quantity;
                                    day.pl += plForThisTxn;
                                    day.tradeCount += 1;
                                }
                            }
                        });
                    });
                    this.calendar.days = days;
                },
                changeMonth(delta) {
                    let newMonth = this.calendar.month + delta;
                    let newYear = this.calendar.year;
                    if (newMonth > 11) { newMonth = 0; newYear++; }
                    if (newMonth < 0) { newMonth = 11; newYear--; }
                    this.calendar.month = newMonth;
                    this.calendar.year = newYear;
                },
                goToToday() {
                    const today = new Date();
                    this.calendar.year = today.getFullYear();
                    this.calendar.month = today.getMonth();
                },
                
                // --- Charting ---
                renderPlCharts() {
                    this.renderChart('plChart', false);
                    this.renderChart('dashboardPlChart', true);
                },
                renderChart(canvasId, usePrincipal) {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    
                    const closedTrades = this.performance.closedTrades.sort((a,b) => new Date(a.entryDate) - new Date(b.entryDate));
                    let chartInstance = (canvasId === 'plChart') ? this.plChart : this.dashboardPlChart;
                    if (chartInstance) chartInstance.destroy();

                    if (closedTrades.length === 0) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#6b7280'; ctx.textAlign = 'center'; ctx.font = '16px "Inter", "Noto Sans TC"';
                        ctx.fillText('暫無已平倉交易數據', canvas.width / 2, canvas.height / 2);
                        return;
                    }
                    
                    let cumulativePl = usePrincipal ? this.settings.usdPrincipal : 0;
                    const dataPoints = [cumulativePl];
                    closedTrades.forEach(t => {
                        cumulativePl += t.totalPl;
                        dataPoints.push(cumulativePl);
                    });
                    const labels = ['Start', ...closedTrades.map((t, i) => `T${i+1}`)];

                    chartInstance = new Chart(ctx, {
                        type: 'line', data: { labels: labels, datasets: [{ label: '帳戶淨值 (USD)', data: dataPoints, borderColor: 'rgba(59, 130, 246, 0.8)', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.1, fill: true }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } }
                    });
                    if (canvasId === 'plChart') this.plChart = chartInstance;
                    else this.dashboardPlChart = chartInstance;
                },

                renderHexagonChart() {
                    const canvas = document.getElementById('hexagonScoreChart');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    if (this.hexagonScoreChart) this.hexagonScoreChart.destroy();
                    
                    const scores = this.metrics.scores;
                    if (!scores || Object.keys(scores).length === 0) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#6b7280'; ctx.textAlign = 'center'; ctx.font = '16px "Inter", "Noto Sans TC"';
                        ctx.fillText('數據不足無法評分', canvas.width / 2, canvas.height / 2);
                        return;
                    }

                    this.hexagonScoreChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['勝率', '利潤因子', '盈虧比', '回撤控制', '恢復因子', '一致性'],
                            datasets: [{
                                label: '交易者評分',
                                data: Object.values(scores),
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { r: { beginAtZero: true, max: 10, ticks: { display: false }, pointLabels: { color: '#d1d5db', font: { size: 14 } }, grid: { color: 'rgba(107, 114, 128, 0.5)' } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                // --- Helpers & Unchanged Methods from 2.txt ---
                formatCurrency(value, currency = 'USD') { 
                    if (typeof value !== 'number' || isNaN(value)) return '0.00';
                    const rate = this.exchangeRates.rates[currency] || 1;
                    const convertedValue = currency === 'USD' ? value : value * rate;
                    return new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(convertedValue);
                },
                // ... (Auth methods, generic save/delete, etc. are largely unchanged)
                async register() { this.authError = ''; try { await createUserWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
                async login() { this.authError = ''; try { await signInWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
                async loginWithGoogle() { this.authError = ''; try { const provider = new GoogleAuthProvider(); await signInWithPopup(this.auth, provider); } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); console.error("Google Sign-in Error:", error); } },
                async logout() { await signOut(this.auth); },
                getFirebaseAuthErrorMessage(error) { switch (error.code) { case 'auth/email-already-in-use': return '此電子郵件已被註冊。'; case 'auth/invalid-email': return '電子郵件格式不正確。'; case 'auth/weak-password': return '密碼強度不足，請至少設定 6 個字元。'; case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': return '電子郵件或密碼錯誤。'; default: return '發生未知錯誤，請稍後再試。'; } },
                loadCollection(path, targetProperty, orderByField, orderDirection = "desc") { const q = query(collection(this.db, path), orderBy(orderByField, orderDirection)); onSnapshot(q, (snapshot) => { this[targetProperty] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); }, (error) => { console.error(`Error loading ${targetProperty}:`, error); }); },
                async saveEntity(collectionName, entityId, formData) { if (!this.userId) return alert("用戶未登入，無法儲存。"); try { const data = { ...formData }; const collectionRef = collection(this.db, `users/${this.userId}/${collectionName}`); if (entityId) { await setDoc(doc(collectionRef, entityId), data, { merge: true }); } else { data.createdAt = serverTimestamp(); await addDoc(collectionRef, data); } } catch(e) { console.error("Error saving entity:", e); alert("儲存失敗！"); throw e; } },
                async deleteEntity(collectionName, entityId) { if (confirm("確定要刪除嗎？")) await deleteDoc(doc(this.db, `users/${this.userId}/${collectionName}`, entityId)); },
                handleImageUpload(event, targetForm) { const file = event.target.files[0]; if (!file) return; if (file.size > 1024*1024) return alert("圖片需小於 1MB"); const reader = new FileReader(); reader.onload = (e) => { const fieldName = targetForm.hasOwnProperty('exampleChart') ? 'exampleChart' : 'chartImage'; targetForm[fieldName] = e.target.result; }; reader.readAsDataURL(file); },
                openChartModal(url) { if(url) { this.modalImageUrl = url; this.isModalOpen = true; } },
                closeChartModal() { this.isModalOpen = false; this.modalImageUrl = ''; },
                getBlankMarketJournalForm() { return { date: new Date().toISOString().split('T')[0], marketSummary: '', leadingSectors: '', watchlist: '', mindset: '', sentiment: 3, summary: '' }; },
                getBlankBuyPlanForm() { return { name: '', ticker: '', sector: '', pattern: '', pivot: null, stopLoss: null, target: null, rationale: '', chartImage: '' }; },
                getBlankModelBookForm() { return { name: '', ticker: '', market: '', year: new Date().getFullYear(), sector: '', pattern: '', performance: '', pivot: '', takeaways: '', chartImage: '' }; },
                getBlankReflectionForm() { return { date: new Date().toISOString().split('T')[0], problem: '', thoughts: '' }; },
                resetMarketJournalForm() { this.editingMarketJournalId = null; this.marketJournalForm = this.getBlankMarketJournalForm(); },
                resetBuyPlanForm() { this.editingBuyPlanId = null; this.buyPlanForm = this.getBlankBuyPlanForm(); },
                resetModelBookForm() { this.editingModelBookId = null; this.modelBookForm = this.getBlankModelBookForm(); },
                resetReflectionForm() { this.editingReflectionId = null; this.reflectionForm = this.getBlankReflectionForm(); },
                async saveMarketJournal() { await this.saveEntity('marketJournals', this.editingMarketJournalId, this.marketJournalForm); this.resetMarketJournalForm(); },
                async saveBuyPlan() { await this.saveEntity('buyPlans', this.editingBuyPlanId, this.buyPlanForm); this.resetBuyPlanForm(); },
                async saveModelBook() { await this.saveEntity('modelBooks', this.editingModelBookId, this.modelBookForm); this.resetModelBookForm(); },
                async saveReflection() { await this.saveEntity('reflections', this.editingReflectionId, this.reflectionForm); this.resetReflectionForm(); },
                async deleteMarketJournal(id) { await this.deleteEntity('marketJournals', id); },
                async deleteBuyPlan(id) { await this.deleteEntity('buyPlans', id); },
                async deleteModelBook(id) { await this.deleteEntity('modelBooks', id); },
                async deleteReflection(id) { await this.deleteEntity('reflections', id); },
                editMarketJournal(entry) { this.editingMarketJournalId = entry.id; this.marketJournalForm = { ...this.getBlankMarketJournalForm(), ...entry }; this.activeTab = 'marketJournal'; },
                editBuyPlan(plan) { this.editingBuyPlanId = plan.id; this.buyPlanForm = { ...this.getBlankBuyPlanForm(), ...plan }; this.activeTab = 'buyPlan'; },
                editModelBook(model) { this.editingModelBookId = model.id; this.modelBookForm = { ...this.getBlankModelBookForm(), ...model }; this.activeTab = 'modelBook'; },
                editReflection(entry) { this.editingReflectionId = entry.id; this.reflectionForm = { ...this.getBlankReflectionForm(), ...entry }; this.activeTab = 'reflection'; },
                search() { if (!this.searchTerm) return this.searchResults = []; const term = this.searchTerm.toLowerCase(); const tradeResults = this.trades.filter(t => t.ticker.toLowerCase().includes(term) || (t.setup && t.setup.toLowerCase().includes(term))).map(t => ({...t, type: '交易日誌', date: t.entryDate})); const modelResults = this.modelBooks.filter(m => m.name.toLowerCase().includes(term) || m.ticker.toLowerCase().includes(term) || m.pattern.toLowerCase().includes(term)).map(m => ({...m, type: '模型庫'})); const playbookResults = this.playbooks.filter(p => p.strategyName.toLowerCase().includes(term)).map(p => ({...p, type: 'Playbook'})); this.searchResults = [...tradeResults, ...modelResults, ...playbookResults].slice(0, 10); },
                goToSearchResult(item) { if (item.type === '交易日誌') { this.activeTab = 'journal'; this.selectTrade(item); } else if (item.type === '模型庫') { this.editModelBook(item); } else if (item.type === 'Playbook') { this.editPlaybook(item); } this.searchTerm = ''; this.searchResults = []; },

            }
        }
        
        document.addEventListener('alpine:init', () => {
            Alpine.data('tradingApp', tradingApp);
        });
    </script>
</body>
</html>
