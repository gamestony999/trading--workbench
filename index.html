<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>專業交易工作台 (AI 升級版)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #f9fafb; }
    .input-group { display: flex; align-items: center; background-color: #374151; border-radius: 0.5rem; border: 1px solid #4b5563; }
    .input-group span { padding-left: 0.75rem; color: #9ca3af; }
    .input-group input, .input-group select, .input-group textarea { background-color: transparent; border: none; outline: none; width: 100%; padding: 0.75rem; color: white; }
    .tab-btn { transition: all 0.2s ease-in-out; padding: 0.75rem 1rem; border-bottom: 2px solid transparent; white-space: nowrap; font-size: 0.875rem; font-weight: 500; color: #9ca3af; }
    .tab-btn.active { background-color: #3b82f6; color: white; font-weight: 600; border-color: #3b82f6; }
    .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; max-width: 90vw; max-height: 90vh; overflow: auto; }
  </style>
</head>
<body class="p-4 sm:p-6 md:p-8" x-data="tradingApp()" x-init="init()">

  <!-- 載入中 -->
  <div x-show="!isInitialized" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-4 text-gray-400">正在連接雲端...</p>
    </div>
  </div>

  <!-- 登入 / 註冊 -->
  <div x-show="isInitialized && !isLoggedIn" x-cloak class="min-h-screen flex items-center justify-center">
    <div class="max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
      <h2 class="text-2xl font-bold text-center text-blue-400 mb-6" x-text="authView === 'login' ? '登入工作台' : '註冊新帳號'"></h2>
      <form @submit.prevent="authView === 'login' ? login() : register()">
        <div class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-300">電子郵件</label>
            <input id="email" type="email" x-model="authForm.email" required class="w-full bg-gray-700 rounded p-2 mt-1 border border-gray-600 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-gray-300">密碼</label>
            <input id="password" type="password" x-model="authForm.password" required class="w-full bg-gray-700 rounded p-2 mt-1 border border-gray-600 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>
        <p x-show="authError" class="text-red-400 text-sm mt-4" x-text="authError"></p>
        <div class="mt-6">
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="authView === 'login' ? '登入' : '註冊'"></button>
        </div>
      </form>
      <div class="text-center mt-4">
        <button @click="authView = authView === 'login' ? 'register' : 'login'" class="text-sm text-gray-400 hover:text-white" x-text="authView === 'login' ? '還沒有帳號？註冊一個' : '已經有帳號？前往登入'"></button>
      </div>
    </div>
  </div>

  <!-- 主介面 -->
  <div x-show="isInitialized && isLoggedIn" x-cloak class="max-w-7xl mx-auto">
    <header class="mb-8">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl sm:text-4xl font-bold text-blue-400">專業交易工作台 ✨</h1>
          <p class="text-gray-400 mt-2">由 AI 驅動的整合式交易分析系統</p>
        </div>
        <div class="relative w-full md:w-1/3">
          <input type="text" x-model="searchTerm" @input.debounce.300ms="search" placeholder="搜尋交易日誌或模型庫..." class="search-input w-full bg-gray-800 border border-gray-700 rounded-full py-2 px-4 text-white focus:ring-blue-500 focus:border-blue-500">
          <div x-show="searchTerm && searchResults.length > 0" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg max-h-80 overflow-y-auto">
            <ul>
              <template x-for="item in searchResults" :key="item.id">
                <li @click="goToSearchResult(item)" class="px-4 py-3 hover:bg-gray-700 cursor-pointer">
                  <p class="font-semibold text-white" x-text="item.ticker || item.name"></p>
                  <p class="text-sm text-gray-400" x-text="`${item.type} - ${item.date || item.pattern}`"></p>
                </li>
              </template>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <div class="mb-6">
      <div class="border-b border-gray-700">
        <nav class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto" aria-label="Tabs">
          <button @click="activeTab = 'dashboard'" :class="{ 'active': activeTab === 'dashboard' }" class="tab-btn">儀表板</button>
          <button @click="activeTab = 'journal'" :class="{ 'active': activeTab === 'journal' }" class="tab-btn">交易日誌</button>
          <button @click="activeTab = 'modelBook'" :class="{ 'active': activeTab === 'modelBook' }" class="tab-btn">模型庫</button>
          <button @click="activeTab = 'performance'" :class="{ 'active': activeTab === 'performance' }" class="tab-btn">績效回顧</button>
          <button @click="activeTab = 'settings'" :class="{ 'active': activeTab === 'settings' }" class="tab-btn">設定</button>
        </nav>
      </div>
    </div>

    <div class="flex justify-between items-center text-center mb-4 text-xs text-gray-500">
      <p>User ID: <span x-text="userId || 'N/A'"></span></p>
      <button @click="logout()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-lg text-xs">登出</button>
    </div>

    <!-- 儀表板 -->
    <div x-show="activeTab === 'dashboard'" x-cloak>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <h2 class="text-2xl font-semibold mb-4 text-blue-300">核心績效</h2>
          <div class="grid grid-cols-2 gap-6">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center col-span-2">
              <h3 class="text-sm font-medium text-gray-400 mb-2">股票戶口本金 (USD)</h3>
              <div class="input-group max-w-xs mx-auto">
                <span class="text-lg font-bold text-blue-400">$</span>
                <input type="number" x-model.number="usdPrincipal" @blur="saveSettings(true)" class="text-2xl text-center font-bold text-blue-400">
              </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">勝率</h3><p class="mt-2 text-3xl font-bold" x-text="`${performance.winRate.toFixed(2)}%`"></p></div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">總盈虧</h3><p class="mt-2 text-3xl font-bold" :class="performance.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(performance.totalPl, 'USD')"></p></div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">平均 R 值</h3><p class="mt-2 text-3xl font-bold" :class="performance.avgR >= 0 ? 'text-green-400' : 'text-red-400'" x-text="`${performance.avgR.toFixed(2)} R`"></p></div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">總交易數</h3><p class="mt-2 text-3xl font-bold" x-text="performance.totalTrades"></p></div>
          </div>
        </div>
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold mb-4 text-blue-300">資金曲線圖</h2><canvas id="dashboardPlChart"></canvas></div>
      </div>
    </div>

    <!-- 交易日誌 -->
    <div x-show="activeTab === 'journal'" x-cloak>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 表單 -->
        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-fit self-start">
          <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2" x-text="editingTradeId ? '編輯主交易' : '新增主交易 (開倉)'"></h2>
          <form @submit.prevent="saveTrade" class="space-y-4">
            <div><label class="block text-sm">開倉日期</label><input type="date" x-model="journalForm.entryDate" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
            <div><label class="block text-sm">代號</label><input type="text" x-model="journalForm.ticker" placeholder="AAPL" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
            <div><label class="block text-sm">方向</label><select x-model="journalForm.direction" class="w-full bg-gray-700 rounded p-2 mt-1"><option>Long</option><option>Short</option></select></div>
            <div class="grid grid-cols-2 gap-4">
              <div><label class="block text-sm">風險倉位 (R%)</label><input type="number" step="0.01" x-model.number="journalForm.riskPercent" placeholder="1.0" class="w-full bg-gray-700 rounded p-2 mt-1"></div>
              <div><label class="block text-sm">初始風險金額 (1R)</label><input type="number" step="any" x-model.number="journalForm.riskAmount" placeholder="350" required class="w-full bg-gray-700 rounded p-2 mt-1"></div>
            </div>
            <div><label class="block text-sm">交易策略 / Setup</label><input type="text" x-model="journalForm.setup" placeholder="趨勢突破, VCP..." class="w-full bg-gray-700 rounded p-2 mt-1"></div>
            <div><label class="block text-sm">進場理由</label><textarea x-model="journalForm.rationale" rows="3" class="w-full bg-gray-700 rounded p-2 mt-1" placeholder="記錄進場的技術或基本面原因..."></textarea></div>
            <div><label class="block text-sm">交易評分 (Grade)</label><select x-model="journalForm.grade" class="w-full bg-gray-700 rounded p-2 mt-1"><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
            <div><label class="block text-sm">錯誤標籤 (Tags)</label><input type="text" x-model="journalForm.errorTags" placeholder="FOMO, 過早止盈..." class="w-full bg-gray-700 rounded p-2 mt-1"></div>
            <div><label class="block text-sm">市場狀況 (Condition)</label><input type="text" x-model="journalForm.marketCondition" placeholder="震盪, 趨勢, 高波動..." class="w-full bg-gray-700 rounded p-2 mt-1"></div>
            <div><label class="block text-sm">股價圖片</label><input type="file" @change="handleImageUpload($event, journalForm)" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"></div>
            <template x-if="journalForm.chartImage"><div class="relative mt-2"><img :src="journalForm.chartImage" alt="Chart Preview" class="rounded-lg max-h-40 w-auto mx-auto"><button type="button" @click="journalForm.chartImage = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div></template>
            <div class="flex justify-between items-center pt-2">
              <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" x-text="editingTradeId ? '更新主交易' : '儲存新主交易'"></button>
              <button type="button" @click="resetForm" x-show="editingTradeId" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">取消</button>
            </div>
          </form>
        </div>

        <!-- 主交易列表與子交易 -->
        <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
          <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">主交易列表</h2>
          <table class="w-full text-sm text-left whitespace-nowrap">
            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
              <tr><th class="px-4 py-3">開倉日</th><th class="px-4 py-3">代號</th><th class="px-4 py-3">方向</th><th class="px-4 py-3">策略</th><th class="px-4 py-3">狀態</th><th class="px-4 py-3">現有R</th><th class="px-4 py-3">操作</th></tr>
            </thead>
            <tbody>
              <template x-for="trade in trades" :key="trade.id">
                <tr @click="selectTrade(trade)" class="border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer" :class="{'bg-blue-900/50': selectedTradeId === trade.id}">
                  <td class="px-4 py-3" x-text="trade.entryDate"></td>
                  <td class="px-4 py-3" x-text="trade.ticker"></td>
                  <td class="px-4 py-3" x-text="trade.direction"></td>
                  <td class="px-4 py-3" x-text="trade.setup"></td>
                  <td class="px-4 py-3"><span x-text="getTradeDetails(trade).status" :class="getTradeDetails(trade).status === 'Open' ? 'text-yellow-400' : 'text-gray-400'"></span></td>
                  <td class="px-4 py-3 font-mono" x-text="`${getTradeDetails(trade).rMultiple.toFixed(2)}`" :class="getTradeDetails(trade).rMultiple >= 0 ? 'text-green-400' : 'text-red-400'"></td>
                  <td class="px-4 py-3 flex gap-2"><button @click.stop="editTrade(trade)" class="text-blue-400 hover:text-blue-300">編輯</button><button @click.stop="deleteTrade(trade.id)" class="text-red-400 hover:text-red-300">刪除</button></td>
                </tr>
              </template>
              <tr x-show="trades.length === 0"><td colspan="7" class="text-center py-8 text-gray-500">暫無交易記錄</td></tr>
            </tbody>
          </table>

          <!-- 子交易區塊 -->
          <div x-show="selectedTradeId" x-cloak class="mt-6">
            <h3 class="text-lg font-semibold mb-3 border-b border-gray-600 pb-2 flex justify-between"><span>子交易記錄 (<span x-text="selectedTrade ? selectedTrade.ticker : ''"></span>)</span><button @click="showTxnForm = !showTxnForm" class="text-sm bg-green-600 hover:bg-green-500 px-3 py-1 rounded-lg" x-text="showTxnForm ? '關閉表單' : '新增記錄'"></button></h3>
            <div x-show="showTxnForm" class="bg-gray-700/50 p-4 rounded-lg mb-4">
              <h4 class="font-semibold mb-2" x-text="editingTxnId ? '編輯子交易' : '新增子交易'"></h4>
              <form @submit.prevent="saveSubTransaction" class="space-y-3">
                <div class="grid grid-cols-3 gap-3">
                  <div><label class="text-xs">動作</label><select x-model="txnForm.type" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"><option>Buy</option><option>Sell</option></select></div>
                  <div><label class="text-xs">日期</label><input type="date" x-model="txnForm.date" required class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                  <div><label class="text-xs">股數</label><input type="number" step="any" x-model.number="txnForm.quantity" required placeholder="100" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                </div>
                <div><label class="text-xs">價格</label><input type="number" step="any" x-model.number="txnForm.price" required placeholder="150.25" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                <div><label class="text-xs">備註</label><input type="text" x-model="txnForm.notes" placeholder="跌穿5天線, 賣出1/3" class="w-full bg-gray-800 rounded p-2 mt-1 text-sm"></div>
                <div class="flex justify-end gap-3 pt-2">
                  <button type="button" @click="resetTxnForm" class="text-xs bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded-lg">取消</button>
                  <button type="submit" class="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg" x-text="editingTxnId ? '更新記錄' : '儲存記錄'"></button>
                </div>
              </form>
            </div>
            <table class="w-full text-sm text-left whitespace-nowrap">
              <thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th class="px-4 py-2">日期</th><th class="px-4 py-2">動作</th><th class="px-4 py-2">股數</th><th class="px-4 py-2">價格</th><th class="px-4 py-2">備註</th><th class="px-4 py-2">操作</th></tr></thead>
              <tbody>
                <template x-for="txn in (selectedTrade ? selectedTrade.transactions.sort((a, b) => new Date(a.date) - new Date(b.date)) : [])" :key="txn.id">
                  <tr class="border-b border-gray-700">
                    <td class="px-4 py-2" x-text="txn.date"></td>
                    <td class="px-4 py-2" x-text="txn.type" :class="txn.type === 'Buy' ? 'text-green-400' : 'text-red-400'"></td>
                    <td class="px-4 py-2" x-text="txn.quantity"></td>
                    <td class="px-4 py-2" x-text="txn.price"></td>
                    <td class="px-4 py-2 text-gray-400" x-text="txn.notes"></td>
                    <td class="px-4 py-2 flex gap-2"><button @click="editSubTransaction(txn)" class="text-blue-400 hover:text-blue-300 text-xs">編輯</button><button @click="deleteSubTransaction(txn.id)" class="text-red-400 hover:text-red-300 text-xs">刪除</button></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 績效回顧 -->
    <div x-show="activeTab === 'performance'" x-cloak>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">勝率 (Win Rate)</h3><p class="mt-2 text-3xl font-bold" x-text="`${performance.winRate.toFixed(2)}%`"></p></div>
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">總盈虧 (Total P&L)</h3><p class="mt-2 text-3xl font-bold" :class="performance.totalPl >= 0 ? 'text-green-400' : 'text-red-400'" x-text="formatCurrency(performance.totalPl, 'USD')"></p></div>
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">平均 R 值</h3><p class="mt-2 text-3xl font-bold" :class="performance.avgR >= 0 ? 'text-green-400' : 'text-red-400'" x-text="`${performance.avgR.toFixed(2)} R`"></p></div>
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center"><h3 class="text-sm font-medium text-gray-400">總交易數</h3><p class="mt-2 text-3xl font-bold" x-text="performance.totalTrades"></p></div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700"><h2 class="text-xl font-semibold mb-4">資金曲線圖</h2><canvas id="plChart"></canvas></div>
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700"><h2 class="text-xl font-semibold mb-4">最大回撤 (Max Drawdown)</h2><button @click="getAiDrawdownAnalysis()" :disabled="isLoading || trades.length < 2" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition mb-4 disabled:opacity-50 disabled:cursor-not-allowed">由 AI 分析</button><div x-html="maxDrawdownAnalysis" class="prose prose-sm prose-invert max-w-none text-gray-300"></div></div>
      </div>
      <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"><h2 class="text-xl font-semibold">✨ AI 情緒模式分析</h2><button @click="getAiEmotionAnalysis()" :disabled="isLoading || trades.length < 1" class="w-full mt-2 sm:mt-0 sm:w-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">分析情緒與績效關聯</button></div>
        <div x-show="isLoading" class="text-center py-4"><svg class="animate-spin h-8 w-8 text-purple-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
        <div x-html="aiEmotionAnalysisResult" class="prose prose-sm prose-invert max-w-none text-gray-300"></div>
      </div>
      <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"><h2 class="text-xl font-semibold">月度 / 季度回顧</h2><button @click="getAiPerformanceReview()" :disabled="isLoading || trades.length < 1" class="w-full mt-2 sm:mt-0 sm:w-auto bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">✨ 產生 AI 回顧報告</button></div>
        <div class="space-y-4">
          <div><label class="block text-sm font-medium text-gray-300">每月表現</label><textarea x-model="reviewNotes.monthly" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
          <div><label class="block text-sm font-medium text-gray-300">需要改善的地方</label><textarea x-model="reviewNotes.improve" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
          <div><label class="block text-sm font-medium text-gray-300">下月目標</label><textarea x-model="reviewNotes.goals" rows="5" class="w-full bg-gray-700 rounded p-2 mt-1"></textarea></div>
        </div>
      </div>
    </div>

    <!-- 設定 -->
    <div x-show="activeTab === 'settings'" x-cloak>
      <div class="max-w-2xl mx-auto bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h2 class="text-2xl font-semibold mb-4 text-blue-300 border-b border-gray-600 pb-2">AI 分析設定</h2>
        <div class="space-y-6">
          <div>
            <label for="aiProvider" class="block text-sm font-medium text-gray-300">AI 服務供應商</label>
            <select id="aiProvider" x-model="settings.aiProvider" @change="saveSettings()" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"><option value="gemini">預設 (內建 AI)</option><option value="custom">自訂 API Key (OpenAI 相容)</option></select>
          </div>
          <div x-show="settings.aiProvider === 'custom'" class="space-y-4 p-4 bg-gray-700/50 rounded-lg">
            <div><label for="customApiUrl" class="block text-sm font-medium text-gray-300">API 端點 (Endpoint URL)</label><input type="text" id="customApiUrl" x-model="settings.customApiUrl" placeholder="https://api.openai.com/v1/chat/completions" class="w-full bg-gray-900 rounded p-2 mt-1"></div>
            <div><label for="customApiKey" class="block text-sm font-medium text-gray-300">您的 API Key</label><input type="password" id="customApiKey" x-model="settings.customApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full bg-gray-900 rounded p-2 mt-1"></div>
          </div>
          <div class="flex justify-end"><button @click="saveSettings(true)" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">儲存設定</button></div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-12 text-gray-500 text-xs space-y-1">
      <p>此工具僅供參考，不構成任何投資建議。AI 分析由大型語言模型生成，可能存在錯誤，請謹慎管理您的風險。</p>
      <p>版本: <span x-text="appVersion"></span> | 最後更新: <span x-text="lastUpdated"></span></p>
    </footer>

    <div x-show="isModalOpen" x-cloak class="modal-backdrop" @click="closeChartModal">
      <div class="modal-content" @click.stop><img :src="modalImageUrl" class="max-w-full max-h-full"></div>
    </div>
  </div>

  <!-- ===== 以下為 Alpine.js + Firebase 邏輯（已合併） ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, serverTimestamp, query, orderBy, Timestamp, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/module.esm.js';

    function tradingApp() {
      return {
        isInitialized: false, isLoggedIn: false, activeTab: 'dashboard', isLoading: false, isUploadingImage: false, isModalOpen: false, modalImageUrl: '',
        authView: 'login', authForm: { email: '', password: '' }, authError: '', appVersion: '4.0.1', lastUpdated: '2024-07-31',
        db: null, auth: null, userId: null,
        settings: { aiProvider: 'gemini', customApiKey: '', customApiUrl: '', usdPrincipal: 35000 },
        trades: [], marketJournals: [], buyPlans: [], modelBooks: [], reflections: [], marketCompassLog: [],
        selectedTradeId: null, selectedTrade: null, showTxnForm: false, editingTxnId: null, txnForm: {}, quickSizer: { riskPercent: 1.0, riskAmount: 0 },
        calendar: { year: new Date().getFullYear(), month: new Date().getMonth(), days: [] },
        editingTradeId: null, journalForm: {}, editingMarketJournalId: null, marketJournalForm: {}, editingBuyPlanId: null, buyPlanForm: {}, editingModelBookId: null, modelBookForm: {}, editingReflectionId: null, reflectionForm: {}, editingCompassLogId: null,
        searchTerm: '', searchResults: [], stopLossPercent: 4.6, currentRiskPercent: 1, customRiskPercent: null,
        plChart: null, dashboardPlChart: null, aiAnalysisResult: '<p class="text-gray-500">點擊「獲取分析」按鈕，讓 AI 根據您當前的設定提供交易策略建議。</p>', maxDrawdownAnalysis: '<p class="text-gray-500">點擊按鈕，讓 AI 為您分析交易數據中的最大資金回撤。</p>', aiEmotionAnalysisResult: '<p class="text-gray-500">點擊按鈕，讓 AI 分析您的情緒標籤與交易結果之間的關聯。</p>', aiModelBookAnalysis: '', reviewNotes: { monthly: '', improve: '', goals: '' }, aiDashboardSummary: '', aiQuery: '',

        get usdPrincipal() { return this.settings.usdPrincipal; },
        set usdPrincipal(value) { this.settings.usdPrincipal = value; },
        get rValueUsd() { return this.usdPrincipal * ((this.currentRiskPercent || 0) / 100); },
        get positionSizeUsd() { if (!this.stopLossPercent) return 0; return this.rValueUsd / (this.stopLossPercent / 100); },
        get performance() {
          const closedTrades = this.trades.map(t => this.getTradeDetails(t)).filter(t => t.status === 'Closed');
          const totalTrades = closedTrades.length;
          if (totalTrades === 0) return { winRate: 0, totalPl: 0, avgR: 0, totalTrades: 0 };
          const winningTrades = closedTrades.filter(t => t.totalPl > 0).length;
          const totalPl = closedTrades.reduce((sum, t) => sum + t.totalPl, 0);
          const totalR = closedTrades.reduce((sum, t) => sum + t.rMultiple, 0);
          return { winRate: (winningTrades / totalTrades) * 100, totalPl, avgR: totalTrades > 0 ? totalR / totalTrades : 0, totalTrades };
        },

        init() {
          this.loadSettings();
          this.resetAllForms();
          this.initFirebase();
          this.generateCalendar();
          this.$watch('calendar.month', () => this.generateCalendar());
          this.$watch('trades', () => this.generateCalendar());
          this.$watch('quickSizer.riskPercent', (val) => {
            this.quickSizer.riskAmount = (this.usdPrincipal * (val / 100));
          });
          this.$watch('settings.usdPrincipal', (val) => {
            this.quickSizer.riskAmount = (val * (this.quickSizer.riskPercent / 100));
          });
          this.$watch('activeTab', (newTab) => {
            if ((newTab === 'performance' || newTab === 'dashboard') && this.isLoggedIn) {
              this.$nextTick(() => { this.renderChart('plChart'); this.renderChart('dashboardPlChart'); });
            }
          });
        },

        loadSettings() { const saved = localStorage.getItem('tradingWorkbenchSettings_v3'); if (saved) this.settings = { ...this.settings, ...JSON.parse(saved) }; },
        saveSettings(showAlert = false) { localStorage.setItem('tradingWorkbenchSettings_v3', JSON.stringify(this.settings)); if (showAlert) alert('設定已儲存！'); },

        async initFirebase() {
          try {
            const firebaseConfig = {
              apiKey: "AIzaSyD_NXXcXNzKfeUct_kcv9nhSEk5ynguO0o",
              authDomain: "my-trading-workbench.firebaseapp.com",
              projectId: "my-trading-workbench",
              storageBucket: "my-trading-workbench.appspot.com",
              messagingSenderId: "386958713208",
              appId: "1:386958713208:web:028035e1ac4b47bd55e88d",
              measurementId: "G-2WEVVMRHV7"
            };
            const app = initializeApp(firebaseConfig);
            this.db = getFirestore(app); this.auth = getAuth(app);
            onAuthStateChanged(this.auth, (user) => {
              this.isInitialized = true;
              if (user) { this.isLoggedIn = true; this.userId = user.uid; this.initializeDataListeners(); }
              else { this.isLoggedIn = false; this.userId = null; this.clearAllData(); }
            });
          } catch(e) { console.error("Firebase 初始化失敗:", e); this.authError = "Firebase 初始化失敗。"; this.isInitialized = true; }
        },

        initializeDataListeners() {
          if (!this.userId) return;
          this.loadCollection(`users/${this.userId}/trades`, 'trades', 'entryDate');
          this.loadCollection(`users/${this.userId}/marketJournals`, 'marketJournals', 'date');
          this.loadCollection(`users/${this.userId}/buyPlans`, 'buyPlans', 'createdAt');
          this.loadCollection(`users/${this.userId}/modelBooks`, 'modelBooks', 'year');
          this.loadCollection(`users/${this.userId}/reflections`, 'reflections', 'date');
          this.loadCollection(`users/${this.userId}/marketCompassLog`, 'marketCompassLog', 'timestamp');
        },

        async register() { this.authError = ''; try { await createUserWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
        async login() { this.authError = ''; try { await signInWithEmailAndPassword(this.auth, this.authForm.email, this.authForm.password); this.authForm = { email: '', password: '' }; } catch (error) { this.authError = this.getFirebaseAuthErrorMessage(error); } },
        async logout() { await signOut(this.auth); },

        getFirebaseAuthErrorMessage(error) {
          switch (error.code) {
            case 'auth/email-already-in-use': return '此電子郵件已被註冊。';
            case 'auth/invalid-email': return '電子郵件格式不正確。';
            case 'auth/weak-password': return '密碼強度不足，請至少設定 6 個字元。';
            case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': return '電子郵件或密碼錯誤。';
            default: return '發生未知錯誤，請稍後再試。';
          }
        },

        loadCollection(path, targetProperty, orderByField, orderDirection = "desc") {
          const q = query(collection(this.db, path), orderBy(orderByField, orderDirection));
          onSnapshot(q, (snapshot) => {
            this[targetProperty] = snapshot.docs.map(doc => {
              const data = doc.data();
              if (data.timestamp && data.timestamp instanceof Timestamp) { data.timestamp = data.timestamp.toDate(); }
              return { id: doc.id, ...data };
            });
          }, (error) => { console.error(`Error loading ${targetProperty}:`, error); });
        },

        /* ---------- 表單與交易處理 ---------- */
        getBlankForm() { return { entryDate: new Date().toISOString().split('T')[0], ticker: '', direction: 'Long', riskPercent: 1.0, riskAmount: null, setup: '', rationale: '', grade: 'A', errorTags: '', marketCondition: '', chartImage: '', transactions: [] }; },
        resetForm() { this.editingTradeId = null; this.journalForm = this.getBlankForm(); },
        async saveTrade() {
          if (!this.userId) return alert("用戶未登入");
          const data = { ...this.journalForm };
          if (!data.riskAmount || data.riskAmount <= 0) { alert("請輸入有效的初始風險金額（1R）"); return; }
          data.transactions = data.transactions || [];
          try {
            const ref = collection(this.db, `users/${this.userId}/trades`);
            if (this.editingTradeId) { await setDoc(doc(ref, this.editingTradeId), data, { merge: true }); } else {
              data.createdAt = serverTimestamp(); await addDoc(ref, data);
            }
            this.resetForm();
          } catch (e) { console.error("儲存主交易失敗:", e); alert("儲存失敗"); }
        },
        async deleteTrade(id) { if (!confirm("確定刪除整筆主交易與所有子記錄？")) return; if (this.selectedTradeId === id) { this.selectedTradeId = null; this.selectedTrade = null; } await deleteDoc(doc(this.db, `users/${this.userId}/trades`, id)); },
        editTrade(trade) { this.editingTradeId = trade.id; this.journalForm = { ...this.getBlankForm(), ...trade }; },
        selectTrade(trade) { this.selectedTradeId = trade.id; this.selectedTrade = this.trades.find(t => t.id === trade.id); this.resetTxnForm(); },
        resetTxnForm() { this.editingTxnId = null; this.showTxnForm = false; this.txnForm = { id: '', type: 'Buy', date: new Date().toISOString().split('T')[0], quantity: null, price: null, notes: '' }; },
        async saveSubTransaction() {
          if (!this.selectedTradeId) return; const tradeRef = doc(this.db, `users/${this.userId}/trades`, this.selectedTradeId); const txn = { ...this.txnForm };
          if (!txn.id) txn.id = 'txn_' + Date.now();
          try {
            const tradeSnap = await getDoc(tradeRef); const trade = tradeSnap.data(); const updatedTxns = trade.transactions.filter(t => t.id !== txn.id); updatedTxns.push(txn);
            await updateDoc(tradeRef, { transactions: updatedTxns }); this.resetTxnForm();
          } catch (e) { console.error("子交易寫入失敗:", e); }
        },
        async deleteSubTransaction(txnId) { if (!this.selectedTradeId || !confirm("確定刪除這筆子交易？")) return; const tradeRef = doc(this.db, `users/${this.userId}/trades`, this.selectedTradeId); const tradeSnap = await getDoc(tradeRef); const trade = tradeSnap.data(); const updatedTxns = trade.transactions.filter(t => t.id !== txnId); await updateDoc(tradeRef, { transactions: updatedTxns }); this.resetTxnForm(); },
        editSubTransaction(txn) { this.editingTxnId = txn.id; this.txnForm = { ...txn }; this.showTxnForm = true; },
        getTradeDetails(trade) {
          if (!trade) return { totalPl: 0, rMultiple: 0, status: 'N/A' };
          const txns = trade.transactions || []; let totalPl = 0, totalBuyCost = 0, totalSellValue = 0, totalBuyQty = 0, totalSellQty = 0;
          txns.forEach(txn => { const q = Number(txn.quantity), p = Number(txn.price); if (txn.type === 'Buy') { totalBuyCost += q * p; totalBuyQty += q; } else { totalSellValue += q * p; totalSellQty += q; } });
          const avgBuy = totalBuyQty > 0 ? totalBuyCost / totalBuyQty : 0;
          totalPl = trade.direction === 'Long' ? totalSellValue - (totalSellQty * avgBuy) : (totalSellQty * avgBuy) - totalBuyCost;
          const rMultiple = trade.riskAmount > 0 ? totalPl / trade.riskAmount : 0;
          const status = totalBuyQty === totalSellQty && totalBuyQty > 0 ? 'Closed' : 'Open';
          return { totalPl, rMultiple, status, totalBuyQty, totalSellQty, avgBuy };
        },

        /* ---------- AI 分析 ---------- */
        getAiPrompts(type) {
          const base = {
            drawdown: { system: "你是一位專業交易分析師，請將以下逐筆盈虧序列轉換為敘述化最大回撤分析，並提供三項具體風控建議。", user: (plArr) => `盈虧序列（USD）：${JSON.stringify(plArr)}` },
            emotion: { system: "你是一位交易心理學專家，請根據每筆交易的錯誤標籤、評分、市場狀況與 R 倍數，找出情緒模式與績效之間的關聯，並以繁體中文條列建議。", user: (trades) => `交易資料：${JSON.stringify(trades)}` },
            monthly: { system: "你是一位基金經理，請根據以下績效指標與最近 10 筆交易，生成 JSON 格式的月度回顧報告，欄位：{monthlyPerformance, areasToImprove, nextMonthGoals}。", user: (input) => `績效：${JSON.stringify(input.performance)}，最近 10 筆：${JSON.stringify(input.last10)}` }
          }; return base[type];
        },
        async getAiDrawdownAnalysis() { const closed = this.trades.map(t => this.getTradeDetails(t)).filter(t => t.status === 'Closed'); const plList = closed.map(t => t.totalPl); const prompt = this.getAiPrompts('drawdown'); this.maxDrawdownAnalysis = await this.callAiApi(prompt.system, prompt.user(plList)); },
        async getAiEmotionAnalysis() { const data = this.trades.map(t => ({ errorTags: t.errorTags || '', grade: t.grade || '', marketCondition: t.marketCondition || '', rMultiple: this.getTradeDetails(t).rMultiple })); const prompt = this.getAiPrompts('emotion'); this.aiEmotionAnalysisResult = await this.callAiApi(prompt.system, prompt.user(data)); },
        async getAiPerformanceReview() { const closed = this.trades.map(t => this.getTradeDetails(t)).filter(t => t.status === 'Closed'); const input = { performance: this.performance, last10: closed.slice(-10).map(t => ({ rMultiple: t.rMultiple, grade: t.grade, errorTags: t.errorTags, marketCondition: t.marketCondition })) }; const prompt = this.getAiPrompts('monthly'); const review = await this.callAiApi(prompt.system, prompt.user(input), false, true); try { const parsed = JSON.parse(review.match(/\{[\s\S]*\}/)[0]); this.reviewNotes.monthly = parsed.monthlyPerformance; this.reviewNotes.improve = parsed.areasToImprove; this.reviewNotes.goals = parsed.nextMonthGoals; } catch (e) { console.error(e); this.reviewNotes.monthly = "AI 回應格式錯誤。"; } },

        async callAiApi(systemPrompt, userQuery, formatHtml = true, isJsonOutput = false) {
          this.isLoading = true; let resultText = '';
          try {
            if (this.settings.aiProvider === 'custom' && this.settings.customApiKey) { resultText = await this.callCustomApi(systemPrompt, userQuery, isJsonOutput); } else { resultText = await this.callGeminiApi(systemPrompt, userQuery, isJsonOutput); }
          } catch (error) { console.error('AI API Call failed:', error); resultText = `與 AI API 通訊時發生錯誤: ${error.message}`; formatHtml = true; } finally {
            this.isLoading = false;
            if (formatHtml && !isJsonOutput) return resultText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            return resultText;
          }
        },
        async callGeminiApi(systemPrompt, userQuery, isJsonOutput) {
          const apiKey = ''; // 請填入你的 Gemini API Key
          if (!apiKey) return '錯誤：Gemini API 金鑰未設定。';
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
          const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
          if (isJsonOutput) payload.generationConfig = { responseMimeType: 'application/json' };
          const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (!res.ok) throw new Error(`Gemini API 錯誤 ${res.status}`);
          const json = await res.json(); return json.candidates?.[0]?.content?.parts?.[0]?.text || '無回應內容';
        },
        async callCustomApi(systemPrompt, userQuery, isJsonOutput) {
          const apiUrl = this.settings.customApiUrl || 'https://api.openai.com/v1/chat/completions';
          const payload = { model: 'gpt-3.5-turbo', messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userQuery }] };
          if (isJsonOutput) payload.response_format = { type: 'json_object' };
          const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.settings.customApiKey}` }, body: JSON.stringify(payload) });
          if (!res.ok) throw new Error(`Custom API 錯誤 ${res.status}`);
          const json = await res.json(); return json.choices?.[0]?.message?.content || '無回應內容';
        },

        /* ---------- 工具函式 ---------- */
        formatCurrency(value, currency = 'USD') { if (typeof value !== 'number' || isNaN(value)) return '0.00'; return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 2 }).format(value).replace(currency, '').trim(); },
        handleImageUpload(event, targetForm) { const file = event.target.files[0]; if (!file) return; if (file.size > 1024 * 1024) return alert("圖片需小於 1MB"); const reader = new FileReader(); reader.onload = (e) => { targetForm.chartImage = e.target.result; }; reader.readAsDataURL(file); },
        clearAllData() { this.trades = []; this.marketJournals = []; this.buyPlans = []; this.modelBooks = []; this.reflections = []; this.marketCompassLog = []; this.selectedTradeId = null; this.selectedTrade = null; },
        openChartModal(url) { if (url) { this.modalImageUrl = url; this.isModalOpen = true; } },
        closeChartModal() { this.isModalOpen = false; this.modalImageUrl = ''; },
        resetAllForms() { this.resetForm(); this.resetMarketJournalForm(); this.resetBuyPlanForm(); this.resetModelBookForm(); this.resetReflectionForm(); },
        getBlankMarketJournalForm() { return { date: new Date().toISOString().split('T')[0], marketSummary: '', leadingSectors: '', watchlist: '', mindset: '', sentiment: 3, summary: '' }; },
        getBlankBuyPlanForm() { return { name: '', ticker: '', sector: '', pattern: '', pivot: null, stopLoss: null, target: null, rationale: '', chartImage: '' }; },
        getBlankModelBookForm() { return { name: '', ticker: '', market: '', year: new Date().getFullYear(), sector: '', pattern: '', performance: '', pivot: '', takeaways: '', chartImage: '' }; },
        getBlankReflectionForm() { return { date: new Date().toISOString().split('T')[0], problem: '', thoughts: '' }; },
        resetMarketJournalForm() { this.editingMarketJournalId = null; this.marketJournalForm = this.getBlankMarketJournalForm(); },
        resetBuyPlanForm() { this.editingBuyPlanId = null; this.buyPlanForm = this.getBlankBuyPlanForm(); },
        resetModelBookForm() { this.editingModelBookId = null; this.modelBookForm = this.getBlankModelBookForm(); },
        resetReflectionForm() { this.editingReflectionId = null; this.reflectionForm = this.getBlankReflectionForm(); },
        async saveMarketJournal() { await this.saveEntity('marketJournals', this.editingMarketJournalId, this.marketJournalForm); this.resetMarketJournalForm(); },
        async saveBuyPlan() { await this.saveEntity('buyPlans', this.editingBuyPlanId, this.buyPlanForm); this.resetBuyPlanForm(); },
        async saveModelBook() { await this.saveEntity('modelBooks', this.editingModelBookId, this.modelBookForm); this.resetModelBookForm(); },
        async saveReflection() { await this.saveEntity('reflections', this.editingReflectionId, this.reflectionForm); this.resetReflectionForm(); },
        async deleteMarketJournal(id) { await this.deleteEntity('marketJournals', id); },
        async deleteBuyPlan(id) { await this.deleteEntity('buyPlans', id); },
        async deleteModelBook(id) { await this.deleteEntity('modelBooks', id); },
        async deleteReflection(id) { await this.deleteEntity('reflections', id); },
        editMarketJournal(entry) { this.editingMarketJournalId = entry.id; this.marketJournalForm = { ...this.getBlankMarketJournalForm(), ...entry }; this.activeTab = 'marketJournal'; },
        editBuyPlan(plan) { this.editingBuyPlanId = plan.id; this.buyPlanForm = { ...this.getBlankBuyPlanForm(), ...plan }; this.activeTab = 'buyPlan'; },
        editModelBook(model) { this.editingModelBookId = model.id; this.modelBookForm = { ...this.getBlankModelBookForm(), ...model }; this.activeTab = 'modelBook'; },
        editReflection(entry) { this.editingReflectionId = entry.id; this.reflectionForm = { ...this.getBlankReflectionForm(), ...entry }; this.activeTab = 'reflection'; },
        async setMarketCompass(market, sentiment) { await this.saveEntity('marketCompassLog', null, { market, sentiment }); },
        async saveEntity(collectionName, entityId, formData) {
          if (!this.userId) return alert("用戶未登入，無法儲存。");
          try {
            const data = { ...formData }; const collectionRef = collection(this.db, `users/${this.userId}/${collectionName}`);
            if (entityId) { if (collectionName === 'marketCompassLog') await updateDoc(doc(collectionRef, entityId), { sentiment: data.sentiment }); else await setDoc(doc(collectionRef, entityId), data, { merge: true }); } else {
              data.createdAt = serverTimestamp(); if (collectionName === 'marketCompassLog') data.timestamp = serverTimestamp(); await addDoc(collectionRef, data);
            }
          } catch(e) { console.error("Error saving entity:", e); alert("儲存失敗！"); throw e; }
        },
        async deleteEntity(collectionName, entityId) { if (confirm("確定要刪除嗎？")) await deleteDoc(doc(this.db, `users/${this.userId}/${collectionName}`, entityId)); },

        /* ---------- 搜尋 ---------- */
        search() {
          if (!this.searchTerm) return this.searchResults = [];
          const term = this.searchTerm.toLowerCase();
          const tradeResults = this.trades.filter(t => t.ticker.toLowerCase().includes(term) || (t.setup && t.setup.toLowerCase().includes(term))).map(t => ({...t, type: '交易日誌', date: t.entryDate}));
          const modelResults = this.modelBooks.filter(m => m.name.toLowerCase().includes(term) || m.ticker.toLowerCase().includes(term) || m.pattern.toLowerCase().includes(term)).map(m => ({...m, type: '模型庫'}));
          this.searchResults = [...tradeResults, ...modelResults].slice(0, 10);
        },
        goToSearchResult(item) {
          if (item.type === '交易日誌') { this.activeTab = 'journal'; this.selectTrade(item); } else if (item.type === '模型庫') { this.editModelBook(item); }
          this.searchTerm = ''; this.searchResults = [];
        },

        /* ---------- 日曆 ---------- */
        generateCalendar() {
          const year = this.calendar.year; const month = this.calendar.month; const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const daysInMonth = lastDay.getDate(); const startDayOfWeek = firstDay.getDay();
          const days = []; for (let i = startDayOfWeek; i > 0; i--) { const date = new Date(year, month, 1 - i); days.push({ date: date.toISOString().split('T')[0], dayOfMonth: date.getDate(), isCurrentMonth: false, pl: 0, tradeCount: 0 }); }
          for (let i = 1; i <= daysInMonth; i++) { const date = new Date(year, month, i); days.push({ date: date.toISOString().split('T')[0], dayOfMonth: i, isCurrentMonth: true, isToday: date.toDateString() === new Date().toDateString(), pl: 0, tradeCount: 0 }); }
          const remainingCells = 42 - days.length; for (let i = 1; i <= remainingCells; i++) { const date = new Date(year, month + 1, i); days.push({ date: date.toISOString().split('T')[0], dayOfMonth: i, isCurrentMonth: false, pl: 0, tradeCount: 0 }); }
          this.trades.forEach(trade => {
            (trade.transactions || []).forEach(txn => {
              const day = days.find(d => d.date === txn.date);
              if (day && txn.type === 'Sell') {
                const details = this.getTradeDetails(trade); const avgBuyPrice = (details.totalBuyQty > 0) ? details.totalBuyCost / details.totalBuyQty : 0;
                const plForThisTxn = (trade.direction === 'Long') ? (txn.price - avgBuyPrice) * txn.quantity : (avgBuyPrice - txn.price) * txn.quantity;
                day.pl += plForThisTxn; day.tradeCount += 1;
              }
            });
          });
          this.calendar.days = days;
        },
        changeMonth(delta) {
          let newMonth = this.calendar.month + delta; let newYear = this.calendar.year;
          if (newMonth > 11) { newMonth = 0; newYear++; } if (newMonth < 0) { newMonth = 11; newYear--; }
          this.calendar.month = newMonth; this.calendar.year = newYear;
        },

        /* ---------- 圖表 ---------- */
        renderChart(canvasId) {
          const canvas = document.getElementById(canvasId); if (!canvas) return; const ctx = canvas.getContext('2d');
          const closed = this.trades.map(t => ({ ...t, details: this.getTradeDetails(t) })).filter(t => t.details.status === 'Closed').sort((a, b) => new Date(a.entryDate) - new Date(b.entryDate));
          if (this[canvasId]) this[canvasId].destroy();
          if (closed.length === 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#6b7280'; ctx.textAlign = 'center'; ctx.font = '16px "Inter", "Noto Sans TC"'; ctx.fillText('暫無已平倉交易數據', canvas.width / 2, canvas.height / 2); return;
          }
          let cumulative = 0; const dataPoints = closed.map(t => cumulative += t.details.totalPl);
          this[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { labels: closed.map((_, i) => `T${i + 1}`), datasets: [{ label: '累計盈虧 (USD)', data: dataPoints, borderColor: 'rgba(59, 130, 246, 0.8)', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.1, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } }
          });
        }
      };
    }

    Alpine.data('tradingApp', tradingApp);
    Alpine.start();
  </script>
</body>
</html>
